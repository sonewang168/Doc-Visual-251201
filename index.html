<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0f1a">
    <title>AI 文件視覺摘要生成器 v11</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22AI%E8%A6%96%E8%A6%BA%E6%91%98%E8%A6%81%22%2C%22short_name%22%3A%22%E8%A6%96%E8%A6%BA%E6%91%98%E8%A6%81%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0f1a%22%2C%22theme_color%22%3A%22%2300f5ff%22%7D">
    
    <!-- 外部資源 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700;900&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        /* ============================================
           CSS 變數系統 - 科技風配色
           ============================================ */
        :root {
            /* 深邃背景 */
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --bg-hover: #374151;
            --bg-active: #4b5563;
            --bg-glass: rgba(17, 24, 39, 0.85);
            
            /* 霓虹青色 - 主色調 */
            --neon-cyan: #00f5ff;
            --neon-cyan-dim: #00c4cc;
            --neon-cyan-glow: rgba(0, 245, 255, 0.4);
            --neon-cyan-soft: rgba(0, 245, 255, 0.15);
            
            /* 霓虹紫色 */
            --neon-purple: #bf00ff;
            --neon-purple-dim: #9900cc;
            --neon-purple-glow: rgba(191, 0, 255, 0.4);
            --neon-purple-soft: rgba(191, 0, 255, 0.15);
            
            /* 霓虹粉色 */
            --neon-pink: #ff00aa;
            --neon-pink-glow: rgba(255, 0, 170, 0.4);
            
            /* 霓虹藍色 */
            --neon-blue: #0066ff;
            --neon-blue-glow: rgba(0, 102, 255, 0.4);
            
            /* 霓虹綠色 */
            --neon-green: #00ff88;
            --neon-green-glow: rgba(0, 255, 136, 0.4);
            
            /* 霓虹橙色 */
            --neon-orange: #ff6600;
            --neon-orange-glow: rgba(255, 102, 0, 0.4);
            
            /* 霓虹黃色 */
            --neon-yellow: #ffff00;
            --neon-yellow-glow: rgba(255, 255, 0, 0.3);
            
            /* 文字色 */
            --text-primary: #f0f9ff;
            --text-secondary: #e0f2fe;
            --text-muted: #94a3b8;
            --text-dim: #64748b;
            
            /* 邊框 */
            --border-color: rgba(0, 245, 255, 0.2);
            --border-glow: rgba(0, 245, 255, 0.5);
            
            /* 陰影與光暈 */
            --glow-cyan: 0 0 20px var(--neon-cyan-glow), 0 0 40px var(--neon-cyan-soft);
            --glow-purple: 0 0 20px var(--neon-purple-glow), 0 0 40px var(--neon-purple-soft);
            --glow-text: 0 0 10px currentColor;
            
            /* 圓角 */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* 過渡 */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            /* 響應式尺寸 */
            --sidebar-width: 380px;
            --sidebar-width-tablet: 320px;
            --toolbar-height: 56px;
        }

        /* ============================================
           重置與基礎
           ============================================ */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: 100%;
            font-size: 16px;
        }

        body {
            height: 100%;
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* 科技風選取 */
        ::selection {
            background: var(--neon-cyan);
            color: var(--bg-primary);
        }

        /* 科技風滾動條 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--neon-cyan), var(--neon-purple));
            border-radius: 3px;
        }

        /* ============================================
           酷炫科技風啟動畫面
           ============================================ */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, #0d1525 0%, #050810 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
        }

        .splash-screen.hide {
            animation: splashFadeOut 0.8s ease forwards;
        }

        @keyframes splashFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

        /* 背景網格 */
        .splash-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 245, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 245, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px); }
        }

        /* 粒子效果 */
        .splash-particles {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--neon-cyan);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan);
            animation: particleFloat 8s ease-in-out infinite;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) scale(1); opacity: 0; }
        }

        /* 主LOGO容器 */
        .splash-logo-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 外層旋轉環 */
        .logo-ring-outer {
            position: absolute;
            width: 200px;
            height: 200px;
            border: 3px solid transparent;
            border-top-color: var(--neon-cyan);
            border-right-color: var(--neon-cyan);
            border-radius: 50%;
            animation: ringRotate 3s linear infinite;
            filter: drop-shadow(0 0 10px var(--neon-cyan)) drop-shadow(0 0 20px var(--neon-cyan));
        }

        /* 中層旋轉環 */
        .logo-ring-middle {
            position: absolute;
            width: 170px;
            height: 170px;
            border: 2px solid transparent;
            border-bottom-color: var(--neon-purple);
            border-left-color: var(--neon-purple);
            border-radius: 50%;
            animation: ringRotate 2s linear infinite reverse;
            filter: drop-shadow(0 0 8px var(--neon-purple)) drop-shadow(0 0 16px var(--neon-purple));
        }

        /* 內層旋轉環 */
        .logo-ring-inner {
            position: absolute;
            width: 140px;
            height: 140px;
            border: 2px dashed var(--neon-pink);
            border-radius: 50%;
            animation: ringRotate 4s linear infinite;
            opacity: 0.6;
        }

        @keyframes ringRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 六邊形核心 */
        .logo-hexagon {
            position: relative;
            width: 100px;
            height: 115px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: hexPulse 2s ease-in-out infinite;
        }

        .logo-hexagon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--neon-cyan-soft), var(--neon-purple-soft));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            animation: hexGlow 2s ease-in-out infinite alternate;
        }

        @keyframes hexPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes hexGlow {
            0% { filter: drop-shadow(0 0 15px var(--neon-cyan)); }
            100% { filter: drop-shadow(0 0 25px var(--neon-purple)); }
        }

        .logo-icon {
            font-size: 3rem;
            z-index: 1;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
            animation: iconFloat 3s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* 掃描線效果 */
        .splash-scanline {
            position: absolute;
            width: 250px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
            animation: scanMove 2s ease-in-out infinite;
            filter: blur(1px);
        }

        @keyframes scanMove {
            0% { top: 20%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 80%; opacity: 0; }
        }

        /* 標題 */
        .splash-title {
            margin-top: 40px;
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: 4px;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple), var(--neon-pink));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textGradient 3s linear infinite;
            text-shadow: none;
            filter: drop-shadow(0 0 20px var(--neon-cyan-glow));
        }

        @keyframes textGradient {
            0% { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        .splash-subtitle {
            margin-top: 12px;
            font-size: 0.9rem;
            color: var(--text-muted);
            letter-spacing: 2px;
        }

        /* 載入進度條 */
        .splash-progress {
            margin-top: 50px;
            width: 280px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .splash-progress::before {
            content: '';
            position: absolute;
            height: 100%;
            width: 40%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            border-radius: 2px;
            animation: progressMove 1.5s ease-in-out infinite;
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        @keyframes progressMove {
            0% { left: -40%; }
            100% { left: 100%; }
        }

        .splash-status {
            margin-top: 16px;
            font-family: 'Orbitron', monospace;
            font-size: 0.75rem;
            color: var(--neon-cyan);
            letter-spacing: 3px;
            animation: statusBlink 1s step-end infinite;
        }

        @keyframes statusBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        /* 角落裝飾 */
        .splash-corner {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid var(--neon-cyan);
            opacity: 0.3;
        }

        .splash-corner.tl { top: 30px; left: 30px; border-right: none; border-bottom: none; }
        .splash-corner.tr { top: 30px; right: 30px; border-left: none; border-bottom: none; }
        .splash-corner.bl { bottom: 30px; left: 30px; border-right: none; border-top: none; }
        .splash-corner.br { bottom: 30px; right: 30px; border-left: none; border-top: none; }
        /* ============================================
           應用程式容器
           ============================================ */
        .app-container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        /* ============================================
           側邊欄 - 科技風
           ============================================ */
        .sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
            transition: transform 0.3s ease, width 0.3s ease;
        }

        /* 側邊欄裝飾線 */
        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, 
                transparent 0%, 
                var(--neon-cyan) 20%, 
                var(--neon-purple) 50%, 
                var(--neon-cyan) 80%, 
                transparent 100%);
            opacity: 0.5;
        }

        /* 側邊欄頭部 */
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, 
                rgba(0, 245, 255, 0.1) 0%, 
                rgba(191, 0, 255, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(0, 245, 255, 0.1) 60deg,
                transparent 120deg
            );
            animation: headerSweep 8s linear infinite;
        }

        @keyframes headerSweep {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .logo-icon-small {
            font-size: 1.8rem;
            filter: drop-shadow(0 0 8px var(--neon-cyan));
        }

        .logo-text {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 1px;
        }

        .version-badge {
            padding: 3px 10px;
            background: var(--neon-cyan-soft);
            border: 1px solid var(--neon-cyan);
            border-radius: 20px;
            font-family: 'Orbitron', monospace;
            font-size: 0.65rem;
            color: var(--neon-cyan);
            margin-left: auto;
        }

        .app-subtitle {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
            position: relative;
            z-index: 1;
        }

        /* 側邊欄內容 */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* ============================================
           區塊樣式
           ============================================ */
        .section {
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(0, 245, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            position: relative;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20px;
            right: 20px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
            opacity: 0.5;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .section-icon {
            width: 36px;
            height: 36px;
            background: var(--neon-cyan-soft);
            border: 1px solid var(--neon-cyan);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 0 15px var(--neon-cyan-glow);
        }

        .section-icon.purple {
            background: var(--neon-purple-soft);
            border-color: var(--neon-purple);
            box-shadow: 0 0 15px var(--neon-purple-glow);
        }

        .section-icon.green {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--neon-green);
            box-shadow: 0 0 15px var(--neon-green-glow);
        }

        .section-icon.orange {
            background: rgba(255, 102, 0, 0.1);
            border-color: var(--neon-orange);
            box-shadow: 0 0 15px var(--neon-orange-glow);
        }

        .section-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-subtitle {
            font-size: 0.72rem;
            color: var(--text-dim);
        }

        /* ============================================
           輸入元件 - 科技風
           ============================================ */
        .input-group {
            margin-bottom: 14px;
        }

        .input-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all var(--transition-fast);
        }

        .input-field:hover {
            border-color: var(--neon-cyan);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 0 3px var(--neon-cyan-soft), var(--glow-cyan);
        }

        .input-field::placeholder {
            color: var(--text-dim);
        }

        select.input-field {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2300f5ff'%3E%3Cpath d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
            -webkit-appearance: none;
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }

        .input-with-btn {
            display: flex;
            gap: 8px;
        }

        .input-with-btn .input-field {
            flex: 1;
        }

        .input-inline-btn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--neon-green), #00cc6a);
            border: none;
            border-radius: var(--radius-md);
            color: var(--bg-primary);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            box-shadow: 0 0 15px var(--neon-green-glow);
        }

        .input-inline-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--neon-green-glow);
        }

        /* API 狀態 */
        .api-status {
            display: none;
            padding: 10px 14px;
            margin-top: 10px;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            align-items: center;
            gap: 10px;
        }

        .api-status.show { display: flex; }

        .api-status.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
        }

        .api-status.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff6666;
        }

        .api-status.loading {
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid #ffaa00;
            color: #ffcc00;
        }

        .api-status.info {
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .help-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            font-size: 0.75rem;
            color: var(--neon-cyan);
            text-decoration: none;
            transition: all var(--transition-fast);
        }

        .help-link:hover {
            color: var(--neon-purple);
            text-shadow: var(--glow-text);
        }

        /* ============================================
           上傳區域
           ============================================ */
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, var(--neon-cyan-soft), var(--neon-purple-soft));
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .upload-zone:hover {
            border-color: var(--neon-cyan);
            box-shadow: var(--glow-cyan);
        }

        .upload-zone:hover::before {
            opacity: 0.5;
        }

        .upload-zone.dragover {
            border-color: var(--neon-purple);
            box-shadow: var(--glow-purple);
            transform: scale(1.02);
        }

        .upload-zone.has-file {
            border-color: var(--neon-green);
            border-style: solid;
            box-shadow: 0 0 20px var(--neon-green-glow);
        }

        .upload-content {
            position: relative;
            z-index: 1;
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .upload-text strong {
            color: var(--neon-cyan);
        }

        .upload-formats {
            margin-top: 6px;
            font-size: 0.72rem;
            color: var(--text-dim);
        }

        /* 檔案資訊 */
        .file-info {
            display: none;
            margin-top: 14px;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--neon-green);
            border-radius: var(--radius-md);
            align-items: center;
            gap: 12px;
        }

        .file-info.show { display: flex; }

        .file-icon {
            width: 44px;
            height: 44px;
            background: var(--neon-cyan-soft);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }

        .file-details { flex: 1; min-width: 0; }

        .file-name {
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-meta {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            font-size: 0.72rem;
            color: var(--text-dim);
        }

        .file-size { color: var(--neon-cyan); }

        .file-remove {
            width: 32px;
            height: 32px;
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            border-radius: 50%;
            color: #ff6666;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .file-remove:hover {
            background: #ff4444;
            color: white;
        }
        /* ============================================
           格式選擇 - 霓虹風格
           ============================================ */
        .format-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .format-option {
            position: relative;
            padding: 16px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-normal);
            overflow: hidden;
        }

        .format-option::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--neon-cyan-soft), var(--neon-purple-soft));
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .format-option:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .format-option:hover::before {
            opacity: 0.5;
        }

        .format-option.active {
            border-color: var(--neon-cyan);
            box-shadow: var(--glow-cyan);
        }

        .format-option.active::before {
            opacity: 0.8;
        }

        .format-option input {
            position: absolute;
            opacity: 0;
        }

        .format-content {
            position: relative;
            z-index: 1;
        }

        .format-icon {
            font-size: 1.8rem;
            margin-bottom: 6px;
        }

        .format-name {
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .format-desc {
            font-size: 0.68rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .format-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: var(--neon-cyan);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--bg-primary);
            font-weight: bold;
            opacity: 0;
            transform: scale(0.5);
            transition: all var(--transition-fast);
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        .format-option.active .format-check {
            opacity: 1;
            transform: scale(1);
        }

        /* ============================================
           進階設定
           ============================================ */
        .advanced-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-bottom: 12px;
            transition: all var(--transition-fast);
        }

        .advanced-toggle:hover {
            border-color: var(--neon-cyan);
        }

        .advanced-toggle-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .advanced-toggle-icon {
            font-size: 0.9rem;
            color: var(--neon-cyan);
            transition: transform var(--transition-normal);
        }

        .advanced-toggle.open .advanced-toggle-icon {
            transform: rotate(180deg);
        }

        .advanced-content {
            display: none;
            padding: 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
        }

        .advanced-content.show { display: block; }

        /* ============================================
           生成按鈕 - 霓虹風格
           ============================================ */
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: linear-gradient(180deg, transparent, var(--bg-secondary));
        }

        .generate-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border: none;
            border-radius: var(--radius-lg);
            color: var(--bg-primary);
            font-size: 1.05rem;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px var(--neon-cyan-glow);
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 0 50px var(--neon-cyan-glow), 0 10px 40px rgba(0,0,0,0.3);
        }

        .generate-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-btn .spinner {
            display: none;
            width: 22px;
            height: 22px;
            border: 3px solid rgba(0,0,0,0.2);
            border-top-color: var(--bg-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .generate-btn.loading .spinner { display: block; }
        .generate-btn.loading .btn-text,
        .generate-btn.loading .btn-icon { display: none; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .generate-hint {
            text-align: center;
            margin-top: 10px;
            font-size: 0.72rem;
            color: var(--text-dim);
        }

        /* ============================================
           主要內容區
           ============================================ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: radial-gradient(ellipse at top, #0d1525 0%, var(--bg-primary) 70%);
            position: relative;
        }

        /* ============================================
           工具列 - 科技風
           ============================================ */
        .toolbar {
            height: var(--toolbar-height);
            padding: 0 16px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
            overflow-x: auto;
            position: relative;
        }

        .toolbar::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--neon-cyan), var(--neon-purple), transparent);
            opacity: 0.5;
        }

        .toolbar-group {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .toolbar-divider {
            width: 1px;
            height: 28px;
            background: var(--border-color);
            margin: 0 8px;
        }

        .tool-btn {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-size: 0.78rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .tool-btn:hover {
            background: var(--neon-cyan-soft);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .tool-btn.active {
            background: var(--neon-cyan);
            border-color: var(--neon-cyan);
            color: var(--bg-primary);
            box-shadow: 0 0 15px var(--neon-cyan-glow);
        }

        .tool-btn.purple:hover {
            background: var(--neon-purple-soft);
            border-color: var(--neon-purple);
            color: var(--neon-purple);
        }

        .tool-btn.purple.active {
            background: var(--neon-purple);
            color: var(--bg-primary);
            box-shadow: 0 0 15px var(--neon-purple-glow);
        }

        .tool-btn-icon {
            font-size: 1rem;
        }

        .toolbar-spacer { flex: 1; }

        .toolbar-info {
            font-size: 0.72rem;
            color: var(--text-dim);
            padding: 6px 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            white-space: nowrap;
        }

        /* ============================================
           輸出區域
           ============================================ */
        .output-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* 佔位符 */
        .output-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            max-width: 450px;
            padding: 40px;
        }

        .placeholder-icon {
            font-size: 5rem;
            opacity: 0.15;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 20px var(--neon-cyan));
        }

        .placeholder-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.3rem;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        .placeholder-text {
            font-size: 0.9rem;
            color: var(--text-dim);
            opacity: 0.7;
        }

        .placeholder-steps {
            margin-top: 30px;
            text-align: left;
        }

        .placeholder-step {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 0;
            font-size: 0.85rem;
            color: var(--text-dim);
            opacity: 0.6;
            border-bottom: 1px solid var(--border-color);
        }

        .placeholder-step:last-child { border-bottom: none; }

        .placeholder-step-num {
            width: 28px;
            height: 28px;
            background: var(--neon-cyan-soft);
            border: 1px solid var(--neon-cyan);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-size: 0.75rem;
            color: var(--neon-cyan);
        }

        /* SVG 容器 */
        #svgContainer {
            width: 100%;
            height: 100%;
            display: none;
        }

        #svgContainer.show { display: block; }

        /* 結果容器 */
        .result-container {
            position: absolute;
            inset: 0;
            overflow: auto;
            display: none;
        }

        .result-container.show { display: block; }
        /* ============================================
           心智圖節點樣式
           ============================================ */
        .mm-node {
            cursor: pointer;
        }

        .mm-node:hover rect {
            filter: brightness(1.2);
        }

        .mm-node.selected rect {
            stroke: var(--neon-cyan) !important;
            stroke-width: 3px !important;
            filter: drop-shadow(0 0 15px var(--neon-cyan));
        }

        .mm-link {
            fill: none;
            stroke-linecap: round;
        }

        .node-badge {
            cursor: pointer;
        }

        /* ============================================
           心智圖簡報模式 - 增強版（30種動畫）
           ============================================ */
        .presentation-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, #0d1525 0%, #050810 100%);
            z-index: 8000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .presentation-overlay.show {
            display: flex;
        }

        /* 背景粒子效果 */
        .presentation-bg {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .presentation-bg .bg-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--neon-cyan);
            border-radius: 50%;
            opacity: 0.3;
            animation: bgFloat 15s infinite ease-in-out;
        }

        @keyframes bgFloat {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.1; }
            50% { transform: translateY(-100px) translateX(50px); opacity: 0.5; }
        }

        .presentation-header {
            height: 60px;
            padding: 0 20px;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 10;
        }

        .presentation-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .presentation-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            color: var(--neon-cyan);
        }

        .presentation-anim-name {
            font-size: 0.75rem;
            color: var(--neon-purple);
            padding: 4px 10px;
            background: var(--neon-purple-soft);
            border-radius: 20px;
        }

        .presentation-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .presentation-counter {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .presentation-btn {
            width: 44px;
            height: 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .presentation-btn:hover {
            background: var(--neon-cyan-soft);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .presentation-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .presentation-close {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
            color: #ff6666;
        }

        .presentation-close:hover {
            background: #ff4444;
            color: white;
        }

        .presentation-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: hidden;
            position: relative;
        }

        /* 投影片容器 */
        .presentation-slide {
            max-width: 95%;
            max-height: 95%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* 標題區 */
        .slide-title-area {
            margin-bottom: 20px;
        }

        .slide-subtitle {
            font-size: 1rem;
            color: var(--neon-purple);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .slide-main-title {
            font-family: 'Orbitron', monospace;
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple), var(--neon-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            filter: drop-shadow(0 0 30px var(--neon-cyan-glow));
        }

        .slide-note {
            font-size: 1.1rem;
            color: var(--text-muted);
            max-width: 700px;
            line-height: 1.6;
        }

        /* 主要節點卡片 */
        .slide-node {
            padding: 50px 80px;
            background: linear-gradient(135deg, var(--neon-cyan-soft), var(--neon-purple-soft));
            border: 2px solid var(--neon-cyan);
            border-radius: var(--radius-xl);
            box-shadow: 0 0 50px var(--neon-cyan-glow);
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }

        .slide-node::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(0, 245, 255, 0.1), transparent);
            animation: nodeRotate 8s linear infinite;
        }

        @keyframes nodeRotate {
            to { transform: rotate(360deg); }
        }

        .slide-node-text {
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
            text-shadow: 0 0 30px rgba(0, 245, 255, 0.5);
        }

        /* 子節點區 */
        .slide-children {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            max-width: 1100px;
            margin-top: 10px;
        }

        .slide-child {
            padding: 18px 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 1.15rem;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .slide-child:hover {
            border-color: var(--neon-cyan);
            background: var(--neon-cyan-soft);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* 頁尾資訊 */
        .slide-footer {
            margin-top: 30px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .slide-depth-indicator {
            display: inline-flex;
            gap: 6px;
        }

        .depth-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--bg-tertiary);
        }

        .depth-dot.active {
            background: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        /* 進度條 */
        .presentation-progress {
            height: 4px;
            background: var(--bg-tertiary);
            position: relative;
            z-index: 10;
        }

        .presentation-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            transition: width 0.3s ease;
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        /* ============================================
           30 種動畫效果定義
           ============================================ */
        /* 1. 淡入 */
        @keyframes anim-fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* 2. 從左滑入 */
        @keyframes anim-slideLeft { from { opacity: 0; transform: translateX(-100px); } to { opacity: 1; transform: translateX(0); } }
        /* 3. 從右滑入 */
        @keyframes anim-slideRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        /* 4. 從上滑入 */
        @keyframes anim-slideDown { from { opacity: 0; transform: translateY(-100px); } to { opacity: 1; transform: translateY(0); } }
        /* 5. 從下滑入 */
        @keyframes anim-slideUp { from { opacity: 0; transform: translateY(100px); } to { opacity: 1; transform: translateY(0); } }
        /* 6. 縮放彈入 */
        @keyframes anim-zoomIn { from { opacity: 0; transform: scale(0.3); } to { opacity: 1; transform: scale(1); } }
        /* 7. 縮放彈出 */
        @keyframes anim-zoomOut { from { opacity: 0; transform: scale(1.5); } to { opacity: 1; transform: scale(1); } }
        /* 8. 翻轉X */
        @keyframes anim-flipX { from { opacity: 0; transform: perspective(400px) rotateX(90deg); } to { opacity: 1; transform: perspective(400px) rotateX(0); } }
        /* 9. 翻轉Y */
        @keyframes anim-flipY { from { opacity: 0; transform: perspective(400px) rotateY(90deg); } to { opacity: 1; transform: perspective(400px) rotateY(0); } }
        /* 10. 旋轉入 */
        @keyframes anim-rotateIn { from { opacity: 0; transform: rotate(-180deg) scale(0.5); } to { opacity: 1; transform: rotate(0) scale(1); } }
        /* 11. 彈跳 */
        @keyframes anim-bounce { 0% { opacity: 0; transform: translateY(-50px); } 60% { opacity: 1; transform: translateY(15px); } 80% { opacity: 1; transform: translateY(-8px); } 100% { opacity: 1; transform: translateY(0); } }
        /* 12. 橡皮筋 */
        @keyframes anim-elastic { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.15); } 70% { opacity: 1; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        /* 13. 搖擺 */
        @keyframes anim-swing { 0% { opacity: 0; transform: rotate(-10deg); } 30% { opacity: 1; transform: rotate(8deg); } 60% { opacity: 1; transform: rotate(-5deg); } 80% { opacity: 1; transform: rotate(3deg); } 100% { opacity: 1; transform: rotate(0); } }
        /* 14. 脈動 */
        @keyframes anim-pulse { 0% { opacity: 0; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        /* 15. 閃光 */
        @keyframes anim-flash { 0% { opacity: 0; } 20%, 50%, 100% { opacity: 1; } 35%, 75% { opacity: 0.5; } }
        /* 16. 抖動 */
        @keyframes anim-shake { 0% { transform: translateX(0); opacity: 0; } 10% { opacity: 1; } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); opacity: 1; } 20%, 40%, 60%, 80% { transform: translateX(8px); opacity: 1; } 100% { transform: translateX(0); opacity: 1; } }
        /* 17. 摩天輪 */
        @keyframes anim-ferris { from { opacity: 0; transform: rotate(360deg) translateY(-50px); } to { opacity: 1; transform: rotate(0) translateY(0); } }
        /* 18. 光束 */
        @keyframes anim-lightSpeed { from { opacity: 0; transform: translateX(100%) skewX(-30deg); } to { opacity: 1; transform: translateX(0) skewX(0); } }
        /* 19. 果凍 */
        @keyframes anim-jello { 0% { transform: scale(1); opacity: 0; } 30% { transform: scale(1.25, 0.75); opacity: 1; } 40% { transform: scale(0.75, 1.25); opacity: 1; } 50% { transform: scale(1.15, 0.85); opacity: 1; } 65% { transform: scale(0.95, 1.05); opacity: 1; } 75% { transform: scale(1.05, 0.95); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        /* 20. 心跳 */
        @keyframes anim-heartbeat { 0% { transform: scale(0.8); opacity: 0; } 14% { transform: scale(1.1); opacity: 1; } 28% { transform: scale(0.9); opacity: 1; } 42% { transform: scale(1.05); opacity: 1; } 70% { transform: scale(0.95); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        /* 21. 打字機 */
        @keyframes anim-typewriter { from { width: 0; opacity: 0; } to { width: 100%; opacity: 1; } }
        /* 22. 波浪 */
        @keyframes anim-wave { 0% { transform: translateY(30px) rotate(-5deg); opacity: 0; } 50% { transform: translateY(-10px) rotate(3deg); opacity: 1; } 100% { transform: translateY(0) rotate(0); opacity: 1; } }
        /* 23. 螺旋 */
        @keyframes anim-spiral { from { opacity: 0; transform: rotate(720deg) scale(0); } to { opacity: 1; transform: rotate(0) scale(1); } }
        /* 24. 3D翻頁 */
        @keyframes anim-page { from { opacity: 0; transform: perspective(1000px) rotateY(-90deg); transform-origin: left; } to { opacity: 1; transform: perspective(1000px) rotateY(0); } }
        /* 25. 霓虹閃爍 */
        @keyframes anim-neon { 0% { opacity: 0; filter: drop-shadow(0 0 5px var(--neon-cyan)); } 30%, 100% { opacity: 1; filter: drop-shadow(0 0 5px var(--neon-cyan)); } 50% { opacity: 1; filter: drop-shadow(0 0 30px var(--neon-cyan)) drop-shadow(0 0 60px var(--neon-purple)); } }
        /* 26. 爆炸 */
        @keyframes anim-explode { 0% { opacity: 0; transform: scale(3); filter: blur(10px); } 100% { opacity: 1; transform: scale(1); filter: blur(0); } }
        /* 27. 漩渦 */
        @keyframes anim-vortex { from { opacity: 0; transform: rotate(-540deg) scale(0) translateY(-100px); } to { opacity: 1; transform: rotate(0) scale(1) translateY(0); } }
        /* 28. 折疊 */
        @keyframes anim-fold { from { opacity: 0; transform: perspective(500px) rotateX(-90deg); transform-origin: top; } to { opacity: 1; transform: perspective(500px) rotateX(0); } }
        /* 29. 滑動疊加 */
        @keyframes anim-stack { from { opacity: 0; transform: translateY(50px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        /* 30. 粒子聚合 */
        @keyframes anim-particle { 0% { opacity: 0; transform: scale(0.5); filter: blur(20px); } 50% { opacity: 1; filter: blur(5px); } 100% { opacity: 1; transform: scale(1); filter: blur(0); } }
            gap: 16px;
            justify-content: center;
            max-width: 1000px;
        }

        .slide-child {
            padding: 16px 28px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            font-size: 1.1rem;
            color: var(--text-secondary);
            animation: childFadeIn 0.5s ease backwards;
        }

        .slide-child:nth-child(1) { animation-delay: 0.1s; }
        .slide-child:nth-child(2) { animation-delay: 0.2s; }
        .slide-child:nth-child(3) { animation-delay: 0.3s; }
        .slide-child:nth-child(4) { animation-delay: 0.4s; }
        .slide-child:nth-child(5) { animation-delay: 0.5s; }
        .slide-child:nth-child(6) { animation-delay: 0.6s; }
        .slide-child:nth-child(7) { animation-delay: 0.7s; }
        .slide-child:nth-child(8) { animation-delay: 0.8s; }

        @keyframes childFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .presentation-progress {
            height: 4px;
            background: var(--bg-tertiary);
        }

        .presentation-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            transition: width 0.3s ease;
        }

        /* ============================================
           流程圖容器 - 可拖曳
           ============================================ */
        .flowchart-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            cursor: grab;
        }

        .flowchart-wrapper:active {
            cursor: grabbing;
        }

        .flowchart-inner {
            position: absolute;
            transform-origin: 0 0;
            transition: none;
            padding: 50px;
            min-width: 100%;
            min-height: 100%;
        }

        .flowchart-inner.animating {
            transition: transform 0.3s ease;
        }

        .flowchart-inner .mermaid {
            font-size: 16px !important;
        }

        .flowchart-inner svg {
            max-width: none !important;
        }

        .flowchart-inner .nodeLabel {
            font-size: 16px !important;
            font-family: 'Noto Sans TC', sans-serif !important;
        }

        .flowchart-error {
            padding: 50px;
            max-width: 800px;
            margin: 0 auto;
        }

        .flowchart-error h3 {
            color: var(--neon-orange);
            font-size: 1.2rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flowchart-error pre {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: var(--radius-md);
            overflow: auto;
            font-size: 0.85rem;
            color: var(--neon-green);
            border: 1px solid var(--border-color);
        }

        /* ============================================
           資訊圖表 - 9宮格模式
           ============================================ */
        .infographic-wrapper {
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100%;
        }

        .infographic-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 1200px;
            width: 100%;
        }

        .info-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-normal);
            animation: cardFadeIn 0.5s ease backwards;
        }

        .info-card:nth-child(1) { animation-delay: 0.05s; }
        .info-card:nth-child(2) { animation-delay: 0.1s; }
        .info-card:nth-child(3) { animation-delay: 0.15s; }
        .info-card:nth-child(4) { animation-delay: 0.2s; }
        .info-card:nth-child(5) { animation-delay: 0.25s; }
        .info-card:nth-child(6) { animation-delay: 0.3s; }
        .info-card:nth-child(7) { animation-delay: 0.35s; }
        .info-card:nth-child(8) { animation-delay: 0.4s; }
        .info-card:nth-child(9) { animation-delay: 0.45s; }

        @keyframes cardFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .info-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-cyan);
            box-shadow: var(--glow-cyan);
        }

        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
        }

        /* 中央標題卡片 */
        .info-card.title-card {
            grid-column: 2;
            grid-row: 1;
            background: linear-gradient(135deg, var(--neon-cyan-soft), var(--neon-purple-soft));
            border-color: var(--neon-cyan);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .info-card.title-card::before {
            display: none;
        }

        .title-card-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            filter: drop-shadow(0 0 15px var(--neon-cyan));
        }

        .title-card-text {
            font-family: 'Orbitron', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 0 20px var(--neon-cyan-glow);
        }

        .info-card-num {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--bg-primary);
        }

        .info-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--neon-cyan);
            margin-bottom: 12px;
            padding-right: 40px;
        }

        .info-card-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .infographic-error {
            padding: 50px;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }
        /* ============================================
           重點摘要 - 增強版（含文字講解）
           ============================================ */
        .summary-wrapper {
            padding: 50px 40px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .summary-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .summary-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 2px;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
        }

        .summary-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            filter: drop-shadow(0 0 15px var(--neon-cyan));
        }

        .summary-title {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            text-shadow: 0 0 30px var(--neon-cyan-glow);
        }

        .summary-subtitle {
            font-size: 1.1rem;
            color: var(--neon-cyan);
        }

        /* 主文區 */
        .summary-main-text {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--neon-cyan);
            border-radius: var(--radius-lg);
            padding: 28px;
            margin-bottom: 30px;
            position: relative;
        }

        .summary-main-text::before {
            content: '"';
            position: absolute;
            top: -5px;
            left: 20px;
            font-size: 4rem;
            color: var(--neon-cyan);
            opacity: 0.2;
            font-family: Georgia, serif;
        }

        .summary-main-text p {
            font-size: 1.05rem;
            line-height: 2;
            color: var(--text-secondary);
            position: relative;
            z-index: 1;
        }

        /* 重點區塊 - 增強版 */
        .summary-points {
            margin-bottom: 30px;
        }

        .summary-points-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--neon-purple);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .summary-points-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--neon-purple), transparent);
        }

        /* 重點項目 - 可展開講解 */
        .point-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .point-item:hover {
            border-color: var(--neon-cyan);
        }

        .point-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 20px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .point-header:hover {
            background: rgba(0, 245, 255, 0.05);
        }

        .point-number {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--bg-primary);
            flex-shrink: 0;
            box-shadow: 0 0 15px var(--neon-cyan-glow);
        }

        .point-title {
            flex: 1;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .point-toggle {
            width: 28px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: var(--neon-cyan);
            transition: all var(--transition-fast);
        }

        .point-item.expanded .point-toggle {
            transform: rotate(180deg);
            background: var(--neon-cyan-soft);
        }

        /* 文字講解區 */
        .point-detail {
            display: none;
            padding: 0 20px 20px 74px;
            animation: detailSlideDown 0.3s ease;
        }

        .point-item.expanded .point-detail {
            display: block;
        }

        @keyframes detailSlideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .point-detail-content {
            padding: 16px 20px;
            background: var(--bg-primary);
            border-left: 3px solid var(--neon-purple);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text-muted);
        }

        /* 結論區 */
        .summary-conclusion {
            background: linear-gradient(135deg, var(--neon-cyan-soft), var(--neon-purple-soft));
            border: 1px solid var(--neon-cyan);
            border-radius: var(--radius-xl);
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--glow-cyan);
        }

        .summary-conclusion::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(0, 245, 255, 0.1), transparent);
            animation: conclusionRotate 10s linear infinite;
        }

        @keyframes conclusionRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-conclusion-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .summary-conclusion p {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        /* ============================================
           右鍵選單
           ============================================ */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--neon-cyan);
            border-radius: var(--radius-lg);
            padding: 8px;
            z-index: 1000;
            display: none;
            min-width: 180px;
            box-shadow: var(--glow-cyan), 0 10px 40px rgba(0,0,0,0.5);
        }

        .context-menu.show { display: block; }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 14px;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.88rem;
            font-family: inherit;
            text-align: left;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .context-menu-item:hover {
            background: var(--neon-cyan-soft);
            color: var(--neon-cyan);
        }

        .context-menu-item.danger:hover {
            background: rgba(255, 68, 68, 0.2);
            color: #ff6666;
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 6px 0;
        }

        /* ============================================
           Modal
           ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--neon-cyan);
            border-radius: var(--radius-xl);
            padding: 28px;
            min-width: 360px;
            max-width: 90%;
            box-shadow: var(--glow-cyan), 0 20px 60px rgba(0,0,0,0.5);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 24px;
        }

        .modal-icon {
            width: 48px;
            height: 48px;
            background: var(--neon-cyan-soft);
            border: 1px solid var(--neon-cyan);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .modal-subtitle {
            font-size: 0.82rem;
            color: var(--text-dim);
        }

        .modal-body { margin-bottom: 24px; }

        .modal-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 0 3px var(--neon-cyan-soft);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .modal-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .modal-btn-cancel:hover {
            background: var(--bg-hover);
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            color: var(--bg-primary);
        }

        .modal-btn-confirm:hover {
            box-shadow: var(--glow-cyan);
        }

        /* ============================================
           Toast
           ============================================ */
        .toast-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            max-width: 400px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success { border-color: var(--neon-green); }
        .toast.error { border-color: #ff4444; }
        .toast.warning { border-color: var(--neon-orange); }

        .toast-icon { font-size: 1.4rem; }
        .toast-title { font-size: 0.95rem; font-weight: 600; }

        /* ============================================
           Loading
           ============================================ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 26, 0.95);
            backdrop-filter: blur(10px);
            z-index: 5000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
        }

        .loading-overlay.show { display: flex; }

        .loading-spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loading-spinner {
            width: 100%;
            height: 100%;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--neon-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-spinner-inner {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--neon-purple);
            border-radius: 50%;
            animation: spin 0.8s linear infinite reverse;
        }

        .loading-text {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            color: var(--neon-cyan);
        }

        .loading-progress {
            width: 250px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 10px var(--neon-cyan);
        }

        .loading-step {
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        /* ============================================
           響應式設計 - 電腦 (>1024px)
           ============================================ */
        @media (min-width: 1025px) {
            .sidebar {
                width: var(--sidebar-width);
            }
            
            .infographic-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .mobile-toggle { display: none; }
        }

        /* ============================================
           響應式設計 - 平板 (768px - 1024px)
           ============================================ */
        @media (min-width: 768px) and (max-width: 1024px) {
            :root {
                --sidebar-width: var(--sidebar-width-tablet);
            }
            
            .sidebar {
                width: var(--sidebar-width-tablet);
            }
            
            .sidebar-header {
                padding: 16px;
            }
            
            .logo-text {
                font-size: 0.95rem;
            }
            
            .section {
                padding: 14px;
            }
            
            .format-grid {
                gap: 10px;
            }
            
            .format-option {
                padding: 14px 10px;
            }
            
            .format-icon {
                font-size: 1.5rem;
            }
            
            .format-name {
                font-size: 0.82rem;
            }
            
            .format-desc {
                font-size: 0.65rem;
            }
            
            .infographic-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }
            
            .info-card {
                padding: 20px;
            }
            
            .info-card-title {
                font-size: 1rem;
            }
            
            .summary-wrapper {
                padding: 40px 30px;
            }
            
            .summary-title {
                font-size: 1.6rem;
            }
            
            .presentation-slide .slide-node-text {
                font-size: 2rem;
            }
            
            .slide-child {
                padding: 14px 22px;
                font-size: 1rem;
            }
            
            .mobile-toggle { display: none; }
        }

        /* ============================================
           響應式設計 - 手機 (<768px)
           ============================================ */
        @media (max-width: 767px) {
            html {
                font-size: 14px;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            /* 側邊欄改為可滑出面板 */
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                max-width: 100%;
                transform: translateX(-100%);
                z-index: 1000;
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar::after {
                display: none;
            }
            
            /* 手機版頭部 */
            .mobile-header {
                display: flex;
                height: 56px;
                padding: 0 12px;
                background: var(--bg-glass);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border-color);
                align-items: center;
                justify-content: space-between;
                gap: 8px;
            }
            
            .mobile-logo {
                display: flex;
                align-items: center;
                gap: 10px;
                flex: 1;
                justify-content: center;
            }
            
            .mobile-logo-icon {
                font-size: 1.5rem;
            }
            
            .mobile-logo-text {
                font-family: 'Orbitron', monospace;
                font-size: 0.95rem;
                background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
            }
            
            .mobile-toggle {
                width: 44px;
                height: 44px;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                color: var(--neon-cyan);
                font-size: 1.3rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .mobile-toggle:hover {
                background: var(--neon-cyan-soft);
                border-color: var(--neon-cyan);
            }
            
            /* 手機版返回按鈕 */
            .mobile-back-btn {
                padding: 10px 16px;
                background: linear-gradient(135deg, #00f5ff22, #bf00ff22);
                border: 2px solid #00f5ff;
                border-radius: 8px;
                color: #00f5ff;
                font-size: 14px;
                font-weight: 700;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                cursor: pointer;
                white-space: nowrap;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
            }
            
            .mobile-back-btn:active {
                background: #00f5ff;
                color: #0a0f1a;
                transform: scale(0.95);
            }
            
            /* 手機版編輯按鈕 */
            .mobile-edit-btn {
                background: linear-gradient(135deg, #bf00ff33, #ff00aa33) !important;
                border-color: #bf00ff !important;
                color: #ff00aa !important;
                font-weight: 700 !important;
                -webkit-tap-highlight-color: transparent;
            }
            
            .mobile-edit-btn:active {
                background: #bf00ff !important;
                color: white !important;
            }
            
            /* 側邊欄關閉按鈕 */
            .sidebar-close {
                position: absolute;
                top: 16px;
                right: 16px;
                width: 40px;
                height: 40px;
                background: rgba(255, 68, 68, 0.2);
                border: 1px solid #ff4444;
                border-radius: 50%;
                color: #ff6666;
                font-size: 1.2rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
            }
            
            .sidebar-close:hover {
                background: #ff4444;
                color: white;
            }
            
            /* 背景遮罩 */
            .sidebar-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 999;
                display: none;
            }
            
            .sidebar-backdrop.show {
                display: block;
            }
            
            /* 主內容區調整 */
            .main-content {
                height: calc(100% - 56px);
            }
            
            .toolbar {
                height: 50px;
                padding: 0 12px;
                gap: 6px;
                overflow-x: auto;
            }
            
            .tool-btn {
                padding: 6px 10px;
                font-size: 0.72rem;
            }
            
            .tool-btn-icon {
                font-size: 0.9rem;
            }
            
            .toolbar-info {
                display: none;
            }
            
            /* 格式選擇 */
            .format-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .format-option {
                padding: 14px 10px;
            }
            
            .format-icon {
                font-size: 1.5rem;
                margin-bottom: 4px;
            }
            
            .format-name {
                font-size: 0.78rem;
            }
            
            .format-desc {
                display: none;
            }
            
            /* 9宮格改為2列 */
            .infographic-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                padding: 16px;
            }
            
            .info-card {
                padding: 16px;
            }
            
            .info-card.title-card {
                grid-column: span 2;
            }
            
            .info-card-title {
                font-size: 0.95rem;
            }
            
            .info-card-content {
                font-size: 0.82rem;
            }
            
            /* 摘要調整 */
            .summary-wrapper {
                padding: 24px 16px;
            }
            
            .summary-title {
                font-size: 1.4rem;
            }
            
            .summary-subtitle {
                font-size: 0.95rem;
            }
            
            .summary-main-text,
            .summary-conclusion {
                padding: 20px;
            }
            
            .point-header {
                padding: 14px 16px;
            }
            
            .point-number {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            .point-detail {
                padding: 0 16px 16px 58px;
            }
            
            /* 簡報模式調整 */
            .presentation-header {
                height: 50px;
                padding: 0 12px;
            }
            
            .presentation-title {
                font-size: 0.9rem;
            }
            
            .presentation-btn {
                width: 38px;
                height: 38px;
            }
            
            .presentation-content {
                padding: 20px;
            }
            
            .slide-node {
                padding: 24px 30px;
            }
            
            .slide-node-text {
                font-size: 1.5rem;
            }
            
            .slide-children {
                gap: 10px;
            }
            
            .slide-child {
                padding: 12px 18px;
                font-size: 0.9rem;
            }
            
            /* Modal 調整 */
            .modal {
                min-width: auto;
                width: calc(100% - 32px);
                margin: 16px;
                padding: 20px;
            }
            
            /* 佔位符調整 */
            .placeholder-icon {
                font-size: 3.5rem;
            }
            
            .placeholder-title {
                font-size: 1.1rem;
            }
            
            .placeholder-text {
                font-size: 0.82rem;
            }
            
            /* 生成按鈕 */
            .generate-btn {
                padding: 14px 20px;
                font-size: 0.95rem;
            }
            
            /* 啟動畫面調整 */
            .splash-logo-container {
                width: 150px;
                height: 150px;
            }
            
            .logo-ring-outer {
                width: 150px;
                height: 150px;
            }
            
            .logo-ring-middle {
                width: 125px;
                height: 125px;
            }
            
            .logo-ring-inner {
                width: 100px;
                height: 100px;
            }
            
            .logo-hexagon {
                width: 70px;
                height: 80px;
            }
            
            .logo-icon {
                font-size: 2rem;
            }
            
            .splash-title {
                font-size: 1.4rem;
                letter-spacing: 2px;
            }
            
            .splash-subtitle {
                font-size: 0.75rem;
            }
            
            .splash-progress {
                width: 220px;
            }
            
            .splash-corner {
                width: 40px;
                height: 40px;
            }
            
            .splash-corner.tl,
            .splash-corner.tr,
            .splash-corner.bl,
            .splash-corner.br {
                top: 20px;
                left: 20px;
            }
            
            .splash-corner.tr { left: auto; right: 20px; }
            .splash-corner.bl { top: auto; bottom: 20px; }
            .splash-corner.br { top: auto; bottom: 20px; left: auto; right: 20px; }
        }

        /* ============================================
           超小螢幕 (<400px)
           ============================================ */
        @media (max-width: 400px) {
            .infographic-grid {
                grid-template-columns: 1fr;
            }
            
            .info-card.title-card {
                grid-column: span 1;
            }
            
            .slide-node-text {
                font-size: 1.2rem;
            }
            
            .slide-child {
                padding: 10px 14px;
                font-size: 0.82rem;
            }
        }

        /* ============================================
           列印樣式
           ============================================ */
        @media print {
            .sidebar,
            .toolbar,
            .splash-screen,
            .context-menu,
            .modal-overlay,
            .toast-container,
            .loading-overlay,
            .mobile-header,
            .sidebar-backdrop {
                display: none !important;
            }
            
            .main-content {
                width: 100%;
                height: auto;
            }
            
            .result-container {
                position: static;
                overflow: visible;
            }
        }
    </style>
</head>
<body>
    <!-- 酷炫科技風啟動畫面 -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-grid"></div>
        <div class="splash-particles" id="splashParticles"></div>
        
        <div class="splash-corner tl"></div>
        <div class="splash-corner tr"></div>
        <div class="splash-corner bl"></div>
        <div class="splash-corner br"></div>
        
        <div class="splash-logo-container">
            <div class="logo-ring-outer"></div>
            <div class="logo-ring-middle"></div>
            <div class="logo-ring-inner"></div>
            <div class="splash-scanline"></div>
            <div class="logo-hexagon">
                <span class="logo-icon">📊</span>
            </div>
        </div>
        
        <div class="splash-title">AI VISUAL SUMMARY</div>
        <div class="splash-subtitle">心智圖 · 資訊圖表 · 流程圖 · 重點摘要</div>
        
        <div class="splash-progress"></div>
        <div class="splash-status">INITIALIZING SYSTEM...</div>
    </div>

    <!-- 手機版背景遮罩 -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- 手機版頭部 -->
    <header class="mobile-header" id="mobileHeader" style="display: none;">
        <button class="mobile-back-btn" id="mobileBackBtn" title="返回設定" style="display: none;">
            ← 設定
        </button>
        <div class="mobile-logo">
            <span class="mobile-logo-icon">📊</span>
            <span class="mobile-logo-text">AI Visual Summary</span>
        </div>
        <button class="mobile-toggle" id="mobileToggle" title="開啟選單">☰</button>
    </header>

    <!-- 應用程式容器 -->
    <div class="app-container">
        <!-- 側邊欄 -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-close" id="sidebarClose" style="display: none;">✕</button>
            
            <header class="sidebar-header">
                <div class="app-logo">
                    <span class="logo-icon-small">📊</span>
                    <span class="logo-text">AI Visual Summary</span>
                    <span class="version-badge">v11</span>
                </div>
                <p class="app-subtitle">心智圖 · 資訊圖表 · 流程圖 · 重點摘要</p>
            </header>
            
            <div class="sidebar-content">
                <!-- API 設定 -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-icon">🔑</div>
                        <div>
                            <div class="section-title">Gemini API 設定</div>
                            <div class="section-subtitle">免費使用 Google AI</div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">🔐 API Key <span style="color:#ff4444">*</span></label>
                        <div class="input-with-btn">
                            <input type="password" class="input-field" id="apiKeyInput" placeholder="輸入 Gemini API Key...">
                            <button class="input-inline-btn" id="verifyApiBtn" title="驗證">✓</button>
                        </div>
                        <div class="api-status" id="apiStatus"></div>
                        <a class="help-link" href="https://aistudio.google.com/app/apikey" target="_blank">
                            📎 免費取得 API Key →
                        </a>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">🤖 選擇模型</label>
                        <select class="input-field" id="modelSelect">
                            <option value="gemini-2.5-flash">⚡ Gemini 2.5 Flash（推薦）</option>
                            <option value="gemini-2.5-pro">🧠 Gemini 2.5 Pro（更強）</option>
                            <option value="gemini-2.0-flash">🔷 Gemini 2.0 Flash（穩定）</option>
                        </select>
                    </div>
                </section>
                
                <!-- 檔案上傳 -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-icon purple">📄</div>
                        <div>
                            <div class="section-title">輸入內容</div>
                            <div class="section-subtitle">上傳檔案或輸入文字</div>
                        </div>
                    </div>
                    
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-content">
                            <div class="upload-icon">📁</div>
                            <div class="upload-text">點擊或拖放上傳<br><strong>PDF / Word / TXT / MD</strong></div>
                            <div class="upload-formats">最大 10MB</div>
                        </div>
                        <input type="file" id="fileInput" accept=".pdf,.txt,.md,.doc,.docx" style="display:none">
                    </div>
                    
                    <div class="file-info" id="fileInfo">
                        <div class="file-icon" id="fileIcon">📄</div>
                        <div class="file-details">
                            <div class="file-name" id="fileName"></div>
                            <div class="file-meta">
                                <span class="file-size" id="fileSize"></span>
                            </div>
                        </div>
                        <button class="file-remove" id="fileRemove">✕</button>
                    </div>
                    
                    <div class="input-group" style="margin-top:14px;">
                        <label class="input-label">✏️ 或直接輸入文字</label>
                        <textarea class="input-field" id="textInput" placeholder="貼上要分析的文字內容..."></textarea>
                    </div>
                </section>
                
                <!-- 輸出格式 -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-icon orange">🎨</div>
                        <div>
                            <div class="section-title">輸出格式</div>
                            <div class="section-subtitle">選擇視覺化方式</div>
                        </div>
                    </div>
                    
                    <div class="format-grid">
                        <label class="format-option active">
                            <input type="radio" name="outputFormat" value="mindmap" checked>
                            <div class="format-content">
                                <div class="format-icon">🧠</div>
                                <div class="format-name">心智圖</div>
                                <div class="format-desc">視覺化結構</div>
                            </div>
                            <div class="format-check">✓</div>
                        </label>
                        
                        <label class="format-option">
                            <input type="radio" name="outputFormat" value="infographic">
                            <div class="format-content">
                                <div class="format-icon">📊</div>
                                <div class="format-name">資訊圖表</div>
                                <div class="format-desc">9宮格呈現</div>
                            </div>
                            <div class="format-check">✓</div>
                        </label>
                        
                        <label class="format-option">
                            <input type="radio" name="outputFormat" value="flowchart">
                            <div class="format-content">
                                <div class="format-icon">🔀</div>
                                <div class="format-name">流程圖</div>
                                <div class="format-desc">可拖曳縮放</div>
                            </div>
                            <div class="format-check">✓</div>
                        </label>
                        
                        <label class="format-option">
                            <input type="radio" name="outputFormat" value="summary">
                            <div class="format-content">
                                <div class="format-icon">💡</div>
                                <div class="format-name">重點摘要</div>
                                <div class="format-desc">含詳細講解</div>
                            </div>
                            <div class="format-check">✓</div>
                        </label>
                    </div>
                </section>
                
                <!-- 進階設定 -->
                <section class="section">
                    <div class="advanced-toggle" id="advancedToggle">
                        <span class="advanced-toggle-text">⚙️ 進階設定</span>
                        <span class="advanced-toggle-icon">▼</span>
                    </div>
                    <div class="advanced-content" id="advancedContent">
                        <div class="input-group">
                            <label class="input-label">📐 心智圖初始展開</label>
                            <select class="input-field" id="expandLevelSelect">
                                <option value="1" selected>只展開第 1 層（推薦）</option>
                                <option value="2">展開到第 2 層</option>
                                <option value="3">展開到第 3 層</option>
                                <option value="99">全部展開</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">🎨 配色方案</label>
                            <select class="input-field" id="colorSchemeSelect">
                                <option value="neon">霓虹科技（預設）</option>
                                <option value="ocean">深海藍</option>
                                <option value="sunset">日落橙</option>
                                <option value="forest">森林綠</option>
                            </select>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- 生成按鈕 -->
            <div class="sidebar-footer">
                <button class="generate-btn" id="generateBtn">
                    <span class="spinner"></span>
                    <span class="btn-icon">✨</span>
                    <span class="btn-text">開始生成視覺摘要</span>
                </button>
                <div class="generate-hint">使用 AI 分析並生成視覺化結果</div>
            </div>
        </aside>
        
        <!-- 主要內容區 -->
        <main class="main-content">
            <div class="toolbar" id="toolbar">
                <div class="toolbar-group" id="mindmapTools">
                    <button class="tool-btn" onclick="MindMap.expandAll()">📂 全展開</button>
                    <button class="tool-btn" onclick="MindMap.collapseToLevel(1)">📁 收合</button>
                    <button class="tool-btn purple" onclick="Presentation.start()">🎬 簡報模式</button>
                </div>
                
                <div class="toolbar-divider"></div>
                
                <div class="toolbar-group">
                    <button class="tool-btn" onclick="Zoom.in()">🔍 放大</button>
                    <button class="tool-btn" onclick="Zoom.out()">🔎 縮小</button>
                    <button class="tool-btn" onclick="Zoom.reset()">⟲ 重置</button>
                </div>
                
                <div class="toolbar-divider"></div>
                
                <div class="toolbar-group">
                    <button class="tool-btn" onclick="Download.svg()">💾 SVG</button>
                    <button class="tool-btn" onclick="Download.png()">🖼️ PNG</button>
                </div>
                
                <!-- 手機版編輯按鈕 -->
                <button class="tool-btn mobile-edit-btn" id="mobileEditBtn" onclick="showMobileEditMenu()" style="display:none;">✏️ 編輯節點</button>
                
                <div class="toolbar-spacer"></div>
                <div class="toolbar-info" id="toolbarInfo">雙擊節點展開/收合 | 右鍵編輯</div>
            </div>
            
            <div class="output-area" id="outputArea">
                <div class="output-placeholder" id="outputPlaceholder">
                    <div class="placeholder-icon">🎨</div>
                    <div class="placeholder-title">READY TO GENERATE</div>
                    <div class="placeholder-text">上傳文件或輸入文字，選擇格式後生成</div>
                    <div class="placeholder-steps">
                        <div class="placeholder-step">
                            <div class="placeholder-step-num">1</div>
                            輸入 Gemini API Key
                        </div>
                        <div class="placeholder-step">
                            <div class="placeholder-step-num">2</div>
                            上傳檔案或輸入文字
                        </div>
                        <div class="placeholder-step">
                            <div class="placeholder-step-num">3</div>
                            選擇格式並生成
                        </div>
                    </div>
                </div>
                
                <div id="svgContainer"></div>
                <div class="result-container" id="resultContainer"></div>
            </div>
        </main>
    </div>
    
    <!-- 簡報模式 - 增強版 -->
    <div class="presentation-overlay" id="presentationOverlay">
        <div class="presentation-bg" id="presentationBg"></div>
        <header class="presentation-header">
            <div class="presentation-header-left">
                <div class="presentation-title" id="presentationTitle">簡報模式</div>
                <div class="presentation-anim-name" id="presentationAnimName">動畫效果</div>
            </div>
            <nav class="presentation-nav">
                <span class="presentation-counter" id="presentationCounter">1 / 1</span>
                <button class="presentation-btn" id="prevSlideBtn" onclick="Presentation.prev()" title="上一頁">◀</button>
                <button class="presentation-btn" id="nextSlideBtn" onclick="Presentation.next()" title="下一頁">▶</button>
                <button class="presentation-btn presentation-close" onclick="Presentation.close()" title="關閉">✕</button>
            </nav>
        </header>
        <div class="presentation-content" id="presentationContent"></div>
        <div class="presentation-progress">
            <div class="presentation-progress-bar" id="presentationProgressBar"></div>
        </div>
    </div>
    
    <!-- 右鍵選單 -->
    <div class="context-menu" id="contextMenu">
        <button class="context-menu-item" onclick="MindMap.editNode()">✏️ 編輯名稱</button>
        <button class="context-menu-item" onclick="MindMap.addChild()">➕ 新增子節點</button>
        <div class="context-menu-divider"></div>
        <button class="context-menu-item" onclick="MindMap.toggleNode()">📂 展開/收合</button>
        <button class="context-menu-item" onclick="MindMap.expandBranch()">🌳 展開分支</button>
        <div class="context-menu-divider"></div>
        <button class="context-menu-item danger" onclick="MindMap.deleteNode()">🗑️ 刪除節點</button>
    </div>
    
    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modalIcon">✏️</div>
                <div>
                    <div class="modal-title" id="modalTitle">編輯</div>
                    <div class="modal-subtitle" id="modalSubtitle">修改內容</div>
                </div>
            </div>
            <div class="modal-body">
                <input type="text" class="modal-input" id="modalInput" placeholder="輸入內容...">
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="Modal.close()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="Modal.confirm()">確定</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Loading -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner-container">
            <div class="loading-spinner"></div>
            <div class="loading-spinner-inner"></div>
        </div>
        <div class="loading-text" id="loadingText">正在處理...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
        <div class="loading-step" id="loadingStep">準備中...</div>
    </div>
    <script>
        // ============================================
        // 外部庫設定
        // ============================================
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        mermaid.initialize({
            startOnLoad: false,
            securityLevel: 'loose',
            theme: 'dark',
            themeVariables: {
                fontSize: '16px',
                fontFamily: 'Noto Sans TC, sans-serif',
                primaryColor: '#00f5ff',
                primaryTextColor: '#ffffff',
                primaryBorderColor: '#00c4cc',
                lineColor: '#00f5ff',
                secondaryColor: '#111827',
                tertiaryColor: '#1f2937',
                background: '#0a0f1a',
                mainBkg: '#111827',
                nodeBorder: '#00f5ff'
            },
            flowchart: {
                nodeSpacing: 60,
                rankSpacing: 80,
                curve: 'basis',
                useMaxWidth: false,
                htmlLabels: true
            }
        });

        // ============================================
        // 全域狀態
        // ============================================
        const AppState = {
            fileContent: '',
            fileName: '',
            currentFormat: 'mindmap',
            expandLevel: 1,
            colorScheme: 'neon',
            mindmapData: null,
            selectedNode: null,
            flowchartZoom: 1,
            flowchartPan: { x: 0, y: 0 },
            isMobile: false,
            modalMode: ''
        };

        // 配色方案
        const ColorSchemes = {
            neon: ['#00f5ff', '#bf00ff', '#ff00aa', '#00ff88', '#0066ff', '#ffff00', '#ff6600', '#00ffcc'],
            ocean: ['#0ea5e9', '#06b6d4', '#14b8a6', '#3b82f6', '#6366f1', '#8b5cf6', '#0284c7', '#0891b2'],
            sunset: ['#f59e0b', '#ef4444', '#ec4899', '#f97316', '#eab308', '#f43f5e', '#fb7185', '#fbbf24'],
            forest: ['#10b981', '#22c55e', '#84cc16', '#14b8a6', '#059669', '#16a34a', '#65a30d', '#0d9488']
        };

        let d3Svg, d3Group, d3Zoom, d3Simulation;
        let nodeIdCounter = 0;

        // ============================================
        // 初始化
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 AI Visual Summary v11 啟動中...');
            
            // 生成粒子
            createParticles();
            
            // 檢測裝置
            checkDevice();
            window.addEventListener('resize', debounce(checkDevice, 200));
            
            // 載入 API Key
            loadSavedApiKey();
            
            // 設定事件
            setupEventListeners();
            
            // 初始化 SVG
            initializeSvg();
            
            // 啟動畫面淡出
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                if (splash) {
                    splash.classList.add('hide');
                    setTimeout(() => {
                        splash.remove();
                        // 手機版：啟動後自動開啟側邊欄
                        if (AppState.isMobile) {
                            document.getElementById('sidebar').classList.add('open');
                            document.getElementById('sidebarBackdrop').classList.add('show');
                        }
                    }, 800);
                }
            }, 2500);
            
            console.log('✅ 初始化完成');
        });

        // 生成粒子效果
        function createParticles() {
            const container = document.getElementById('splashParticles');
            if (!container) return;
            
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (5 + Math.random() * 5) + 's';
                
                // 隨機顏色
                const colors = ['#00f5ff', '#bf00ff', '#ff00aa', '#00ff88'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.boxShadow = `0 0 10px ${particle.style.background}`;
                
                container.appendChild(particle);
            }
        }

        // 檢測裝置類型
        function checkDevice() {
            const wasMobile = AppState.isMobile;
            AppState.isMobile = window.innerWidth < 768;
            
            const mobileHeader = document.getElementById('mobileHeader');
            const sidebarClose = document.getElementById('sidebarClose');
            const sidebar = document.getElementById('sidebar');
            const backBtn = document.getElementById('mobileBackBtn');
            const menuBtn = document.getElementById('mobileToggle');
            
            if (AppState.isMobile) {
                mobileHeader.style.display = 'flex';
                sidebarClose.style.display = 'flex';
                // 初始狀態：顯示漢堡選單，隱藏返回按鈕
                backBtn.style.display = 'none';
                menuBtn.style.display = 'flex';
                if (!wasMobile) {
                    sidebar.classList.remove('open');
                }
            } else {
                mobileHeader.style.display = 'none';
                sidebarClose.style.display = 'none';
                backBtn.style.display = 'none';
                sidebar.classList.remove('open');
                document.getElementById('sidebarBackdrop').classList.remove('show');
            }
            
            // 調整 SVG 大小
            handleResize();
        }

        // API Key 提示（不儲存）
        function loadSavedApiKey() {
            // 為了安全性，API Key 不儲存在瀏覽器
            // 每次使用都需要重新輸入
            showApiStatus('請輸入您的 API Key（不會被儲存）', 'info');
        }

        // ============================================
        // 事件監聽
        // ============================================
        function setupEventListeners() {
            // API 驗證
            document.getElementById('verifyApiBtn').addEventListener('click', verifyApiKey);
            document.getElementById('apiKeyInput').addEventListener('keydown', e => {
                if (e.key === 'Enter') verifyApiKey();
            });
            
            // 上傳
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            
            uploadZone.addEventListener('click', () => fileInput.click());
            uploadZone.addEventListener('dragover', e => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
            uploadZone.addEventListener('drop', e => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                if (e.dataTransfer.files[0]) handleFileUpload(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', e => {
                if (e.target.files[0]) handleFileUpload(e.target.files[0]);
            });
            document.getElementById('fileRemove').addEventListener('click', clearFile);
            
            // 格式選擇
            document.querySelectorAll('.format-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.format-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    AppState.currentFormat = this.querySelector('input').value;
                    updateToolbar();
                });
            });
            
            // 進階設定
            document.getElementById('advancedToggle').addEventListener('click', function() {
                this.classList.toggle('open');
                document.getElementById('advancedContent').classList.toggle('show');
            });
            document.getElementById('expandLevelSelect').addEventListener('change', e => {
                AppState.expandLevel = parseInt(e.target.value);
            });
            document.getElementById('colorSchemeSelect').addEventListener('change', e => {
                AppState.colorScheme = e.target.value;
            });
            
            // 生成
            document.getElementById('generateBtn').addEventListener('click', generateVisualization);
            
            // 手機版選單
            document.getElementById('mobileToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebarBackdrop').classList.add('show');
                updateMobileBackBtn(false);
            });
            document.getElementById('sidebarClose').addEventListener('click', closeMobileSidebar);
            document.getElementById('sidebarBackdrop').addEventListener('click', closeMobileSidebar);
            
            // 手機版返回按鈕
            document.getElementById('mobileBackBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('open');
                document.getElementById('sidebarBackdrop').classList.add('show');
                updateMobileBackBtn(false);
            });
            
            // 關閉右鍵選單
            document.addEventListener('click', e => {
                if (!e.target.closest('.context-menu')) hideContextMenu();
            });
            
            // Modal 快捷鍵
            document.getElementById('modalInput').addEventListener('keydown', e => {
                if (e.key === 'Enter') Modal.confirm();
                if (e.key === 'Escape') Modal.close();
            });
            document.getElementById('modalOverlay').addEventListener('click', e => {
                if (e.target === e.currentTarget) Modal.close();
            });
            
            // 鍵盤控制簡報
            document.addEventListener('keydown', e => {
                if (document.getElementById('presentationOverlay').classList.contains('show')) {
                    if (e.key === 'ArrowRight' || e.key === ' ') Presentation.next();
                    if (e.key === 'ArrowLeft') Presentation.prev();
                    if (e.key === 'Escape') Presentation.close();
                }
            });
        }

        function closeMobileSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarBackdrop').classList.remove('show');
            // 只有在已經生成結果時才顯示返回按鈕
            const hasResult = document.getElementById('outputPlaceholder').style.display === 'none';
            if (hasResult) {
                updateMobileBackBtn(true);
            }
        }

        // 更新手機版返回按鈕顯示狀態
        function updateMobileBackBtn(show) {
            if (!AppState.isMobile) return;
            const backBtn = document.getElementById('mobileBackBtn');
            const menuBtn = document.getElementById('mobileToggle');
            if (show) {
                backBtn.style.display = 'block';
                menuBtn.style.display = 'none';
            } else {
                backBtn.style.display = 'none';
                menuBtn.style.display = 'flex';
            }
        }

        // ============================================
        // API 驗證
        // ============================================
        async function verifyApiKey() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                showApiStatus('請輸入 API Key', 'error');
                return;
            }
            
            const btn = document.getElementById('verifyApiBtn');
            btn.textContent = '...';
            btn.disabled = true;
            showApiStatus('正在驗證...', 'loading');
            
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: 'OK' }] }],
                            generationConfig: { maxOutputTokens: 5 }
                        })
                    }
                );
                
                if (response.ok) {
                    // 不儲存 API Key，僅顯示驗證成功
                    showApiStatus('✅ 驗證成功！可以開始使用', 'success');
                    Toast.show('API Key 驗證成功', 'success');
                } else {
                    const err = await response.json();
                    showApiStatus('❌ ' + (err.error?.message || '驗證失敗'), 'error');
                }
            } catch (e) {
                showApiStatus('❌ 網路錯誤', 'error');
            } finally {
                btn.textContent = '✓';
                btn.disabled = false;
            }
        }

        function showApiStatus(msg, type) {
            const status = document.getElementById('apiStatus');
            const icons = { success: '✅', error: '❌', loading: '⏳', info: 'ℹ️' };
            status.innerHTML = `<span>${icons[type] || 'ℹ️'}</span><span>${msg}</span>`;
            status.className = `api-status show ${type}`;
        }

        // ============================================
        // 檔案處理
        // ============================================
        async function handleFileUpload(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['pdf', 'txt', 'md', 'doc', 'docx'].includes(ext)) {
                Toast.show('僅支援 PDF/Word/TXT/MD', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                Toast.show('檔案不可超過 10MB', 'error');
                return;
            }
            
            AppState.fileName = file.name;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').classList.add('show');
            document.getElementById('uploadZone').classList.add('has-file');
            
            // 更新檔案圖示
            const fileIcon = document.getElementById('fileIcon');
            if (ext === 'pdf') {
                fileIcon.textContent = '📕';
            } else if (ext === 'doc' || ext === 'docx') {
                fileIcon.textContent = '📘';
            } else if (ext === 'md') {
                fileIcon.textContent = '📝';
            } else {
                fileIcon.textContent = '📄';
            }
            
            try {
                Loading.show('讀取檔案...', '處理中');
                
                if (ext === 'pdf') {
                    // PDF 處理
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let text = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + '\n';
                        Loading.updateProgress((i / pdf.numPages) * 100);
                    }
                    AppState.fileContent = text.trim();
                } else if (ext === 'doc' || ext === 'docx') {
                    // Word 文件處理
                    Loading.updateProgress(30);
                    const arrayBuffer = await file.arrayBuffer();
                    Loading.updateProgress(50);
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    Loading.updateProgress(90);
                    AppState.fileContent = result.value.trim();
                    
                    // 如果有警告訊息
                    if (result.messages && result.messages.length > 0) {
                        console.log('Word 文件處理警告:', result.messages);
                    }
                } else {
                    // TXT / MD 處理
                    AppState.fileContent = await file.text();
                }
                
                Loading.updateProgress(100);
                Loading.hide();
                
                // 顯示字數
                const wordCount = AppState.fileContent.length;
                document.getElementById('fileSize').textContent = 
                    formatFileSize(file.size) + ' · ' + wordCount.toLocaleString() + ' 字';
                
                Toast.show('檔案載入成功，請選擇輸出格式', 'success');
                
                // 手機版：不自動關閉側邊欄，讓使用者選擇格式
            } catch (e) {
                console.error('檔案讀取錯誤:', e);
                Loading.hide();
                Toast.show('檔案讀取失敗: ' + (e.message || '未知錯誤'), 'error');
                clearFile();
            }
        }

        function clearFile() {
            AppState.fileContent = '';
            AppState.fileName = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('uploadZone').classList.remove('has-file');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // ============================================
        // 工具列更新
        // ============================================
        function updateToolbar() {
            const mindmapTools = document.getElementById('mindmapTools');
            const toolbarInfo = document.getElementById('toolbarInfo');
            const mobileEditBtn = document.getElementById('mobileEditBtn');
            
            switch (AppState.currentFormat) {
                case 'mindmap':
                    mindmapTools.style.display = 'flex';
                    if (AppState.isMobile) {
                        toolbarInfo.textContent = '點擊節點展開/收合';
                        mobileEditBtn.style.display = 'block';
                    } else {
                        toolbarInfo.textContent = '雙擊節點展開/收合 | 右鍵編輯';
                        mobileEditBtn.style.display = 'none';
                    }
                    break;
                case 'flowchart':
                    mindmapTools.style.display = 'none';
                    mobileEditBtn.style.display = 'none';
                    toolbarInfo.textContent = '拖曳平移 | 滾輪縮放';
                    break;
                case 'infographic':
                    mindmapTools.style.display = 'none';
                    mobileEditBtn.style.display = 'none';
                    toolbarInfo.textContent = '9宮格資訊展示';
                    break;
                case 'summary':
                    mindmapTools.style.display = 'none';
                    mobileEditBtn.style.display = 'none';
                    toolbarInfo.textContent = '點擊重點展開詳細講解';
                    break;
            }
        }

        function handleResize() {
            if (d3Svg) {
                const container = document.getElementById('svgContainer');
                const rect = container.parentElement.getBoundingClientRect();
                d3Svg.attr('width', rect.width).attr('height', rect.height);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }
        // ============================================
        // 主要生成函數
        // ============================================
        async function generateVisualization() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                Toast.show('請先輸入 API Key', 'error');
                return;
            }
            
            const content = AppState.fileContent || document.getElementById('textInput').value.trim();
            if (!content || content.length < 30) {
                Toast.show('請輸入更多內容', 'error');
                return;
            }
            
            const format = AppState.currentFormat;
            const model = document.getElementById('modelSelect').value;
            const btn = document.getElementById('generateBtn');
            
            btn.classList.add('loading');
            btn.disabled = true;
            Loading.show('AI 分析中...', '處理您的內容');
            
            try {
                const prompt = buildPrompt(content, format);
                Loading.updateProgress(20);
                
                const result = await callGeminiApi(apiKey, model, prompt);
                Loading.updateProgress(70);
                
                await renderResult(result, format);
                Loading.updateProgress(100);
                
                document.getElementById('outputPlaceholder').style.display = 'none';
                Toast.show('生成完成！', 'success');
                
                // 手機版：關閉側邊欄並顯示返回按鈕
                if (AppState.isMobile) {
                    document.getElementById('sidebar').classList.remove('open');
                    document.getElementById('sidebarBackdrop').classList.remove('show');
                    // 顯示返回按鈕
                    document.getElementById('mobileBackBtn').style.display = 'block';
                    document.getElementById('mobileToggle').style.display = 'none';
                }
            } catch (error) {
                Toast.show(error.message || '生成失敗', 'error');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                setTimeout(() => Loading.hide(), 300);
            }
        }

        // ============================================
        // Prompt 建構
        // ============================================
        function buildPrompt(content, format) {
            const text = content.substring(0, 15000);
            
            switch (format) {
                case 'mindmap': return buildMindmapPrompt(text);
                case 'infographic': return buildInfographicPrompt(text);
                case 'flowchart': return buildFlowchartPrompt(text);
                case 'summary': return buildSummaryPrompt(text);
                default: return buildMindmapPrompt(text);
            }
        }

        function buildMindmapPrompt(content) {
            return `你是專業的心智圖設計師，分析以下內容生成完整的 JSON 心智圖。

【嚴格要求】
1. 只輸出純 JSON，不要任何其他文字
2. 使用繁體中文
3. 格式：{"name": "主題", "children": [{"name": "分支", "children": [...]}]}
4. 層級：3-5 層深度
5. 每分支：3-8 個子節點
6. 節點名稱：5-20 字，簡潔有力
7. 必須涵蓋所有重要概念

【待分析內容】
${content}`;
        }

        function buildInfographicPrompt(content) {
            return `你是資訊圖表設計師。分析以下內容，生成 9 個重點的 JSON 格式。

【嚴格要求】
1. 只輸出 JSON，不要其他文字
2. 使用繁體中文
3. 格式：
{
  "title": "主標題（8-15字）",
  "cards": [
    {"title": "重點標題（5-12字）", "content": "說明內容（30-60字）"},
    ... 共 8 個卡片
  ]
}
4. 必須正好 8 個 cards（加上標題共 9 格）
5. 每個 card 要有具體、有資訊量的內容
6. 按邏輯順序排列

【待分析內容】
${content}`;
        }

        function buildFlowchartPrompt(content) {
            return `你是 Mermaid 流程圖設計師。

【嚴格要求】
1. 只輸出 Mermaid 代碼，不要 \`\`\` 標記
2. 使用 flowchart TD
3. 繁體中文
4. 節點 ID 用字母數字（A, B, C1）
5. 節點文字用 [] 包裹，不要特殊字元
6. 判斷用 {}，連線標籤用 |文字|
7. 包含：開始、3-8 步驟、1-3 判斷、結束

【範例】
flowchart TD
    A[開始] --> B[第一步]
    B --> C{判斷}
    C -->|是| D[動作A]
    C -->|否| E[動作B]
    D --> F[結束]
    E --> F

【待分析內容】
${content}`;
        }

        function buildSummaryPrompt(content) {
            return `你是文件分析專家。分析以下內容，生成帶詳細講解的結構化摘要。

【嚴格要求】
請輸出 JSON 格式，不要其他文字：

{
  "title": "主標題（8-15字）",
  "subtitle": "副標題（15-30字）",
  "mainText": "主文摘要（150-250字，概述核心內容）",
  "points": [
    {
      "title": "重點標題（10-20字）",
      "detail": "詳細講解（80-150字，深入說明此重點）"
    }
  ],
  "conclusion": "總結（30-50字）"
}

【要求】
1. 繁體中文
2. points 數量：6-10 個
3. 每個 point 必須有 title 和 detail
4. detail 要深入解釋，不是重複 title
5. 涵蓋原文所有關鍵資訊

【待分析內容】
${content}`;
        }

        // ============================================
        // API 呼叫
        // ============================================
        async function callGeminiApi(apiKey, model, prompt) {
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 8192,
                            topP: 0.8
                        }
                    })
                }
            );
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'API 錯誤');
            }
            
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        }

        // ============================================
        // 渲染結果
        // ============================================
        async function renderResult(result, format) {
            const svgContainer = document.getElementById('svgContainer');
            const resultContainer = document.getElementById('resultContainer');
            const toolbar = document.getElementById('toolbar');
            
            svgContainer.classList.remove('show');
            resultContainer.classList.remove('show');
            resultContainer.innerHTML = '';
            
            switch (format) {
                case 'mindmap':
                    await renderMindmap(result);
                    svgContainer.classList.add('show');
                    toolbar.style.display = 'flex';
                    break;
                case 'infographic':
                    renderInfographic(result);
                    resultContainer.classList.add('show');
                    toolbar.style.display = 'flex';
                    break;
                case 'flowchart':
                    await renderFlowchart(result);
                    resultContainer.classList.add('show');
                    toolbar.style.display = 'flex';
                    break;
                case 'summary':
                    renderSummary(result);
                    resultContainer.classList.add('show');
                    toolbar.style.display = 'none';
                    break;
            }
            
            updateToolbar();
        }
        // ============================================
        // 初始化 SVG
        // ============================================
        function initializeSvg() {
            const container = document.getElementById('svgContainer');
            
            d3Svg = d3.select(container).append('svg');
            d3Group = d3Svg.append('g');
            
            d3Zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', e => d3Group.attr('transform', e.transform));
            
            d3Svg.call(d3Zoom);
            
            d3Svg.on('click', e => {
                if (e.target === d3Svg.node()) {
                    AppState.selectedNode = null;
                    MindMap.updateSelection();
                    hideContextMenu();
                }
            });
            
            handleResize();
        }

        // ============================================
        // 心智圖渲染
        // ============================================
        async function renderMindmap(result) {
            const jsonMatch = result.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error('無法解析心智圖');
            
            const data = JSON.parse(jsonMatch[0]);
            if (!data.name) throw new Error('心智圖格式錯誤');
            
            AppState.mindmapData = data;
            initializeNodeState(data, 0, AppState.expandLevel);
            MindMap.render(data);
        }

        function initializeNodeState(node, depth, expandLevel) {
            node._depth = depth;
            node._id = ++nodeIdCounter;
            
            if (node.children && node.children.length > 0) {
                if (depth >= expandLevel) {
                    node._children = node.children;
                    node.children = null;
                } else {
                    node.children.forEach(child => initializeNodeState(child, depth + 1, expandLevel));
                }
            }
            if (node._children) {
                node._children.forEach(child => initializeNodeState(child, depth + 1, expandLevel));
            }
        }

        // ============================================
        // MindMap 模組
        // ============================================
        const MindMap = {
            render: function(data) {
                d3Group.selectAll('*').remove();
                
                const container = document.getElementById('svgContainer');
                const width = container.clientWidth || 1000;
                const height = container.clientHeight || 700;
                
                const nodes = [];
                const links = [];
                
                function traverse(node, parent, depth, side) {
                    if (!node._id) node._id = ++nodeIdCounter;
                    node._depth = depth;
                    node._side = side;
                    node._parent = parent;
                    
                    if (depth === 0) { node.fx = 0; node.fy = 0; }
                    nodes.push(node);
                    
                    if (parent) links.push({ source: parent, target: node });
                    
                    const children = node.children || [];
                    const half = Math.ceil(children.length / 2);
                    children.forEach((child, i) => {
                        const childSide = depth === 0 ? (i < half ? 'right' : 'left') : side;
                        traverse(child, node, depth + 1, childSide);
                    });
                }
                
                traverse(data, null, 0, 'right');
                
                d3Simulation = d3.forceSimulation(nodes)
                    .force('link', d3.forceLink(links).id(d => d._id).distance(140).strength(0.6))
                    .force('charge', d3.forceManyBody().strength(-350))
                    .force('x', d3.forceX(d => {
                        if (d._depth === 0) return 0;
                        return (d._side === 'left' ? -220 : 220) * d._depth * 0.65;
                    }).strength(0.35))
                    .force('y', d3.forceY(0).strength(0.05))
                    .force('collision', d3.forceCollide(70));
                
                const link = d3Group.selectAll('line.mm-link')
                    .data(links).enter().append('line')
                    .attr('class', 'mm-link')
                    .attr('stroke', d => this.getColor(d.source._depth))
                    .attr('stroke-width', d => Math.max(2, 7 - d.source._depth))
                    .attr('stroke-opacity', 0.5);
                
                const node = d3Group.selectAll('g.mm-node')
                    .data(nodes).enter().append('g')
                    .attr('class', d => `mm-node ${d._children ? 'collapsed' : ''}`)
                    .call(d3.drag()
                        .on('start', this.dragStart.bind(this))
                        .on('drag', this.dragging.bind(this))
                        .on('end', this.dragEnd.bind(this)))
                    .on('click', (e, d) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        // 手機版：單擊直接展開/收合
                        if (AppState.isMobile) {
                            if (d.children || d._children) {
                                this.toggleNode(d);
                            } else {
                                // 末端節點：選取並顯示選單
                                AppState.selectedNode = d;
                                this.updateSelection();
                                // 顯示浮動操作按鈕
                                this.showMobileActions(d, e);
                            }
                            return;
                        }
                        
                        // 電腦版：雙擊展開/收合
                        if (e.detail === 2) { 
                            this.toggleNode(d); 
                            return; 
                        }
                        AppState.selectedNode = d;
                        this.updateSelection();
                    })
                    .on('contextmenu', (e, d) => {
                        e.preventDefault();
                        e.stopPropagation();
                        AppState.selectedNode = d;
                        this.updateSelection();
                        showContextMenu(e.pageX, e.pageY);
                    });
                
                node.append('rect')
                    .attr('rx', 14).attr('ry', 14)
                    .attr('fill', d => this.getColor(d._depth))
                    .attr('stroke', d => d3.color(this.getColor(d._depth)).brighter(0.5))
                    .attr('stroke-width', 2);
                
                node.append('text')
                    .attr('dy', '0.35em')
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#ffffff')
                    .attr('font-size', d => d._depth === 0 ? 16 : 13)
                    .attr('font-weight', d => d._depth === 0 ? 700 : 500)
                    .text(d => d.name?.length > 18 ? d.name.substring(0, 18) + '...' : d.name);
                
                node.append('circle')
                    .attr('class', 'badge-bg')
                    .attr('r', 14)
                    .attr('fill', '#ef4444')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 2)
                    .style('display', 'none');
                
                node.append('text')
                    .attr('class', 'badge-text')
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#fff')
                    .attr('font-size', 10)
                    .attr('font-weight', 700)
                    .style('display', 'none');
                
                node.each(function(d) {
                    const textEl = d3.select(this).select('text');
                    const bbox = textEl.node().getBBox();
                    const px = d._depth === 0 ? 22 : 16;
                    const py = 10;
                    
                    d3.select(this).select('rect')
                        .attr('x', -bbox.width / 2 - px)
                        .attr('y', -bbox.height / 2 - py)
                        .attr('width', bbox.width + px * 2)
                        .attr('height', bbox.height + py * 2);
                    
                    const bx = bbox.width / 2 + px + 10;
                    const by = -bbox.height / 2 - 6;
                    d3.select(this).select('.badge-bg').attr('cx', bx).attr('cy', by);
                    d3.select(this).select('.badge-text').attr('x', bx).attr('y', by + 3);
                });
                
                this.updateBadges();
                
                d3Simulation.on('tick', () => {
                    link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                    node.attr('transform', d => `translate(${d.x},${d.y})`);
                });
                
                d3Svg.call(d3Zoom.transform, d3.zoomIdentity.translate(width / 2, height / 2).scale(0.65));
            },
            
            getColor: function(depth) {
                const colors = ColorSchemes[AppState.colorScheme] || ColorSchemes.neon;
                return colors[depth % colors.length];
            },
            
            countDescendants: function(node) {
                let count = 0;
                const children = node._children || node.children || [];
                children.forEach(c => { count += 1 + this.countDescendants(c); });
                return count;
            },
            
            updateBadges: function() {
                d3Group.selectAll('.mm-node').each(function(d) {
                    const has = d._children && d._children.length > 0;
                    const count = has ? MindMap.countDescendants(d) : 0;
                    d3.select(this).select('.badge-bg').style('display', has ? 'block' : 'none');
                    d3.select(this).select('.badge-text').style('display', has ? 'block' : 'none').text('+' + count);
                });
            },
            
            updateSelection: function() {
                d3Group.selectAll('.mm-node').classed('selected', d => d === AppState.selectedNode);
            },
            
            dragStart: function(e, d) {
                if (!e.active) d3Simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            },
            dragging: function(e, d) { d.fx = e.x; d.fy = e.y; },
            dragEnd: function(e, d) { if (!e.active) d3Simulation.alphaTarget(0); },
            
            toggleNode: function(node) {
                if (!node) node = AppState.selectedNode;
                if (!node) return;
                hideContextMenu();
                if (node.children) { node._children = node.children; node.children = null; }
                else if (node._children) { node.children = node._children; node._children = null; }
                this.render(AppState.mindmapData);
            },
            
            expandBranch: function() {
                if (!AppState.selectedNode) return;
                hideContextMenu();
                function expand(n) {
                    if (n._children) { n.children = n._children; n._children = null; }
                    if (n.children) n.children.forEach(expand);
                }
                expand(AppState.selectedNode);
                this.render(AppState.mindmapData);
            },
            
            expandAll: function() {
                if (!AppState.mindmapData) return;
                function expand(n) {
                    if (n._children) { n.children = n._children; n._children = null; }
                    if (n.children) n.children.forEach(expand);
                }
                expand(AppState.mindmapData);
                this.render(AppState.mindmapData);
            },
            
            collapseToLevel: function(level) {
                if (!AppState.mindmapData) return;
                function process(n, depth) {
                    if (n._children) { n.children = n._children; n._children = null; }
                    if (n.children) {
                        if (depth >= level) { n._children = n.children; n.children = null; }
                        else n.children.forEach(c => process(c, depth + 1));
                    }
                    if (n._children) n._children.forEach(c => process(c, depth + 1));
                }
                process(AppState.mindmapData, 0);
                this.render(AppState.mindmapData);
            },
            
            editNode: function() {
                if (!AppState.selectedNode) return;
                hideContextMenu();
                AppState.modalMode = 'edit';
                Modal.open('編輯節點', '修改名稱', AppState.selectedNode.name);
            },
            
            addChild: function() {
                if (!AppState.selectedNode) return;
                hideContextMenu();
                AppState.modalMode = 'add';
                Modal.open('新增子節點', '輸入名稱', '');
            },
            
            deleteNode: function() {
                if (!AppState.selectedNode) return;
                hideContextMenu();
                if (AppState.selectedNode._depth === 0) { Toast.show('無法刪除根節點', 'error'); return; }
                function remove(parent, target) {
                    if (parent.children) {
                        const i = parent.children.indexOf(target);
                        if (i > -1) { parent.children.splice(i, 1); return true; }
                        for (const c of parent.children) if (remove(c, target)) return true;
                    }
                    if (parent._children) {
                        const i = parent._children.indexOf(target);
                        if (i > -1) { parent._children.splice(i, 1); return true; }
                        for (const c of parent._children) if (remove(c, target)) return true;
                    }
                    return false;
                }
                remove(AppState.mindmapData, AppState.selectedNode);
                AppState.selectedNode = null;
                this.render(AppState.mindmapData);
            },
            
            // 手機版：顯示浮動操作選單
            showMobileActions: function(d, e) {
                // 直接使用 context menu
                const x = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : window.innerWidth / 2);
                const y = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : window.innerHeight / 2);
                showContextMenu(x, y);
            }
        };

        // ============================================
        // 簡報模式
        // ============================================
        // ============================================
        // 簡報模式 - 增強版（30種動畫特效）
        // ============================================
        const Presentation = {
            slides: [],
            currentIndex: 0,
            currentAnimation: '',
            
            // 30 種動畫定義
            animations: [
                { name: '淡入', css: 'anim-fadeIn', duration: 0.6 },
                { name: '左滑入', css: 'anim-slideLeft', duration: 0.5 },
                { name: '右滑入', css: 'anim-slideRight', duration: 0.5 },
                { name: '上滑入', css: 'anim-slideDown', duration: 0.5 },
                { name: '下滑入', css: 'anim-slideUp', duration: 0.5 },
                { name: '縮放彈入', css: 'anim-zoomIn', duration: 0.5 },
                { name: '縮放彈出', css: 'anim-zoomOut', duration: 0.5 },
                { name: '翻轉X', css: 'anim-flipX', duration: 0.6 },
                { name: '翻轉Y', css: 'anim-flipY', duration: 0.6 },
                { name: '旋轉入', css: 'anim-rotateIn', duration: 0.6 },
                { name: '彈跳', css: 'anim-bounce', duration: 0.8 },
                { name: '橡皮筋', css: 'anim-elastic', duration: 0.7 },
                { name: '搖擺', css: 'anim-swing', duration: 0.7 },
                { name: '脈動', css: 'anim-pulse', duration: 0.5 },
                { name: '閃光', css: 'anim-flash', duration: 0.6 },
                { name: '抖動', css: 'anim-shake', duration: 0.6 },
                { name: '摩天輪', css: 'anim-ferris', duration: 0.7 },
                { name: '光速', css: 'anim-lightSpeed', duration: 0.5 },
                { name: '果凍', css: 'anim-jello', duration: 0.8 },
                { name: '心跳', css: 'anim-heartbeat', duration: 0.7 },
                { name: '打字機', css: 'anim-typewriter', duration: 0.8 },
                { name: '波浪', css: 'anim-wave', duration: 0.6 },
                { name: '螺旋', css: 'anim-spiral', duration: 0.8 },
                { name: '3D翻頁', css: 'anim-page', duration: 0.7 },
                { name: '霓虹', css: 'anim-neon', duration: 0.8 },
                { name: '爆炸', css: 'anim-explode', duration: 0.6 },
                { name: '漩渦', css: 'anim-vortex', duration: 0.8 },
                { name: '折疊', css: 'anim-fold', duration: 0.6 },
                { name: '堆疊', css: 'anim-stack', duration: 0.5 },
                { name: '粒子聚合', css: 'anim-particle', duration: 0.7 }
            ],
            
            start: function() {
                if (!AppState.mindmapData) { Toast.show('請先生成心智圖', 'error'); return; }
                
                this.slides = [];
                this.buildSlides(AppState.mindmapData, null, 0);
                this.currentIndex = 0;
                
                // 生成背景粒子
                this.createBgParticles();
                
                document.getElementById('presentationOverlay').classList.add('show');
                document.getElementById('presentationTitle').textContent = AppState.mindmapData.name;
                this.showSlide();
            },
            
            createBgParticles: function() {
                const bg = document.getElementById('presentationBg');
                bg.innerHTML = '';
                for (let i = 0; i < 50; i++) {
                    const p = document.createElement('div');
                    p.className = 'bg-particle';
                    p.style.left = Math.random() * 100 + '%';
                    p.style.top = Math.random() * 100 + '%';
                    p.style.animationDelay = Math.random() * 15 + 's';
                    p.style.animationDuration = (10 + Math.random() * 10) + 's';
                    const colors = ['#00f5ff', '#bf00ff', '#ff00aa', '#00ff88'];
                    p.style.background = colors[Math.floor(Math.random() * colors.length)];
                    bg.appendChild(p);
                }
            },
            
            buildSlides: function(node, parent, depth) {
                const children = node.children || node._children || [];
                const parentName = parent ? parent.name : '';
                
                // 生成註解文字
                let note = '';
                if (depth === 0) {
                    note = '這是整體架構的核心主題';
                } else if (children.length > 0) {
                    note = `此分支包含 ${children.length} 個子項目`;
                } else {
                    note = '這是末端節點，代表具體的知識點';
                }
                
                this.slides.push({
                    node: node,
                    depth: depth,
                    parent: parentName,
                    children: children.map(c => c.name),
                    childCount: children.length,
                    note: note
                });
                
                children.forEach(c => this.buildSlides(c, node, depth + 1));
            },
            
            getRandomAnimation: function() {
                const index = Math.floor(Math.random() * this.animations.length);
                return this.animations[index];
            },
            
            showSlide: function() {
                const slide = this.slides[this.currentIndex];
                const content = document.getElementById('presentationContent');
                const counter = document.getElementById('presentationCounter');
                const progress = document.getElementById('presentationProgressBar');
                const animNameEl = document.getElementById('presentationAnimName');
                
                // 隨機選擇動畫
                const anim = this.getRandomAnimation();
                this.currentAnimation = anim;
                animNameEl.textContent = `✨ ${anim.name}`;
                
                counter.textContent = `${this.currentIndex + 1} / ${this.slides.length}`;
                progress.style.width = ((this.currentIndex + 1) / this.slides.length * 100) + '%';
                
                document.getElementById('prevSlideBtn').disabled = this.currentIndex === 0;
                document.getElementById('nextSlideBtn').disabled = this.currentIndex === this.slides.length - 1;
                
                const colors = ColorSchemes[AppState.colorScheme] || ColorSchemes.neon;
                const color = colors[slide.depth % colors.length];
                
                // 生成副標題
                let subtitle = '';
                if (slide.depth === 0) {
                    subtitle = '主題概覽';
                } else if (slide.parent) {
                    subtitle = `來自：${slide.parent}`;
                }
                
                // 生成深度指示器
                let depthDots = '';
                const maxDepth = Math.max(...this.slides.map(s => s.depth)) + 1;
                for (let i = 0; i < Math.min(maxDepth, 5); i++) {
                    depthDots += `<span class="depth-dot ${i <= slide.depth ? 'active' : ''}"></span>`;
                }
                
                // 構建 HTML
                let html = `<div class="presentation-slide">`;
                
                // 標題區
                html += `
                    <div class="slide-title-area">
                        <div class="slide-subtitle" style="animation: ${anim.css} ${anim.duration * 0.6}s ease forwards;">${subtitle}</div>
                        <div class="slide-main-title" style="animation: ${anim.css} ${anim.duration}s ease forwards; animation-delay: 0.1s;">${escapeHtml(slide.node.name)}</div>
                        <div class="slide-note" style="animation: ${anim.css} ${anim.duration * 1.2}s ease forwards; animation-delay: 0.2s;">${slide.note}</div>
                    </div>
                `;
                
                // 主要節點卡片（如果有子節點才顯示）
                if (slide.children.length > 0) {
                    html += `
                        <div class="slide-node" style="border-color:${color}; box-shadow: 0 0 50px ${color}40; animation: ${anim.css} ${anim.duration}s ease forwards; animation-delay: 0.3s;">
                            <div class="slide-node-text">📌 包含 ${slide.children.length} 個要點</div>
                        </div>
                    `;
                    
                    // 子節點
                    html += '<div class="slide-children">';
                    slide.children.forEach((c, i) => {
                        const delay = 0.4 + i * 0.1;
                        html += `<div class="slide-child" style="animation: ${anim.css} ${anim.duration}s ease forwards; animation-delay: ${delay}s;">${escapeHtml(c)}</div>`;
                    });
                    html += '</div>';
                } else {
                    // 末端節點的特殊顯示
                    html += `
                        <div class="slide-node" style="border-color:${color}; box-shadow: 0 0 50px ${color}40; animation: ${anim.css} ${anim.duration}s ease forwards; animation-delay: 0.3s;">
                            <div class="slide-node-text">🎯 知識要點</div>
                        </div>
                    `;
                }
                
                // 頁尾
                html += `
                    <div class="slide-footer" style="animation: ${anim.css} ${anim.duration * 1.5}s ease forwards; animation-delay: 0.6s;">
                        <div class="slide-depth-indicator">${depthDots}</div>
                        <div style="margin-top:8px;">層級 ${slide.depth + 1}</div>
                    </div>
                `;
                
                html += '</div>';
                content.innerHTML = html;
            },
            
            next: function() {
                if (this.currentIndex < this.slides.length - 1) {
                    this.currentIndex++;
                    this.showSlide();
                }
            },
            
            prev: function() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.showSlide();
                }
            },
            
            close: function() {
                document.getElementById('presentationOverlay').classList.remove('show');
            }
        };
        // ============================================
        // 流程圖渲染（可拖曳）
        // ============================================
        async function renderFlowchart(result) {
            const container = document.getElementById('resultContainer');
            
            let code = result.replace(/```mermaid\s*/gi, '').replace(/```\s*/g, '').trim();
            if (!code.startsWith('flowchart') && !code.startsWith('graph')) {
                code = 'flowchart TD\n' + code;
            }
            code = fixMermaidSyntax(code);
            
            AppState.flowchartZoom = 1;
            AppState.flowchartPan = { x: 0, y: 0 };
            
            try {
                const uniqueId = 'mermaid-' + Date.now();
                const { svg } = await mermaid.render(uniqueId, code);
                
                container.innerHTML = `
                    <div class="flowchart-wrapper" id="flowchartWrapper">
                        <div class="flowchart-inner" id="flowchartInner">${svg}</div>
                    </div>
                `;
                
                setupFlowchartDrag();
            } catch (error) {
                container.innerHTML = `
                    <div class="flowchart-error">
                        <h3>⚠️ 渲染問題</h3>
                        <p>原始 Mermaid 代碼：</p>
                        <pre>${escapeHtml(code)}</pre>
                    </div>
                `;
            }
        }

        function fixMermaidSyntax(code) {
            code = code.replace(/\[([^\]]*)\]/g, (m, c) => {
                let f = c.replace(/[()（）\[\]【】{}<>《》"'`|｜#＃&＆@＠]/g, '').replace(/\s+/g, ' ').trim();
                return `[${f}]`;
            });
            code = code.replace(/\{([^}]*)\}/g, (m, c) => {
                let f = c.replace(/[()（）\[\]【】<>《》"'`|｜#＃&＆@＠]/g, '').replace(/\s+/g, ' ').trim();
                return `{${f}}`;
            });
            code = code.replace(/\|([^|]*)\|/g, (m, c) => {
                let f = c.replace(/["'`()（）\[\]【】{}<>《》]/g, '').replace(/\s+/g, ' ').trim();
                return `|${f}|`;
            });
            return code;
        }

        // 流程圖拖曳功能
        function setupFlowchartDrag() {
            const wrapper = document.getElementById('flowchartWrapper');
            const inner = document.getElementById('flowchartInner');
            if (!wrapper || !inner) return;
            
            let isDragging = false;
            let startX, startY, startPanX, startPanY;
            
            wrapper.addEventListener('mousedown', e => {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startPanX = AppState.flowchartPan.x;
                startPanY = AppState.flowchartPan.y;
                wrapper.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', e => {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                AppState.flowchartPan.x = startPanX + dx;
                AppState.flowchartPan.y = startPanY + dy;
                updateFlowchartTransform();
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                if (wrapper) wrapper.style.cursor = 'grab';
            });
            
            // 觸控支援
            wrapper.addEventListener('touchstart', e => {
                if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                    startPanX = AppState.flowchartPan.x;
                    startPanY = AppState.flowchartPan.y;
                }
            }, { passive: true });
            
            wrapper.addEventListener('touchmove', e => {
                if (!isDragging || e.touches.length !== 1) return;
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;
                AppState.flowchartPan.x = startPanX + dx;
                AppState.flowchartPan.y = startPanY + dy;
                updateFlowchartTransform();
            }, { passive: true });
            
            wrapper.addEventListener('touchend', () => { isDragging = false; });
            
            // 滾輪縮放
            wrapper.addEventListener('wheel', e => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                AppState.flowchartZoom = Math.max(0.3, Math.min(3, AppState.flowchartZoom * delta));
                updateFlowchartTransform();
            }, { passive: false });
        }

        function updateFlowchartTransform() {
            const inner = document.getElementById('flowchartInner');
            if (inner) {
                inner.style.transform = `translate(${AppState.flowchartPan.x}px, ${AppState.flowchartPan.y}px) scale(${AppState.flowchartZoom})`;
            }
        }

        // ============================================
        // 資訊圖表 - 9宮格
        // ============================================
        function renderInfographic(result) {
            const container = document.getElementById('resultContainer');
            
            try {
                const jsonMatch = result.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('無法解析');
                
                const data = JSON.parse(jsonMatch[0]);
                const cards = data.cards || [];
                
                let html = `
                    <div class="infographic-wrapper">
                        <div class="infographic-grid">
                            <div class="info-card title-card">
                                <div class="title-card-icon">📊</div>
                                <div class="title-card-text">${escapeHtml(data.title || '資訊圖表')}</div>
                            </div>
                `;
                
                // 確保有 8 個卡片
                for (let i = 0; i < 8; i++) {
                    const card = cards[i] || { title: `重點 ${i + 1}`, content: '內容待補充' };
                    html += `
                        <div class="info-card">
                            <div class="info-card-num">${i + 1}</div>
                            <div class="info-card-title">${escapeHtml(card.title)}</div>
                            <div class="info-card-content">${escapeHtml(card.content)}</div>
                        </div>
                    `;
                }
                
                html += '</div></div>';
                container.innerHTML = html;
                
            } catch (e) {
                container.innerHTML = `
                    <div class="infographic-error">
                        <h3>⚠️ 無法生成9宮格</h3>
                        <p>請換用 Gemini 2.5 Pro 重試</p>
                        <pre>${escapeHtml(result.substring(0, 1500))}</pre>
                    </div>
                `;
            }
        }

        // ============================================
        // 重點摘要 - 增強版（含講解）
        // ============================================
        function renderSummary(result) {
            const container = document.getElementById('resultContainer');
            
            try {
                const jsonMatch = result.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('無法解析');
                
                const data = JSON.parse(jsonMatch[0]);
                
                let html = `
                    <div class="summary-wrapper">
                        <div class="summary-header">
                            <div class="summary-icon">📋</div>
                            <h1 class="summary-title">${escapeHtml(data.title || '文件摘要')}</h1>
                            ${data.subtitle ? `<p class="summary-subtitle">${escapeHtml(data.subtitle)}</p>` : ''}
                        </div>
                `;
                
                if (data.mainText) {
                    html += `
                        <div class="summary-main-text">
                            <p>${escapeHtml(data.mainText)}</p>
                        </div>
                    `;
                }
                
                if (data.points && data.points.length > 0) {
                    html += `
                        <div class="summary-points">
                            <h3 class="summary-points-title">📌 重點整理</h3>
                    `;
                    
                    data.points.forEach((point, i) => {
                        const title = typeof point === 'string' ? point : (point.title || point);
                        const detail = typeof point === 'object' ? point.detail : '';
                        
                        html += `
                            <div class="point-item" onclick="this.classList.toggle('expanded')">
                                <div class="point-header">
                                    <div class="point-number">${i + 1}</div>
                                    <div class="point-title">${escapeHtml(title)}</div>
                                    ${detail ? '<div class="point-toggle">▼</div>' : ''}
                                </div>
                                ${detail ? `
                                    <div class="point-detail">
                                        <div class="point-detail-content">${escapeHtml(detail)}</div>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                if (data.conclusion) {
                    html += `
                        <div class="summary-conclusion">
                            <div class="summary-conclusion-icon">💡</div>
                            <p>${escapeHtml(data.conclusion)}</p>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
                
            } catch (e) {
                // 純文字顯示
                container.innerHTML = `
                    <div class="summary-wrapper">
                        <div class="summary-header">
                            <div class="summary-icon">📋</div>
                            <h1 class="summary-title">文件摘要</h1>
                        </div>
                        <div class="summary-main-text">
                            <p>${escapeHtml(result).replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        // ============================================
        // 縮放模組
        // ============================================
        const Zoom = {
            in: function() {
                switch (AppState.currentFormat) {
                    case 'mindmap':
                        d3Svg.transition().duration(300).call(d3Zoom.scaleBy, 1.3);
                        break;
                    case 'flowchart':
                        AppState.flowchartZoom = Math.min(3, AppState.flowchartZoom * 1.2);
                        updateFlowchartTransform();
                        break;
                }
            },
            out: function() {
                switch (AppState.currentFormat) {
                    case 'mindmap':
                        d3Svg.transition().duration(300).call(d3Zoom.scaleBy, 0.7);
                        break;
                    case 'flowchart':
                        AppState.flowchartZoom = Math.max(0.3, AppState.flowchartZoom * 0.8);
                        updateFlowchartTransform();
                        break;
                }
            },
            reset: function() {
                switch (AppState.currentFormat) {
                    case 'mindmap':
                        const container = document.getElementById('svgContainer');
                        d3Svg.transition().duration(500).call(
                            d3Zoom.transform,
                            d3.zoomIdentity.translate(container.clientWidth / 2, container.clientHeight / 2).scale(0.65)
                        );
                        break;
                    case 'flowchart':
                        AppState.flowchartZoom = 1;
                        AppState.flowchartPan = { x: 0, y: 0 };
                        updateFlowchartTransform();
                        break;
                }
            }
        };

        // ============================================
        // 下載模組
        // ============================================
        const Download = {
            svg: function() {
                let svgEl;
                if (AppState.currentFormat === 'mindmap') {
                    svgEl = d3Svg.node();
                } else {
                    svgEl = document.querySelector('#resultContainer svg');
                }
                if (!svgEl) { Toast.show('沒有可下載的內容', 'error'); return; }
                
                const clone = svgEl.cloneNode(true);
                clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                const blob = new Blob([clone.outerHTML], { type: 'image/svg+xml' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `visual-summary-${Date.now()}.svg`;
                link.click();
                URL.revokeObjectURL(link.href);
                Toast.show('SVG 已下載', 'success');
            },
            png: function() {
                let svgEl;
                if (AppState.currentFormat === 'mindmap') {
                    svgEl = d3Svg.node();
                } else {
                    svgEl = document.querySelector('#resultContainer svg');
                }
                if (!svgEl) { Toast.show('沒有可下載的內容', 'error'); return; }
                
                const svgData = new XMLSerializer().serializeToString(svgEl);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    const scale = 2;
                    canvas.width = (img.width || 1200) * scale;
                    canvas.height = (img.height || 800) * scale;
                    ctx.fillStyle = '#0a0f1a';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `visual-summary-${Date.now()}.png`;
                    link.click();
                    Toast.show('PNG 已下載', 'success');
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
            }
        };

        // ============================================
        // 右鍵選單
        // ============================================
        function showContextMenu(x, y) {
            const menu = document.getElementById('contextMenu');
            const mw = 180, mh = 250;
            if (x + mw > window.innerWidth) x = window.innerWidth - mw - 10;
            if (y + mh > window.innerHeight) y = window.innerHeight - mh - 10;
            if (x < 10) x = 10;
            if (y < 10) y = 10;
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
        }
        
        // 手機版編輯選單
        function showMobileEditMenu() {
            if (!AppState.selectedNode) {
                Toast.show('請先點擊選取一個節點', 'warning');
                return;
            }
            // 在螢幕中央顯示選單
            const x = window.innerWidth / 2 - 90;
            const y = window.innerHeight / 2 - 125;
            showContextMenu(x, y);
        }

        // ============================================
        // Modal
        // ============================================
        const Modal = {
            open: function(title, subtitle, defaultValue) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalSubtitle').textContent = subtitle;
                document.getElementById('modalInput').value = defaultValue || '';
                document.getElementById('modalOverlay').classList.add('show');
                setTimeout(() => {
                    const input = document.getElementById('modalInput');
                    input.focus();
                    input.select();
                }, 100);
            },
            close: function() {
                document.getElementById('modalOverlay').classList.remove('show');
                AppState.modalMode = '';
            },
            confirm: function() {
                const value = document.getElementById('modalInput').value.trim();
                if (!value) { Toast.show('請輸入內容', 'error'); return; }
                
                if (AppState.modalMode === 'edit' && AppState.selectedNode) {
                    AppState.selectedNode.name = value;
                    MindMap.render(AppState.mindmapData);
                    Toast.show('已更新', 'success');
                } else if (AppState.modalMode === 'add' && AppState.selectedNode) {
                    if (AppState.selectedNode._children) {
                        AppState.selectedNode.children = AppState.selectedNode._children;
                        AppState.selectedNode._children = null;
                    }
                    if (!AppState.selectedNode.children) AppState.selectedNode.children = [];
                    AppState.selectedNode.children.push({ name: value });
                    MindMap.render(AppState.mindmapData);
                    Toast.show('已新增', 'success');
                }
                this.close();
            }
        };

        // ============================================
        // Toast
        // ============================================
        const Toast = {
            show: function(msg, type = 'success', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const icons = { success: '✅', error: '❌', warning: '⚠️' };
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type] || 'ℹ️'}</span>
                    <span class="toast-title">${msg}</span>
                `;
                container.appendChild(toast);
                
                requestAnimationFrame(() => toast.classList.add('show'));
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        };

        // ============================================
        // Loading
        // ============================================
        const Loading = {
            show: function(text = '處理中...', subtext = '') {
                document.getElementById('loadingText').textContent = text;
                document.getElementById('loadingStep').textContent = subtext;
                document.getElementById('loadingProgressBar').style.width = '0%';
                document.getElementById('loadingOverlay').classList.add('show');
            },
            hide: function() {
                document.getElementById('loadingOverlay').classList.remove('show');
            },
            updateProgress: function(percent) {
                document.getElementById('loadingProgressBar').style.width = percent + '%';
            }
        };

        // ============================================
        // 完成
        // ============================================
        console.log('🚀 AI Visual Summary v11 載入完成');
    </script>
</body>
</html>

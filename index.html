<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 文件視覺摘要生成器 v12</title>
    
    <!-- 外部函式庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================
           CSS 變數 - 主題配色系統
           ============================================ */
        :root {
            /* 霓虹科技主題（預設） */
            --primary: #00f5ff;
            --primary-dark: #00c4cc;
            --secondary: #bf00ff;
            --secondary-dark: #9900cc;
            --accent: #ff00aa;
            --accent-dark: #cc0088;
            --success: #00ff88;
            --warning: #ffaa00;
            --error: #ff4444;
            
            /* 背景色 */
            --bg-dark: #0a0e17;
            --bg-darker: #050810;
            --bg-card: rgba(15, 25, 45, 0.95);
            --bg-card-hover: rgba(20, 35, 60, 0.98);
            --bg-overlay: rgba(5, 8, 16, 0.9);
            
            /* 文字色 */
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            
            /* 邊框 */
            --border-color: rgba(0, 245, 255, 0.2);
            --border-glow: rgba(0, 245, 255, 0.5);
            
            /* 陰影 */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(0, 245, 255, 0.3);
            
            /* 圓角 */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 30px;
            
            /* 過渡 */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            /* 字體 */
            --font-main: 'Noto Sans TC', 'Noto Sans JP', 'Noto Sans SC', sans-serif;
            --font-display: 'Orbitron', 'Rajdhani', sans-serif;
            
            /* 側邊欄寬度 */
            --sidebar-width: 380px;
            --sidebar-width-tablet: 320px;
        }

        /* 深海藍主題 */
        [data-theme="ocean"] {
            --primary: #00b4d8;
            --primary-dark: #0096c7;
            --secondary: #48cae4;
            --secondary-dark: #00b4d8;
            --accent: #90e0ef;
            --bg-dark: #03071e;
            --bg-darker: #010409;
            --bg-card: rgba(3, 7, 30, 0.95);
        }

        /* 日落橙主題 */
        [data-theme="sunset"] {
            --primary: #ff6b35;
            --primary-dark: #e85d2c;
            --secondary: #f7c59f;
            --secondary-dark: #efa870;
            --accent: #ffbe0b;
            --bg-dark: #1a0f0a;
            --bg-darker: #0d0705;
            --bg-card: rgba(26, 15, 10, 0.95);
        }

        /* 森林綠主題 */
        [data-theme="forest"] {
            --primary: #2d6a4f;
            --primary-dark: #1b4332;
            --secondary: #40916c;
            --secondary-dark: #2d6a4f;
            --accent: #95d5b2;
            --bg-dark: #081c15;
            --bg-darker: #040d0a;
            --bg-card: rgba(8, 28, 21, 0.95);
        }

        /* 淺色主題 */
        [data-theme="light"] {
            --primary: #0066cc;
            --primary-dark: #0052a3;
            --secondary: #6c5ce7;
            --secondary-dark: #5849be;
            --accent: #00cec9;
            --bg-dark: #f5f7fa;
            --bg-darker: #e8ecf1;
            --bg-card: rgba(255, 255, 255, 0.98);
            --bg-card-hover: rgba(248, 250, 252, 1);
            --text-primary: #1a1a2e;
            --text-secondary: rgba(26, 26, 46, 0.7);
            --text-muted: rgba(26, 26, 46, 0.5);
            --border-color: rgba(0, 102, 204, 0.2);
            --shadow-glow: 0 0 20px rgba(0, 102, 204, 0.15);
        }

        /* ============================================
           基礎重置與全域樣式
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-darker);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* 滾動條樣式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-dark), var(--secondary-dark));
        }

        /* 選取文字樣式 */
        ::selection {
            background: var(--primary);
            color: var(--bg-dark);
        }

        /* ============================================
           酷炫科技風啟動畫面
           ============================================ */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, #0d1525 0%, var(--bg-darker) 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        .splash-screen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        .splash-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(0, 245, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 245, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .splash-particles {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        .splash-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0.6;
            animation: particleFloat 8s infinite ease-in-out;
        }

        @keyframes particleFloat {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.6; }
            50% { transform: translateY(-100px) scale(1.5); opacity: 1; }
        }

        .splash-corner {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid var(--primary);
            opacity: 0.5;
        }

        .splash-corner.tl { top: 30px; left: 30px; border-right: none; border-bottom: none; }
        .splash-corner.tr { top: 30px; right: 30px; border-left: none; border-bottom: none; }
        .splash-corner.bl { bottom: 30px; left: 30px; border-right: none; border-top: none; }
        .splash-corner.br { bottom: 30px; right: 30px; border-left: none; border-top: none; }

        .splash-logo-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-ring-outer, .logo-ring-middle, .logo-ring-inner {
            position: absolute;
            border-radius: 50%;
            border: 2px solid transparent;
        }

        .logo-ring-outer {
            width: 200px;
            height: 200px;
            border-top-color: var(--primary);
            border-right-color: var(--primary);
            animation: spinRing 3s linear infinite;
        }

        .logo-ring-middle {
            width: 160px;
            height: 160px;
            border-bottom-color: var(--secondary);
            border-left-color: var(--secondary);
            animation: spinRing 2s linear infinite reverse;
        }

        .logo-ring-inner {
            width: 120px;
            height: 120px;
            border-top-color: var(--accent);
            border-right-color: var(--accent);
            animation: spinRing 1.5s linear infinite;
        }

        @keyframes spinRing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .logo-hexagon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: hexPulse 2s ease-in-out infinite;
            box-shadow: 0 0 30px var(--primary);
        }

        @keyframes hexPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px var(--primary); }
            50% { transform: scale(1.1); box-shadow: 0 0 50px var(--primary), 0 0 80px var(--secondary); }
        }

        .logo-icon {
            font-size: 32px;
            filter: drop-shadow(0 0 10px white);
        }

        .splash-scanline {
            position: absolute;
            width: 200px;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            animation: scanMove 2s ease-in-out infinite;
        }

        @keyframes scanMove {
            0%, 100% { top: 0; opacity: 0; }
            50% { top: 100%; opacity: 1; }
        }

        .splash-title {
            margin-top: 40px;
            font-family: var(--font-display);
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 8px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent), var(--primary));
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientFlow 3s ease infinite;
            text-shadow: 0 0 30px rgba(0, 245, 255, 0.5);
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .splash-subtitle {
            margin-top: 15px;
            font-size: 1rem;
            color: var(--text-secondary);
            letter-spacing: 4px;
        }

        .splash-progress {
            margin-top: 50px;
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .splash-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            animation: progressLoad 2.5s ease-out forwards;
            box-shadow: 0 0 10px var(--primary);
        }

        @keyframes progressLoad {
            0% { width: 0; }
            100% { width: 100%; }
        }

        .splash-status {
            margin-top: 20px;
            font-family: var(--font-display);
            font-size: 0.85rem;
            color: var(--primary);
            letter-spacing: 3px;
            animation: statusBlink 1s ease-in-out infinite;
        }

        @keyframes statusBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ============================================
           應用程式容器佈局
           ============================================ */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* ============================================
           側邊欄樣式
           ============================================ */
        .sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 100;
            transition: transform var(--transition-normal);
        }

        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(0, 245, 255, 0.05), transparent);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .logo-icon-small {
            font-size: 28px;
            filter: drop-shadow(0 0 8px var(--primary));
        }

        .logo-text {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version-badge {
            padding: 3px 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--bg-dark);
        }

        .app-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-close {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            transition: all var(--transition-fast);
        }

        .sidebar-close:hover {
            background: var(--error);
            border-color: var(--error);
        }

        /* ============================================
           側邊欄區塊樣式
           ============================================ */
        .section {
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
        }

        .section-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* 輸入框樣式 */
        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all var(--transition-fast);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 245, 255, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        /* 按鈕樣式 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--bg-dark);
            box-shadow: 0 4px 15px rgba(0, 245, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 245, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-sm);
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 0.85rem;
        }

        .btn-block {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 選擇按鈕組 */
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-group .btn {
            flex: 1;
            min-width: 0;
        }

        .btn-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-toggle.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            color: var(--bg-dark);
        }

        /* 選擇器樣式 */
        .select-field {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300f5ff' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
        }

        .select-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .select-field option {
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        /* ============================================
           檔案上傳區域（支援大檔案）
           ============================================ */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(0, 245, 255, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(0, 245, 255, 0.1);
            transform: scale(1.02);
        }

        .upload-area.has-file {
            border-color: var(--success);
            background: rgba(0, 255, 136, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px var(--primary));
        }

        .upload-text {
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .upload-formats {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .format-badge {
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .file-input {
            display: none;
        }

        /* 檔案資訊顯示 */
        .file-info {
            display: none;
            padding: 15px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: var(--radius-sm);
            margin-top: 15px;
        }

        .file-info.show {
            display: block;
        }

        .file-info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .file-info-icon {
            font-size: 24px;
        }

        .file-info-name {
            flex: 1;
            font-weight: 500;
            word-break: break-all;
        }

        .file-info-remove {
            width: 24px;
            height: 24px;
            background: rgba(255, 68, 68, 0.2);
            border: none;
            border-radius: 50%;
            color: var(--error);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .file-info-details {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* 大檔案進度條 */
        .file-progress {
            display: none;
            margin-top: 15px;
        }

        .file-progress.show {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--primary);
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* ============================================
           主內容區域
           ============================================ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
        }

        /* 工具列 */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
        }

        .toolbar-info {
            flex: 1;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* 結果容器 */
        .result-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: var(--bg-darker);
        }

        .result-wrapper {
            width: 100%;
            height: 100%;
            overflow: auto;
            padding: 30px;
        }

        /* 空狀態 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 25px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .empty-desc {
            font-size: 1rem;
            color: var(--text-muted);
            max-width: 400px;
        }

        /* 載入中狀態 */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg-overlay);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .loading-progress {
            margin-top: 15px;
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ============================================
           多語言選擇器
           ============================================ */
        .lang-selector {
            position: relative;
        }

        .lang-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all var(--transition-fast);
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
        }

        .lang-flag {
            font-size: 1.1rem;
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-fast);
            z-index: 1000;
            min-width: 150px;
        }

        .lang-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .lang-option:hover {
            background: rgba(0, 245, 255, 0.1);
        }

        .lang-option.active {
            background: rgba(0, 245, 255, 0.15);
            color: var(--primary);
        }

        /* ============================================
           匯出面板
           ============================================ */
        .export-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            max-width: 90vw;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        .export-panel.show {
            transform: translateX(0);
        }

        .export-panel-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .export-panel-backdrop.show {
            opacity: 1;
            visibility: visible;
        }

        .export-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .export-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .export-close {
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 18px;
            transition: all var(--transition-fast);
        }

        .export-close:hover {
            background: var(--error);
        }

        .export-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .export-section {
            margin-bottom: 25px;
        }

        .export-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .export-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .export-option:hover {
            background: rgba(0, 245, 255, 0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .export-option-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .export-option-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .export-option-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* 分享選項 */
        .share-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .share-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all var(--transition-fast);
        }

        .share-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .share-btn.twitter { --share-color: #1da1f2; }
        .share-btn.facebook { --share-color: #4267b2; }
        .share-btn.line { --share-color: #00c300; }
        .share-btn.linkedin { --share-color: #0077b5; }
        .share-btn.copy { --share-color: var(--primary); }

        .share-btn:hover {
            border-color: var(--share-color);
            color: var(--share-color);
        }

        /* 預覽區域 */
        .export-preview {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-md);
        }

        .export-preview-title {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .export-preview-image {
            width: 100%;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        /* ============================================
           AI 功能面板（講稿生成、Q&A）
           ============================================ */
        .ai-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            max-height: 500px;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            z-index: 1500;
            transform: translateY(100%);
            transition: transform var(--transition-normal);
            display: flex;
            flex-direction: column;
        }

        .ai-panel.show {
            transform: translateY(0);
        }

        .ai-panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: grab;
        }

        .ai-panel-header:active {
            cursor: grabbing;
        }

        .ai-panel-tabs {
            display: flex;
            gap: 5px;
        }

        .ai-panel-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-fast);
        }

        .ai-panel-tab:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .ai-panel-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--bg-dark);
        }

        .ai-panel-close {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 16px;
        }

        .ai-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* 講稿生成區 */
        .script-container {
            display: none;
        }

        .script-container.active {
            display: block;
        }

        .script-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .script-controls {
            display: flex;
            gap: 10px;
        }

        .script-content {
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-md);
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .script-slide {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .script-slide:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .script-slide-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .script-slide-number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: var(--bg-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .script-slide-text {
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        /* Q&A 區域 */
        .qa-container {
            display: none;
        }

        .qa-container.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .qa-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .qa-message {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            animation: messageIn 0.3s ease;
        }

        @keyframes messageIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .qa-message.user {
            flex-direction: row-reverse;
        }

        .qa-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .qa-message.assistant .qa-avatar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .qa-message.user .qa-avatar {
            background: rgba(255, 255, 255, 0.2);
        }

        .qa-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .qa-message.assistant .qa-bubble {
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid rgba(0, 245, 255, 0.2);
        }

        .qa-message.user .qa-bubble {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--bg-dark);
        }

        .qa-input-area {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .qa-input {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.95rem;
            resize: none;
        }

        .qa-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .qa-send {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: var(--radius-md);
            color: var(--bg-dark);
            cursor: pointer;
            font-size: 20px;
            transition: all var(--transition-fast);
        }

        .qa-send:hover {
            transform: scale(1.05);
        }

        .qa-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 建議問題 */
        .qa-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .qa-suggestion {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .qa-suggestion:hover {
            background: rgba(0, 245, 255, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ============================================
           語音功能（TTS）
           ============================================ */
        .tts-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }

        .tts-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: all var(--transition-fast);
        }

        .tts-play {
            background: linear-gradient(135deg, var(--success), #00cc6a);
            color: var(--bg-dark);
        }

        .tts-play.playing {
            background: linear-gradient(135deg, var(--warning), #cc8800);
        }

        .tts-stop {
            background: linear-gradient(135deg, var(--error), #cc3333);
            color: white;
        }

        .tts-progress {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .tts-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.1s linear;
        }

        .tts-time {
            font-size: 0.85rem;
            color: var(--text-muted);
            min-width: 80px;
            text-align: right;
        }

        .tts-settings {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .tts-setting {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tts-setting-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .tts-slider {
            width: 100px;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
        }

        .tts-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        /* 語音選擇器 */
        .voice-selector {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* ============================================
           新視覺化圖表 - 時間軸
           ============================================ */
        .timeline-container {
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .timeline {
            position: relative;
            padding-left: 50px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--primary), var(--secondary), var(--accent));
            border-radius: 2px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 40px;
            opacity: 0;
            transform: translateX(-20px);
            animation: timelineIn 0.5s ease forwards;
        }

        .timeline-item:nth-child(1) { animation-delay: 0.1s; }
        .timeline-item:nth-child(2) { animation-delay: 0.2s; }
        .timeline-item:nth-child(3) { animation-delay: 0.3s; }
        .timeline-item:nth-child(4) { animation-delay: 0.4s; }
        .timeline-item:nth-child(5) { animation-delay: 0.5s; }
        .timeline-item:nth-child(6) { animation-delay: 0.6s; }
        .timeline-item:nth-child(7) { animation-delay: 0.7s; }
        .timeline-item:nth-child(8) { animation-delay: 0.8s; }

        @keyframes timelineIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .timeline-dot {
            position: absolute;
            left: -38px;
            top: 5px;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 50%;
            border: 3px solid var(--bg-dark);
            box-shadow: 0 0 15px var(--primary);
        }

        .timeline-date {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .timeline-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .timeline-content {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.7;
            padding: 15px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border-left: 3px solid var(--primary);
        }

        /* ============================================
           新視覺化圖表 - 魚骨圖
           ============================================ */
        .fishbone-container {
            padding: 30px;
            overflow: auto;
        }

        .fishbone {
            display: flex;
            align-items: center;
            min-width: 1000px;
            padding: 50px 0;
        }

        .fishbone-spine {
            flex: 1;
            height: 6px;
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            position: relative;
            border-radius: 3px;
        }

        .fishbone-head {
            width: 120px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            clip-path: polygon(0 50%, 30% 0, 100% 0, 100% 100%, 30% 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding-left: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--bg-dark);
        }

        .fishbone-bone {
            position: absolute;
            width: 3px;
            background: var(--primary);
        }

        .fishbone-bone.top {
            top: -80px;
            height: 80px;
            transform-origin: bottom center;
            transform: rotate(-30deg);
        }

        .fishbone-bone.bottom {
            bottom: -80px;
            height: 80px;
            transform-origin: top center;
            transform: rotate(30deg);
        }

        .fishbone-label {
            position: absolute;
            padding: 10px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            white-space: nowrap;
            box-shadow: var(--shadow-md);
        }

        .fishbone-bone.top .fishbone-label {
            top: -10px;
            left: 10px;
            transform: rotate(30deg);
        }

        .fishbone-bone.bottom .fishbone-label {
            bottom: -10px;
            left: 10px;
            transform: rotate(-30deg);
        }

        /* ============================================
           新視覺化圖表 - 雷達圖
           ============================================ */
        .radar-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .radar-chart {
            position: relative;
            width: 400px;
            height: 400px;
        }

        .radar-svg {
            width: 100%;
            height: 100%;
        }

        .radar-grid {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 1;
        }

        .radar-axis {
            stroke: var(--border-color);
            stroke-width: 1;
        }

        .radar-area {
            fill: rgba(0, 245, 255, 0.2);
            stroke: var(--primary);
            stroke-width: 2;
            transition: all var(--transition-normal);
        }

        .radar-area:hover {
            fill: rgba(0, 245, 255, 0.3);
        }

        .radar-point {
            fill: var(--primary);
            stroke: var(--bg-dark);
            stroke-width: 2;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .radar-point:hover {
            r: 8;
            filter: drop-shadow(0 0 10px var(--primary));
        }

        .radar-label {
            font-size: 0.85rem;
            fill: var(--text-primary);
            text-anchor: middle;
        }

        .radar-value {
            font-size: 0.75rem;
            fill: var(--text-muted);
        }

        .radar-legend {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
        }

        .radar-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .radar-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* ============================================
           心智圖樣式
           ============================================ */
        .mindmap-container {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        .mindmap-svg {
            width: 100%;
            height: 100%;
        }

        .mindmap-node {
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mindmap-node:hover {
            filter: brightness(1.1);
        }

        .mindmap-node-bg {
            transition: all var(--transition-fast);
        }

        .mindmap-node-text {
            font-family: var(--font-main);
            fill: var(--text-primary);
            pointer-events: none;
        }

        .mindmap-link {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 2;
            transition: stroke var(--transition-fast);
        }

        /* ============================================
           簡報模式 - 30種動畫特效
           ============================================ */
        .presentation-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, #0d1525 0%, var(--bg-darker) 100%);
            z-index: 5000;
            display: none;
            flex-direction: column;
        }

        .presentation-overlay.show {
            display: flex;
        }

        .presentation-header {
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .presentation-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .presentation-counter {
            font-family: var(--font-display);
            font-size: 1rem;
            color: var(--primary);
        }

        .presentation-controls {
            display: flex;
            gap: 10px;
        }

        .presentation-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: hidden;
        }

        .presentation-slide {
            max-width: 900px;
            width: 100%;
            text-align: center;
        }

        /* 簡報元素 */
        .slide-title {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .slide-subtitle {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .slide-content {
            font-size: 1.2rem;
            color: var(--text-primary);
            line-height: 1.8;
            max-width: 700px;
            margin: 0 auto;
        }

        .slide-note {
            margin-top: 40px;
            padding: 20px;
            background: rgba(0, 245, 255, 0.1);
            border-left: 4px solid var(--primary);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            font-size: 1rem;
            color: var(--text-secondary);
            text-align: left;
        }

        /* 30種動畫效果 */
        .anim-fade-in { animation: animFadeIn 0.8s ease forwards; }
        .anim-fade-up { animation: animFadeUp 0.8s ease forwards; }
        .anim-fade-down { animation: animFadeDown 0.8s ease forwards; }
        .anim-fade-left { animation: animFadeLeft 0.8s ease forwards; }
        .anim-fade-right { animation: animFadeRight 0.8s ease forwards; }
        .anim-zoom-in { animation: animZoomIn 0.8s ease forwards; }
        .anim-zoom-out { animation: animZoomOut 0.8s ease forwards; }
        .anim-flip-x { animation: animFlipX 0.8s ease forwards; }
        .anim-flip-y { animation: animFlipY 0.8s ease forwards; }
        .anim-rotate-in { animation: animRotateIn 0.8s ease forwards; }
        .anim-bounce-in { animation: animBounceIn 0.8s ease forwards; }
        .anim-elastic { animation: animElastic 1s ease forwards; }
        .anim-swing { animation: animSwing 0.8s ease forwards; }
        .anim-slide-up { animation: animSlideUp 0.6s ease forwards; }
        .anim-slide-down { animation: animSlideDown 0.6s ease forwards; }
        .anim-slide-left { animation: animSlideLeft 0.6s ease forwards; }
        .anim-slide-right { animation: animSlideRight 0.6s ease forwards; }
        .anim-blur-in { animation: animBlurIn 0.8s ease forwards; }
        .anim-glow { animation: animGlow 0.8s ease forwards; }
        .anim-typewriter { animation: animTypewriter 2s steps(40) forwards; }
        .anim-wave { animation: animWave 1s ease forwards; }
        .anim-shake { animation: animShake 0.6s ease forwards; }
        .anim-pulse { animation: animPulse 0.8s ease forwards; }
        .anim-spiral { animation: animSpiral 1s ease forwards; }
        .anim-unfold { animation: animUnfold 0.8s ease forwards; }
        .anim-drop { animation: animDrop 0.6s ease forwards; }
        .anim-stretch { animation: animStretch 0.8s ease forwards; }
        .anim-glitch { animation: animGlitch 0.5s ease forwards; }
        .anim-neon { animation: animNeon 1s ease forwards; }
        .anim-particle { animation: animParticle 0.8s ease forwards; }

        @keyframes animFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes animFadeUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes animFadeDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes animFadeLeft { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes animFadeRight { from { opacity: 0; transform: translateX(-50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes animZoomIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes animZoomOut { from { opacity: 0; transform: scale(1.5); } to { opacity: 1; transform: scale(1); } }
        @keyframes animFlipX { from { opacity: 0; transform: perspective(400px) rotateX(90deg); } to { opacity: 1; transform: perspective(400px) rotateX(0); } }
        @keyframes animFlipY { from { opacity: 0; transform: perspective(400px) rotateY(90deg); } to { opacity: 1; transform: perspective(400px) rotateY(0); } }
        @keyframes animRotateIn { from { opacity: 0; transform: rotate(-180deg) scale(0.5); } to { opacity: 1; transform: rotate(0) scale(1); } }
        @keyframes animBounceIn { 
            0% { opacity: 0; transform: scale(0.3); }
            50% { transform: scale(1.1); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes animElastic {
            0% { opacity: 0; transform: scale(0); }
            55% { transform: scale(1.1); }
            70% { transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes animSwing {
            0% { opacity: 0; transform: rotate(-10deg); }
            50% { transform: rotate(5deg); }
            70% { transform: rotate(-3deg); }
            100% { opacity: 1; transform: rotate(0); }
        }
        @keyframes animSlideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes animSlideDown { from { opacity: 0; transform: translateY(-100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes animSlideLeft { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes animSlideRight { from { opacity: 0; transform: translateX(-100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes animBlurIn { from { opacity: 0; filter: blur(20px); } to { opacity: 1; filter: blur(0); } }
        @keyframes animGlow { 
            from { opacity: 0; text-shadow: 0 0 0 var(--primary); }
            to { opacity: 1; text-shadow: 0 0 30px var(--primary), 0 0 60px var(--secondary); }
        }
        @keyframes animTypewriter { from { width: 0; } to { width: 100%; } }
        @keyframes animWave {
            0% { opacity: 0; transform: translateY(20px) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(3deg); }
            100% { opacity: 1; transform: translateY(0) rotate(0); }
        }
        @keyframes animShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        @keyframes animPulse {
            0% { opacity: 0; transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes animSpiral {
            from { opacity: 0; transform: rotate(720deg) scale(0); }
            to { opacity: 1; transform: rotate(0) scale(1); }
        }
        @keyframes animUnfold {
            from { opacity: 0; transform: scaleY(0); transform-origin: top; }
            to { opacity: 1; transform: scaleY(1); }
        }
        @keyframes animDrop {
            0% { opacity: 0; transform: translateY(-200px); }
            60% { transform: translateY(20px); }
            80% { transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes animStretch {
            0% { opacity: 0; transform: scaleX(0); }
            60% { transform: scaleX(1.1); }
            100% { opacity: 1; transform: scaleX(1); }
        }
        @keyframes animGlitch {
            0% { opacity: 0; transform: translate(0); filter: hue-rotate(0); }
            20% { transform: translate(-5px, 5px); filter: hue-rotate(90deg); }
            40% { transform: translate(5px, -5px); filter: hue-rotate(180deg); }
            60% { transform: translate(-3px, -3px); filter: hue-rotate(270deg); }
            80% { transform: translate(3px, 3px); filter: hue-rotate(360deg); }
            100% { opacity: 1; transform: translate(0); filter: hue-rotate(0); }
        }
        @keyframes animNeon {
            0% { opacity: 0; text-shadow: none; }
            50% { text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary), 0 0 30px var(--primary); }
            100% { opacity: 1; text-shadow: 0 0 5px var(--primary), 0 0 10px var(--secondary); }
        }
        @keyframes animParticle {
            0% { opacity: 0; transform: scale(0) rotate(0); filter: blur(10px); }
            100% { opacity: 1; transform: scale(1) rotate(360deg); filter: blur(0); }
        }

        /* 進度條 */
        .presentation-progress {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        .presentation-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        /* ============================================
           9宮格資訊圖表
           ============================================ */
        .infographic-container {
            padding: 30px;
        }

        .infographic-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .infographic-title-card {
            grid-column: 2;
            grid-row: 1;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--radius-lg);
            padding: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .infographic-title-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--bg-dark);
        }

        .infographic-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 20px;
            transition: all var(--transition-normal);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .infographic-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 245, 255, 0.2);
        }

        .infographic-card-number {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--bg-dark);
        }

        .infographic-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-right: 30px;
        }

        .infographic-card-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* ============================================
           重點摘要
           ============================================ */
        .summary-container {
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }

        .summary-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .summary-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .summary-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .summary-main-text {
            font-size: 1.1rem;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 40px;
            padding: 25px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
        }

        .summary-points {
            margin-bottom: 40px;
        }

        .summary-points-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-point {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 15px;
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .summary-point:hover {
            border-color: var(--primary);
        }

        .summary-point-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            cursor: pointer;
        }

        .summary-point-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--bg-dark);
            flex-shrink: 0;
        }

        .summary-point-title {
            flex: 1;
            font-weight: 500;
        }

        .summary-point-toggle {
            color: var(--text-muted);
            transition: transform var(--transition-fast);
        }

        .summary-point.expanded .summary-point-toggle {
            transform: rotate(180deg);
        }

        .summary-point-detail {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--transition-normal);
        }

        .summary-point.expanded .summary-point-detail {
            max-height: 300px;
        }

        .summary-point-detail-content {
            padding: 0 20px 20px 67px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .summary-conclusion {
            display: flex;
            gap: 15px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.1), rgba(191, 0, 255, 0.1));
            border-radius: var(--radius-md);
        }

        .summary-conclusion-icon {
            font-size: 28px;
        }

        .summary-conclusion p {
            font-size: 1rem;
            color: var(--text-primary);
            line-height: 1.7;
        }

        /* ============================================
           流程圖
           ============================================ */
        .flowchart-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            cursor: grab;
        }

        .flowchart-container:active {
            cursor: grabbing;
        }

        .flowchart-wrapper {
            min-width: 100%;
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 50px;
        }

        .mermaid {
            font-family: var(--font-main);
        }

        /* ============================================
           SWOT 分析樣式
           ============================================ */
        .swot-container {
            padding: 30px;
            max-width: 900px;
            margin: 0 auto;
        }

        .swot-title {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .swot-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .swot-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 20px;
            border: 2px solid;
            transition: all var(--transition-normal);
        }

        .swot-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .swot-strengths { border-color: #00ff88; }
        .swot-weaknesses { border-color: #ff6b6b; }
        .swot-opportunities { border-color: #00d4ff; }
        .swot-threats { border-color: #ffaa00; }

        .swot-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .swot-card-icon {
            font-size: 24px;
        }

        .swot-card-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .swot-strengths .swot-card-title { color: #00ff88; }
        .swot-weaknesses .swot-card-title { color: #ff6b6b; }
        .swot-opportunities .swot-card-title { color: #00d4ff; }
        .swot-threats .swot-card-title { color: #ffaa00; }

        .swot-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .swot-list li {
            padding: 8px 0 8px 20px;
            position: relative;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .swot-list li::before {
            content: '•';
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .swot-strengths .swot-list li::before { color: #00ff88; }
        .swot-weaknesses .swot-list li::before { color: #ff6b6b; }
        .swot-opportunities .swot-list li::before { color: #00d4ff; }
        .swot-threats .swot-list li::before { color: #ffaa00; }

        .swot-summary {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.1), rgba(191, 0, 255, 0.1));
            border-radius: var(--radius-md);
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .swot-summary-icon {
            font-size: 24px;
        }

        .swot-summary p {
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        @media (max-width: 600px) {
            .swot-grid {
                grid-template-columns: 1fr;
            }
            
            .swot-container {
                padding: 15px;
            }
            
            .swot-title {
                font-size: 1.4rem;
            }
        }

        /* ============================================
           輸出格式選擇器 - 美化版
           ============================================ */
        .format-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .format-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            min-height: 70px;
        }

        .format-item:hover {
            background: rgba(0, 245, 255, 0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .format-item.active {
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.2), rgba(191, 0, 255, 0.2));
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.3);
        }

        .format-item-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .format-item-name {
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
            color: var(--text-secondary);
        }

        .format-item.active .format-item-name {
            color: var(--primary);
        }

        /* ============================================
           響應式設計
           ============================================ */
        /* 手機版頭部 */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            padding: 0 12px;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-logo-icon {
            font-size: 22px;
        }

        .mobile-logo-text {
            font-family: var(--font-display);
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--primary);
        }

        .mobile-toggle {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
        }

        .sidebar-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .sidebar-backdrop.show {
            opacity: 1;
        }

        /* 平板版 */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: var(--sidebar-width-tablet);
            }

            .slide-title {
                font-size: 2.5rem;
            }

            .infographic-grid {
                gap: 15px;
            }
            
            .format-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
        }

        /* 手機版 */
        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }

            .app-container {
                padding-top: 56px;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 90vw;
                max-width: 380px;
                transform: translateX(-100%);
                z-index: 1001;
                overflow-y: auto;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .sidebar-close {
                display: flex;
            }

            .sidebar-backdrop {
                display: block;
            }
            
            .sidebar-header {
                padding: 20px 15px;
            }
            
            .sidebar-content {
                padding: 15px;
            }
            
            .section {
                margin-bottom: 20px;
            }
            
            .section-header {
                margin-bottom: 12px;
            }
            
            /* 輸出格式 - 手機版 2x4 網格 */
            .format-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .format-item {
                padding: 10px 6px;
                min-height: 65px;
            }
            
            .format-item-icon {
                font-size: 22px;
                margin-bottom: 4px;
            }
            
            .format-item-name {
                font-size: 0.7rem;
            }
            
            /* 上傳區域 */
            .upload-area {
                padding: 20px 15px;
            }
            
            .upload-icon {
                font-size: 36px;
                margin-bottom: 10px;
            }
            
            .upload-text {
                font-size: 0.9rem;
            }
            
            .upload-formats {
                gap: 6px;
                margin-top: 12px;
            }
            
            .format-badge {
                padding: 3px 8px;
                font-size: 0.7rem;
            }

            .main-content {
                width: 100%;
            }

            .toolbar {
                padding: 8px 12px;
                gap: 8px;
            }

            .result-wrapper {
                padding: 15px;
            }

            .slide-title {
                font-size: 1.6rem;
            }

            .slide-subtitle {
                font-size: 1.1rem;
            }

            .slide-content {
                font-size: 0.95rem;
            }

            .infographic-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .infographic-title-card {
                grid-column: 1 / -1;
                padding: 20px;
            }
            
            .infographic-title-text {
                font-size: 1.2rem;
            }

            .timeline {
                padding-left: 35px;
            }

            .timeline::before {
                left: 12px;
            }

            .timeline-dot {
                left: -30px;
                width: 14px;
                height: 14px;
            }
            
            .timeline-content {
                padding: 12px;
                font-size: 0.9rem;
            }

            .ai-panel {
                height: 70vh;
                max-height: none;
            }

            .export-panel {
                width: 100%;
            }
            
            /* 語言選擇器 */
            .lang-selector {
                margin-bottom: 15px !important;
            }
            
            .lang-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            /* 按鈕調整 */
            .btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .btn-sm {
                padding: 7px 12px;
                font-size: 0.8rem;
            }
            
            /* 輸入框 */
            .input-field, .select-field {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
        }

        /* 小手機 */
        @media (max-width: 480px) {
            .format-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            
            .format-item {
                padding: 8px 4px;
                min-height: 60px;
            }
            
            .format-item-icon {
                font-size: 20px;
            }
            
            .format-item-name {
                font-size: 0.65rem;
            }
            
            .infographic-grid {
                grid-template-columns: 1fr;
            }

            .radar-chart {
                width: 280px;
                height: 280px;
            }

            .tts-controls {
                flex-wrap: wrap;
            }

            .tts-progress {
                order: 3;
                width: 100%;
                margin-top: 10px;
            }
            
            .sidebar {
                width: 100vw;
                max-width: 100%;
            }
        }
        
        /* 超小螢幕 */
        @media (max-width: 360px) {
            .format-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .sidebar-header {
                padding: 15px 12px;
            }
            
            .app-logo {
                gap: 8px;
            }
            
            .logo-text {
                font-size: 1.1rem;
            }
        }

        /* Toast 通知 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 350px;
        }

        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--error); }
        .toast.warning { border-color: var(--warning); }

        .toast-icon { font-size: 20px; }
        .toast-message { flex: 1; font-size: 0.9rem; }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Modal 對話框 */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 8000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- 酷炫科技風啟動畫面 -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-grid"></div>
        <div class="splash-particles" id="splashParticles"></div>
        
        <div class="splash-corner tl"></div>
        <div class="splash-corner tr"></div>
        <div class="splash-corner bl"></div>
        <div class="splash-corner br"></div>
        
        <div class="splash-logo-container">
            <div class="logo-ring-outer"></div>
            <div class="logo-ring-middle"></div>
            <div class="logo-ring-inner"></div>
            <div class="splash-scanline"></div>
            <div class="logo-hexagon">
                <span class="logo-icon">📊</span>
            </div>
        </div>
        
        <div class="splash-title">AI VISUAL SUMMARY</div>
        <div class="splash-subtitle" data-i18n="splash.subtitle">心智圖 · 資訊圖表 · 流程圖 · 重點摘要</div>
        
        <div class="splash-progress"></div>
        <div class="splash-status" data-i18n="splash.status">INITIALIZING SYSTEM...</div>
    </div>

    <!-- 手機版背景遮罩 -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- 手機版頭部 -->
    <header class="mobile-header" id="mobileHeader">
        <div class="mobile-logo">
            <span class="mobile-logo-icon">📊</span>
            <span class="mobile-logo-text">AI Visual Summary</span>
        </div>
        <button class="mobile-toggle" id="mobileToggle" title="開啟選單">☰</button>
    </header>

    <!-- 匯出面板背景遮罩 -->
    <div class="export-panel-backdrop" id="exportBackdrop"></div>

    <!-- 匯出面板 -->
    <div class="export-panel" id="exportPanel">
        <div class="export-header">
            <div class="export-title">
                <span>📤</span>
                <span data-i18n="export.title">匯出與分享</span>
            </div>
            <button class="export-close" id="exportClose">✕</button>
        </div>
        <div class="export-content">
            <div class="export-section">
                <div class="export-section-title" data-i18n="export.format">匯出格式</div>
                <div class="export-options">
                    <div class="export-option" data-format="png">
                        <div class="export-option-icon">🖼️</div>
                        <div class="export-option-name">PNG</div>
                        <div class="export-option-desc" data-i18n="export.png.desc">高畫質圖片</div>
                    </div>
                    <div class="export-option" data-format="svg">
                        <div class="export-option-icon">📐</div>
                        <div class="export-option-name">SVG</div>
                        <div class="export-option-desc" data-i18n="export.svg.desc">向量圖形</div>
                    </div>
                    <div class="export-option" data-format="pdf">
                        <div class="export-option-icon">📄</div>
                        <div class="export-option-name">PDF</div>
                        <div class="export-option-desc" data-i18n="export.pdf.desc">文件格式</div>
                    </div>
                    <div class="export-option" data-format="json">
                        <div class="export-option-icon">📋</div>
                        <div class="export-option-name">JSON</div>
                        <div class="export-option-desc" data-i18n="export.json.desc">原始資料</div>
                    </div>
                </div>
            </div>
            
            <div class="export-section">
                <div class="export-section-title" data-i18n="export.share">分享</div>
                <div class="share-options">
                    <button class="share-btn twitter" data-share="twitter">
                        <span>🐦</span> Twitter
                    </button>
                    <button class="share-btn facebook" data-share="facebook">
                        <span>📘</span> Facebook
                    </button>
                    <button class="share-btn line" data-share="line">
                        <span>💬</span> LINE
                    </button>
                    <button class="share-btn linkedin" data-share="linkedin">
                        <span>💼</span> LinkedIn
                    </button>
                    <button class="share-btn copy" data-share="copy">
                        <span>📋</span> <span data-i18n="export.copyLink">複製連結</span>
                    </button>
                </div>
            </div>
            
            <div class="export-preview" id="exportPreview" style="display: none;">
                <div class="export-preview-title" data-i18n="export.preview">預覽</div>
                <img class="export-preview-image" id="exportPreviewImage" alt="Preview">
            </div>
        </div>
    </div>

    <!-- AI 功能面板 -->
    <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
            <div class="ai-panel-tabs">
                <button class="ai-panel-tab active" data-tab="script">
                    📝 <span data-i18n="ai.script">講稿生成</span>
                </button>
                <button class="ai-panel-tab" data-tab="qa">
                    💬 <span data-i18n="ai.qa">Q&A 問答</span>
                </button>
            </div>
            <button class="ai-panel-close" id="aiPanelClose">✕</button>
        </div>
        <div class="ai-panel-content">
            <!-- 講稿生成 -->
            <div class="script-container active" id="scriptContainer">
                <div class="script-header">
                    <h3 data-i18n="ai.scriptTitle">自動生成講稿</h3>
                    <div class="script-controls">
                        <button class="btn btn-sm btn-secondary" id="regenerateScript">
                            🔄 <span data-i18n="ai.regenerate">重新生成</span>
                        </button>
                        <button class="btn btn-sm btn-secondary" id="copyScript">
                            📋 <span data-i18n="ai.copy">複製</span>
                        </button>
                    </div>
                </div>
                
                <!-- TTS 控制 -->
                <div class="tts-controls">
                    <button class="tts-btn tts-play" id="ttsPlay" title="播放">▶</button>
                    <button class="tts-btn tts-stop" id="ttsStop" title="停止">⏹</button>
                    <div class="tts-progress" id="ttsProgress">
                        <div class="tts-progress-fill" id="ttsProgressFill"></div>
                    </div>
                    <div class="tts-time" id="ttsTime">00:00 / 00:00</div>
                </div>
                <div class="tts-settings">
                    <div class="tts-setting">
                        <span class="tts-setting-label" data-i18n="tts.speed">語速</span>
                        <input type="range" class="tts-slider" id="ttsSpeed" min="0.5" max="2" step="0.1" value="1">
                    </div>
                    <div class="tts-setting">
                        <span class="tts-setting-label" data-i18n="tts.voice">語音</span>
                        <select class="voice-selector" id="voiceSelector"></select>
                    </div>
                </div>
                
                <div class="script-content" id="scriptContent">
                    <p class="empty-text" data-i18n="ai.scriptEmpty">尚未生成講稿，請先上傳文件並選擇輸出格式。</p>
                </div>
            </div>
            
            <!-- Q&A 問答 -->
            <div class="qa-container" id="qaContainer">
                <div class="qa-suggestions" id="qaSuggestions">
                    <button class="qa-suggestion" data-i18n="qa.suggestion1">這份文件的主要內容是什麼？</button>
                    <button class="qa-suggestion" data-i18n="qa.suggestion2">請列出關鍵重點</button>
                    <button class="qa-suggestion" data-i18n="qa.suggestion3">有哪些注意事項？</button>
                </div>
                <div class="qa-messages" id="qaMessages"></div>
                <div class="qa-input-area">
                    <textarea class="qa-input" id="qaInput" placeholder="輸入問題..." rows="2" data-i18n-placeholder="qa.placeholder"></textarea>
                    <button class="qa-send" id="qaSend">➤</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal 對話框 -->
    <div class="modal-backdrop" id="modalBackdrop">
        <div class="modal" id="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <button class="modal-close" id="modalClose">✕</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- 應用程式容器 -->
    <div class="app-container">
        <!-- 側邊欄 -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-close" id="sidebarClose">✕</button>
            
            <header class="sidebar-header">
                <div class="app-logo">
                    <span class="logo-icon-small">📊</span>
                    <span class="logo-text">AI Visual Summary</span>
                    <span class="version-badge">v12</span>
                </div>
                <p class="app-subtitle" data-i18n="app.subtitle">心智圖 · 資訊圖表 · 流程圖 · 重點摘要</p>
            </header>
            
            <div class="sidebar-content">
                <!-- 語言選擇 -->
                <div class="lang-selector" style="margin-bottom: 15px;">
                    <button class="lang-btn" id="langBtn">
                        <span class="lang-flag" id="langFlag">🇹🇼</span>
                        <span id="langName">繁體中文</span>
                        <span>▼</span>
                    </button>
                    <div class="lang-dropdown" id="langDropdown">
                        <div class="lang-option active" data-lang="zh-TW">
                            <span class="lang-flag">🇹🇼</span>
                            <span>繁體中文</span>
                        </div>
                        <div class="lang-option" data-lang="zh-CN">
                            <span class="lang-flag">🇨🇳</span>
                            <span>简体中文</span>
                        </div>
                        <div class="lang-option" data-lang="en">
                            <span class="lang-flag">🇺🇸</span>
                            <span>English</span>
                        </div>
                        <div class="lang-option" data-lang="ja">
                            <span class="lang-flag">🇯🇵</span>
                            <span>日本語</span>
                        </div>
                    </div>
                </div>
                
                <!-- API 設定 -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-icon">🔑</div>
                        <div>
                            <div class="section-title" data-i18n="api.title">API 設定</div>
                            <div class="section-desc" data-i18n="api.desc">輸入 Gemini API Key</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="password" class="input-field" id="apiKey" placeholder="AIza..." data-i18n-placeholder="api.placeholder">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-secondary" id="toggleApiKey">👁️</button>
                        <button class="btn btn-sm btn-secondary" id="testApiKey" data-i18n="api.test">測試連線</button>
                    </div>
                </section>
                
                <!-- 檔案上傳（支援大檔案+圖片） -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-icon">📁</div>
                        <div>
                            <div class="section-title" data-i18n="upload.title">上傳文件</div>
                            <div class="section-desc" data-i18n="upload.desc">PDF / Word / 圖片 / 文字（最大 100MB）</div>
                        </div>
                    </div>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">📄</div>
                        <div class="upload-text" data-i18n="upload.text">點擊或拖曳文件到此處</div>
                        <div class="upload-hint" data-i18n="upload.hint">支援圖片 OCR 與大檔案處理</div>
                        <div class="upload-formats">
                            <span class="format-badge">PDF</span>
                            <span class="format-badge">DOC</span>
                            <span class="format-badge">DOCX</span>
                            <span class="format-badge">PNG</span>
                            <span class="format-badge">JPG</span>
                            <span class="format-badge">TXT</span>
                        </div>
                        <input type="file" class="file-input" id="fileInput" accept=".pdf,.doc,.docx,.txt,.md,.png,.jpg,.jpeg,.gif,.webp,.bmp">
                    </div>
                    
                    <!-- 檔案進度（大檔案） -->
                    <div class="file-progress" id="fileProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">處理中... 0%</div>
                    </div>
                    
                    <!-- 檔案資訊 -->
                    <div class="file-info" id="fileInfo">
                        <div class="file-info-header">
                            <span class="file-info-icon" id="fileIcon">📄</span>
                            <span class="file-info-name" id="fileName"></span>
                            <button class="file-info-remove" id="fileRemove">✕</button>
                        </div>
                        <div class="file-info-details">
                            <span id="fileSize"></span>
                            <span id="fileChars"></span>
                        </div>
                    </div>
                </section>
                
                <!-- 輸出格式 - 網格版 -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-icon">🎨</div>
                        <div>
                            <div class="section-title" data-i18n="format.title">輸出格式</div>
                            <div class="section-desc" data-i18n="format.desc">選擇視覺化呈現方式</div>
                        </div>
                    </div>
                    <div class="format-grid" id="formatGrid">
                        <div class="format-item active" data-format="mindmap">
                            <div class="format-item-icon">🧠</div>
                            <div class="format-item-name" data-i18n="format.mindmap">心智圖</div>
                        </div>
                        <div class="format-item" data-format="flowchart">
                            <div class="format-item-icon">📊</div>
                            <div class="format-item-name" data-i18n="format.flowchart">流程圖</div>
                        </div>
                        <div class="format-item" data-format="infographic">
                            <div class="format-item-icon">📰</div>
                            <div class="format-item-name" data-i18n="format.infographic">資訊圖表</div>
                        </div>
                        <div class="format-item" data-format="summary">
                            <div class="format-item-icon">📝</div>
                            <div class="format-item-name" data-i18n="format.summary">重點摘要</div>
                        </div>
                        <div class="format-item" data-format="timeline">
                            <div class="format-item-icon">📅</div>
                            <div class="format-item-name" data-i18n="format.timeline">時間軸</div>
                        </div>
                        <div class="format-item" data-format="fishbone">
                            <div class="format-item-icon">🐟</div>
                            <div class="format-item-name" data-i18n="format.fishbone">魚骨圖</div>
                        </div>
                        <div class="format-item" data-format="radar">
                            <div class="format-item-icon">📡</div>
                            <div class="format-item-name" data-i18n="format.radar">雷達圖</div>
                        </div>
                        <div class="format-item" data-format="swot">
                            <div class="format-item-icon">🎯</div>
                            <div class="format-item-name">SWOT</div>
                        </div>
                    </div>
                </section>
                
                <!-- 主題配色 -->
                <section class="section">
                    <div class="section-header">
                        <div class="section-icon">🎭</div>
                        <div>
                            <div class="section-title" data-i18n="theme.title">主題配色</div>
                        </div>
                    </div>
                    <select class="select-field" id="themeSelect">
                        <option value="neon" data-i18n="theme.neon">霓虹科技</option>
                        <option value="ocean" data-i18n="theme.ocean">深海藍</option>
                        <option value="sunset" data-i18n="theme.sunset">日落橙</option>
                        <option value="forest" data-i18n="theme.forest">森林綠</option>
                        <option value="light" data-i18n="theme.light">淺色模式</option>
                    </select>
                </section>
                
                <!-- 生成按鈕 -->
                <button class="btn btn-primary btn-block" id="generateBtn" style="margin-top: 15px;">
                    ✨ <span data-i18n="generate">生成視覺摘要</span>
                </button>
            </div>
        </aside>

        <!-- 主內容區域 -->
        <main class="main-content">
            <!-- 工具列 -->
            <div class="toolbar" id="toolbar">
                <div class="toolbar-group">
                    <button class="btn btn-sm btn-icon btn-secondary" id="zoomIn" title="放大">🔍+</button>
                    <button class="btn btn-sm btn-icon btn-secondary" id="zoomOut" title="縮小">🔍-</button>
                    <button class="btn btn-sm btn-icon btn-secondary" id="zoomReset" title="重置">↺</button>
                </div>
                
                <div class="toolbar-divider"></div>
                
                <div class="toolbar-group" id="mindmapTools" style="display: none;">
                    <button class="btn btn-sm btn-secondary" id="presentationBtn">🎬 <span data-i18n="toolbar.presentation">簡報</span></button>
                    <button class="btn btn-sm btn-secondary" id="layoutBtn">📐 <span data-i18n="toolbar.layout">佈局</span></button>
                </div>
                
                <div class="toolbar-info" id="toolbarInfo" data-i18n="toolbar.hint">選擇文件並生成視覺摘要</div>
                
                <div class="toolbar-group">
                    <button class="btn btn-sm btn-secondary" id="aiBtn">🤖 AI</button>
                    <button class="btn btn-sm btn-secondary" id="exportBtn">📤 <span data-i18n="toolbar.export">匯出</span></button>
                    <button class="btn btn-sm btn-secondary" id="settingsBtn">⚙️</button>
                </div>
            </div>
            
            <!-- 結果容器 -->
            <div class="result-container" id="resultContainer">
                <div class="result-wrapper" id="resultWrapper">
                    <!-- 空狀態 -->
                    <div class="empty-state" id="emptyState">
                        <div class="empty-icon">📊</div>
                        <div class="empty-title" data-i18n="empty.title">開始視覺化您的文件</div>
                        <div class="empty-desc" data-i18n="empty.desc">上傳 PDF、Word 或文字文件，AI 將自動分析並生成視覺摘要</div>
                    </div>
                    
                    <!-- 心智圖容器 -->
                    <div class="mindmap-container" id="mindmapContainer" style="display: none;"></div>
                    
                    <!-- 流程圖容器 -->
                    <div class="flowchart-container" id="flowchartContainer" style="display: none;">
                        <div class="flowchart-wrapper">
                            <div class="mermaid" id="flowchartMermaid"></div>
                        </div>
                    </div>
                    
                    <!-- 資訊圖表容器 -->
                    <div class="infographic-container" id="infographicContainer" style="display: none;"></div>
                    
                    <!-- 摘要容器 -->
                    <div class="summary-container" id="summaryContainer" style="display: none;"></div>
                    
                    <!-- 時間軸容器 -->
                    <div class="timeline-container" id="timelineContainer" style="display: none;"></div>
                    
                    <!-- 魚骨圖容器 -->
                    <div class="fishbone-container" id="fishboneContainer" style="display: none;"></div>
                    
                    <!-- 雷達圖容器 -->
                    <div class="radar-container" id="radarContainer" style="display: none;"></div>
                    
                    <!-- SWOT 分析容器 -->
                    <div class="swot-container" id="swotContainer" style="display: none;"></div>
                </div>
                
                <!-- 載入中 -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text" id="loadingText" data-i18n="loading.analyzing">正在分析文件...</div>
                    <div class="loading-progress">
                        <div class="loading-progress-fill" id="loadingProgressFill"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 簡報模式 -->
    <div class="presentation-overlay" id="presentationOverlay">
        <div class="presentation-header">
            <div class="presentation-info">
                <button class="btn btn-sm btn-secondary" id="presentationExit">✕ <span data-i18n="presentation.exit">離開</span></button>
                <span class="presentation-counter" id="presentationCounter">1 / 1</span>
            </div>
            <div class="presentation-controls">
                <button class="btn btn-sm btn-secondary" id="presentationPrev">◀ <span data-i18n="presentation.prev">上一頁</span></button>
                <button class="btn btn-sm btn-secondary" id="presentationNext"><span data-i18n="presentation.next">下一頁</span> ▶</button>
                <button class="btn btn-sm btn-secondary" id="presentationTTS">🔊 <span data-i18n="presentation.tts">朗讀</span></button>
            </div>
        </div>
        <div class="presentation-content" id="presentationContent">
            <div class="presentation-slide" id="presentationSlide"></div>
        </div>
        <div class="presentation-progress">
            <div class="presentation-progress-fill" id="presentationProgressFill"></div>
        </div>
    </div>

    <script>
        // ============================================
        // 全域狀態管理
        // ============================================
        const AppState = {
            apiKey: '',
            fileContent: '',
            fileName: '',
            fileSize: 0,
            currentFormat: 'mindmap',
            currentTheme: 'neon',
            currentLang: 'zh-TW',
            generatedData: null,
            presentationSlides: [],
            presentationIndex: 0,
            isMobile: window.innerWidth <= 768,
            ttsUtterance: null,
            ttsPlaying: false
        };

        // ============================================
        // 多語言系統
        // ============================================
        const I18n = {
            currentLang: 'zh-TW',
            
            translations: {
                'zh-TW': {
                    // 啟動畫面
                    'splash.subtitle': '心智圖 · 資訊圖表 · 流程圖 · 重點摘要',
                    'splash.status': '系統初始化中...',
                    
                    // 應用程式
                    'app.subtitle': '心智圖 · 資訊圖表 · 流程圖 · 重點摘要',
                    
                    // API 設定
                    'api.title': 'API 設定',
                    'api.desc': '輸入 Gemini API Key',
                    'api.placeholder': '請輸入您的 API Key...',
                    'api.test': '測試連線',
                    'api.success': 'API 連線成功！',
                    'api.error': 'API 連線失敗',
                    
                    // 檔案上傳
                    'upload.title': '上傳文件',
                    'upload.desc': '支援 PDF / Word / TXT（最大 100MB）',
                    'upload.text': '點擊或拖曳文件到此處',
                    'upload.hint': '支援大檔案處理（最大 100MB）',
                    'upload.processing': '處理中...',
                    'upload.success': '文件已載入',
                    'upload.error': '文件載入失敗',
                    'upload.tooLarge': '檔案過大（最大 100MB）',
                    
                    // 輸出格式
                    'format.title': '輸出格式',
                    'format.desc': '選擇視覺化呈現方式',
                    'format.mindmap': '心智圖',
                    'format.flowchart': '流程圖',
                    'format.infographic': '資訊圖表',
                    'format.summary': '重點摘要',
                    'format.timeline': '時間軸',
                    'format.fishbone': '魚骨圖',
                    'format.radar': '雷達圖',
                    
                    // 主題
                    'theme.title': '主題配色',
                    'theme.neon': '霓虹科技',
                    'theme.ocean': '深海藍',
                    'theme.sunset': '日落橙',
                    'theme.forest': '森林綠',
                    'theme.light': '淺色模式',
                    
                    // 生成
                    'generate': '生成視覺摘要',
                    'generating': '生成中...',
                    
                    // 工具列
                    'toolbar.presentation': '簡報',
                    'toolbar.layout': '佈局',
                    'toolbar.export': '匯出',
                    'toolbar.hint': '選擇文件並生成視覺摘要',
                    
                    // 空狀態
                    'empty.title': '開始視覺化您的文件',
                    'empty.desc': '上傳 PDF、Word 或文字文件，AI 將自動分析並生成視覺摘要',
                    
                    // 載入
                    'loading.analyzing': '正在分析文件...',
                    'loading.generating': '正在生成視覺化...',
                    
                    // 匯出
                    'export.title': '匯出與分享',
                    'export.format': '匯出格式',
                    'export.share': '分享',
                    'export.copyLink': '複製連結',
                    'export.preview': '預覽',
                    'export.png.desc': '高畫質圖片',
                    'export.svg.desc': '向量圖形',
                    'export.pdf.desc': '文件格式',
                    'export.json.desc': '原始資料',
                    'export.success': '匯出成功！',
                    'export.copied': '已複製到剪貼簿！',
                    
                    // AI 功能
                    'ai.script': '講稿生成',
                    'ai.qa': 'Q&A 問答',
                    'ai.scriptTitle': '自動生成講稿',
                    'ai.regenerate': '重新生成',
                    'ai.copy': '複製',
                    'ai.scriptEmpty': '尚未生成講稿，請先上傳文件並選擇輸出格式。',
                    
                    // TTS
                    'tts.speed': '語速',
                    'tts.voice': '語音',
                    
                    // Q&A
                    'qa.placeholder': '輸入問題...',
                    'qa.suggestion1': '這份文件的主要內容是什麼？',
                    'qa.suggestion2': '請列出關鍵重點',
                    'qa.suggestion3': '有哪些注意事項？',
                    
                    // 簡報
                    'presentation.exit': '離開',
                    'presentation.prev': '上一頁',
                    'presentation.next': '下一頁',
                    'presentation.tts': '朗讀',
                    
                    // 錯誤訊息
                    'error.noApiKey': '請先輸入 API Key',
                    'error.noFile': '請先上傳文件',
                    'error.generation': '生成失敗，請重試'
                },
                
                'zh-CN': {
                    'splash.subtitle': '思维导图 · 信息图表 · 流程图 · 重点摘要',
                    'splash.status': '系统初始化中...',
                    'app.subtitle': '思维导图 · 信息图表 · 流程图 · 重点摘要',
                    'api.title': 'API 设置',
                    'api.desc': '输入 Gemini API Key',
                    'api.placeholder': '请输入您的 API Key...',
                    'api.test': '测试连接',
                    'api.success': 'API 连接成功！',
                    'api.error': 'API 连接失败',
                    'upload.title': '上传文件',
                    'upload.desc': '支持 PDF / Word / TXT（最大 100MB）',
                    'upload.text': '点击或拖拽文件到此处',
                    'upload.hint': '支持大文件处理（最大 100MB）',
                    'upload.processing': '处理中...',
                    'upload.success': '文件已加载',
                    'upload.error': '文件加载失败',
                    'upload.tooLarge': '文件过大（最大 100MB）',
                    'format.title': '输出格式',
                    'format.desc': '选择可视化呈现方式',
                    'format.mindmap': '思维导图',
                    'format.flowchart': '流程图',
                    'format.infographic': '信息图表',
                    'format.summary': '重点摘要',
                    'format.timeline': '时间轴',
                    'format.fishbone': '鱼骨图',
                    'format.radar': '雷达图',
                    'theme.title': '主题配色',
                    'theme.neon': '霓虹科技',
                    'theme.ocean': '深海蓝',
                    'theme.sunset': '日落橙',
                    'theme.forest': '森林绿',
                    'theme.light': '浅色模式',
                    'generate': '生成可视化摘要',
                    'generating': '生成中...',
                    'toolbar.presentation': '演示',
                    'toolbar.layout': '布局',
                    'toolbar.export': '导出',
                    'toolbar.hint': '选择文件并生成可视化摘要',
                    'empty.title': '开始可视化您的文件',
                    'empty.desc': '上传 PDF、Word 或文本文件，AI 将自动分析并生成可视化摘要',
                    'loading.analyzing': '正在分析文件...',
                    'loading.generating': '正在生成可视化...',
                    'export.title': '导出与分享',
                    'export.format': '导出格式',
                    'export.share': '分享',
                    'export.copyLink': '复制链接',
                    'export.preview': '预览',
                    'export.png.desc': '高清图片',
                    'export.svg.desc': '矢量图形',
                    'export.pdf.desc': '文档格式',
                    'export.json.desc': '原始数据',
                    'export.success': '导出成功！',
                    'export.copied': '已复制到剪贴板！',
                    'ai.script': '讲稿生成',
                    'ai.qa': 'Q&A 问答',
                    'ai.scriptTitle': '自动生成讲稿',
                    'ai.regenerate': '重新生成',
                    'ai.copy': '复制',
                    'ai.scriptEmpty': '尚未生成讲稿，请先上传文件并选择输出格式。',
                    'tts.speed': '语速',
                    'tts.voice': '语音',
                    'qa.placeholder': '输入问题...',
                    'qa.suggestion1': '这份文件的主要内容是什么？',
                    'qa.suggestion2': '请列出关键重点',
                    'qa.suggestion3': '有哪些注意事项？',
                    'presentation.exit': '退出',
                    'presentation.prev': '上一页',
                    'presentation.next': '下一页',
                    'presentation.tts': '朗读',
                    'error.noApiKey': '请先输入 API Key',
                    'error.noFile': '请先上传文件',
                    'error.generation': '生成失败，请重试'
                },
                
                'en': {
                    'splash.subtitle': 'Mind Map · Infographic · Flowchart · Summary',
                    'splash.status': 'INITIALIZING SYSTEM...',
                    'app.subtitle': 'Mind Map · Infographic · Flowchart · Summary',
                    'api.title': 'API Settings',
                    'api.desc': 'Enter Gemini API Key',
                    'api.placeholder': 'Enter your API Key...',
                    'api.test': 'Test Connection',
                    'api.success': 'API connection successful!',
                    'api.error': 'API connection failed',
                    'upload.title': 'Upload Document',
                    'upload.desc': 'Supports PDF / Word / TXT (Max 100MB)',
                    'upload.text': 'Click or drag file here',
                    'upload.hint': 'Large file processing supported (Max 100MB)',
                    'upload.processing': 'Processing...',
                    'upload.success': 'File loaded',
                    'upload.error': 'Failed to load file',
                    'upload.tooLarge': 'File too large (Max 100MB)',
                    'format.title': 'Output Format',
                    'format.desc': 'Choose visualization style',
                    'format.mindmap': 'Mind Map',
                    'format.flowchart': 'Flowchart',
                    'format.infographic': 'Infographic',
                    'format.summary': 'Summary',
                    'format.timeline': 'Timeline',
                    'format.fishbone': 'Fishbone',
                    'format.radar': 'Radar Chart',
                    'theme.title': 'Theme',
                    'theme.neon': 'Neon Tech',
                    'theme.ocean': 'Ocean Blue',
                    'theme.sunset': 'Sunset Orange',
                    'theme.forest': 'Forest Green',
                    'theme.light': 'Light Mode',
                    'generate': 'Generate Visual Summary',
                    'generating': 'Generating...',
                    'toolbar.presentation': 'Present',
                    'toolbar.layout': 'Layout',
                    'toolbar.export': 'Export',
                    'toolbar.hint': 'Upload file and generate visual summary',
                    'empty.title': 'Visualize Your Documents',
                    'empty.desc': 'Upload PDF, Word or text files. AI will analyze and generate visual summaries automatically.',
                    'loading.analyzing': 'Analyzing document...',
                    'loading.generating': 'Generating visualization...',
                    'export.title': 'Export & Share',
                    'export.format': 'Export Format',
                    'export.share': 'Share',
                    'export.copyLink': 'Copy Link',
                    'export.preview': 'Preview',
                    'export.png.desc': 'High quality image',
                    'export.svg.desc': 'Vector graphics',
                    'export.pdf.desc': 'Document format',
                    'export.json.desc': 'Raw data',
                    'export.success': 'Export successful!',
                    'export.copied': 'Copied to clipboard!',
                    'ai.script': 'Script Generator',
                    'ai.qa': 'Q&A Chat',
                    'ai.scriptTitle': 'Auto-generated Script',
                    'ai.regenerate': 'Regenerate',
                    'ai.copy': 'Copy',
                    'ai.scriptEmpty': 'No script generated yet. Please upload a file first.',
                    'tts.speed': 'Speed',
                    'tts.voice': 'Voice',
                    'qa.placeholder': 'Enter your question...',
                    'qa.suggestion1': 'What is the main content of this document?',
                    'qa.suggestion2': 'List the key points',
                    'qa.suggestion3': 'What are the important notes?',
                    'presentation.exit': 'Exit',
                    'presentation.prev': 'Previous',
                    'presentation.next': 'Next',
                    'presentation.tts': 'Read Aloud',
                    'error.noApiKey': 'Please enter API Key first',
                    'error.noFile': 'Please upload a file first',
                    'error.generation': 'Generation failed, please try again'
                },
                
                'ja': {
                    'splash.subtitle': 'マインドマップ · インフォグラフィック · フローチャート · 要約',
                    'splash.status': 'システム初期化中...',
                    'app.subtitle': 'マインドマップ · インフォグラフィック · フローチャート · 要約',
                    'api.title': 'API 設定',
                    'api.desc': 'Gemini API Key を入力',
                    'api.placeholder': 'API Key を入力してください...',
                    'api.test': '接続テスト',
                    'api.success': 'API 接続成功！',
                    'api.error': 'API 接続失敗',
                    'upload.title': 'ファイルアップロード',
                    'upload.desc': 'PDF / Word / TXT 対応（最大 100MB）',
                    'upload.text': 'クリックまたはドラッグしてファイルをアップロード',
                    'upload.hint': '大容量ファイル対応（最大 100MB）',
                    'upload.processing': '処理中...',
                    'upload.success': 'ファイル読み込み完了',
                    'upload.error': 'ファイル読み込み失敗',
                    'upload.tooLarge': 'ファイルが大きすぎます（最大 100MB）',
                    'format.title': '出力形式',
                    'format.desc': '可視化の表示方法を選択',
                    'format.mindmap': 'マインドマップ',
                    'format.flowchart': 'フローチャート',
                    'format.infographic': 'インフォグラフィック',
                    'format.summary': '要約',
                    'format.timeline': 'タイムライン',
                    'format.fishbone': '魚骨図',
                    'format.radar': 'レーダーチャート',
                    'theme.title': 'テーマカラー',
                    'theme.neon': 'ネオンテック',
                    'theme.ocean': 'オーシャンブルー',
                    'theme.sunset': 'サンセットオレンジ',
                    'theme.forest': 'フォレストグリーン',
                    'theme.light': 'ライトモード',
                    'generate': 'ビジュアル要約を生成',
                    'generating': '生成中...',
                    'toolbar.presentation': 'プレゼン',
                    'toolbar.layout': 'レイアウト',
                    'toolbar.export': 'エクスポート',
                    'toolbar.hint': 'ファイルを選択してビジュアル要約を生成',
                    'empty.title': 'ドキュメントを可視化',
                    'empty.desc': 'PDF、Word、テキストファイルをアップロードすると、AIが自動で分析してビジュアル要約を生成します',
                    'loading.analyzing': 'ドキュメントを分析中...',
                    'loading.generating': '可視化を生成中...',
                    'export.title': 'エクスポート＆共有',
                    'export.format': 'エクスポート形式',
                    'export.share': '共有',
                    'export.copyLink': 'リンクをコピー',
                    'export.preview': 'プレビュー',
                    'export.png.desc': '高画質画像',
                    'export.svg.desc': 'ベクター画像',
                    'export.pdf.desc': 'ドキュメント形式',
                    'export.json.desc': '生データ',
                    'export.success': 'エクスポート成功！',
                    'export.copied': 'クリップボードにコピーしました！',
                    'ai.script': 'スクリプト生成',
                    'ai.qa': 'Q&A チャット',
                    'ai.scriptTitle': '自動生成スクリプト',
                    'ai.regenerate': '再生成',
                    'ai.copy': 'コピー',
                    'ai.scriptEmpty': 'スクリプトがまだ生成されていません。先にファイルをアップロードしてください。',
                    'tts.speed': '速度',
                    'tts.voice': '音声',
                    'qa.placeholder': '質問を入力...',
                    'qa.suggestion1': 'このドキュメントの主な内容は何ですか？',
                    'qa.suggestion2': '重要なポイントをリストアップしてください',
                    'qa.suggestion3': '注意事項はありますか？',
                    'presentation.exit': '終了',
                    'presentation.prev': '前へ',
                    'presentation.next': '次へ',
                    'presentation.tts': '読み上げ',
                    'error.noApiKey': '先に API Key を入力してください',
                    'error.noFile': '先にファイルをアップロードしてください',
                    'error.generation': '生成に失敗しました。もう一度お試しください'
                }
            },
            
            t(key) {
                return this.translations[this.currentLang]?.[key] || this.translations['zh-TW'][key] || key;
            },
            
            setLang(lang) {
                this.currentLang = lang;
                AppState.currentLang = lang;
                this.updateUI();
            },
            
            updateUI() {
                // 更新所有有 data-i18n 屬性的元素
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    el.textContent = this.t(key);
                });
                
                // 更新 placeholder
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    el.placeholder = this.t(key);
                });
            }
        };

        // ============================================
        // 工具函數
        // ============================================
        const Utils = {
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },
            
            getRandomAnimation() {
                const animations = [
                    'anim-fade-in', 'anim-fade-up', 'anim-fade-down', 'anim-fade-left', 'anim-fade-right',
                    'anim-zoom-in', 'anim-zoom-out', 'anim-flip-x', 'anim-flip-y', 'anim-rotate-in',
                    'anim-bounce-in', 'anim-elastic', 'anim-swing', 'anim-slide-up', 'anim-slide-down',
                    'anim-slide-left', 'anim-slide-right', 'anim-blur-in', 'anim-glow', 'anim-wave',
                    'anim-shake', 'anim-pulse', 'anim-spiral', 'anim-unfold', 'anim-drop',
                    'anim-stretch', 'anim-glitch', 'anim-neon', 'anim-particle'
                ];
                return animations[Math.floor(Math.random() * animations.length)];
            },
            
            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
        };

        // ============================================
        // Toast 通知系統
        // ============================================
        const Toast = {
            show(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️'
                };
                
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <span class="toast-message">${message}</span>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(50px)';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },
            
            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            warning(message) { this.show(message, 'warning'); },
            info(message) { this.show(message, 'info'); }
        };

        // ============================================
        // Loading 控制
        // ============================================
        const Loading = {
            show(text = '') {
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingText');
                if (text) textEl.textContent = text;
                overlay.classList.add('show');
            },
            
            hide() {
                document.getElementById('loadingOverlay').classList.remove('show');
            },
            
            setProgress(percent) {
                document.getElementById('loadingProgressFill').style.width = percent + '%';
            },
            
            setText(text) {
                document.getElementById('loadingText').textContent = text;
            }
        };

        // ============================================
        // 大檔案處理器（支援 100MB + 圖片）
        // ============================================
        const FileProcessor = {
            MAX_FILE_SIZE: 100 * 1024 * 1024, // 100MB
            CHUNK_SIZE: 1024 * 1024, // 1MB chunks for processing
            imageFile: null, // 儲存圖片檔案以供 Vision API 使用
            isImageMode: false, // 是否為圖片模式
            
            async processFile(file) {
                // 檢查檔案大小
                if (file.size > this.MAX_FILE_SIZE) {
                    throw new Error(I18n.t('upload.tooLarge'));
                }
                
                const ext = file.name.split('.').pop().toLowerCase();
                
                // 重置狀態
                this.imageFile = null;
                this.isImageMode = false;
                
                // 顯示進度
                this.showProgress(true);
                this.updateProgress(0, I18n.t('upload.processing'));
                
                try {
                    let content = '';
                    
                    // 判斷檔案類型
                    if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp'].includes(ext)) {
                        // 圖片檔案 - 使用 Vision API
                        content = await this.processImage(file);
                    } else if (ext === 'pdf') {
                        content = await this.processPDF(file);
                    } else if (['doc', 'docx'].includes(ext)) {
                        content = await this.processWord(file);
                    } else if (['txt', 'md'].includes(ext)) {
                        content = await this.processText(file);
                    } else {
                        throw new Error('不支援的檔案格式');
                    }
                    
                    this.showProgress(false);
                    return content;
                    
                } catch (error) {
                    this.showProgress(false);
                    throw error;
                }
            },
            
            async processImage(file) {
                this.updateProgress(30, '準備圖片...');
                this.imageFile = file;
                this.isImageMode = true;
                this.updateProgress(100, '圖片已準備完成！');
                
                // 返回特殊標記，表示這是圖片模式
                return `[IMAGE_FILE:${file.name}]`;
            },
            
            async processPDF(file) {
                const arrayBuffer = await this.readFileAsArrayBuffer(file);
                
                this.updateProgress(20, '載入 PDF...');
                
                // 設定 PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                try {
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    const totalPages = pdf.numPages;
                    let text = '';
                    
                    for (let i = 1; i <= totalPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        text += pageText + '\n\n';
                        
                        // 更新進度
                        const progress = 20 + Math.floor((i / totalPages) * 60);
                        this.updateProgress(progress, `處理頁面 ${i}/${totalPages}...`);
                    }
                    
                    text = text.trim();
                    
                    // 如果提取的文字太少，可能是掃描版 PDF，改用圖片模式
                    if (text.length < 100) {
                        this.updateProgress(85, '偵測到掃描版 PDF，切換到圖片模式...');
                        
                        // 將 PDF 轉換為圖片
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        const firstPage = await pdf.getPage(1);
                        const viewport = firstPage.getViewport({ scale: 2.0 });
                        
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await firstPage.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                        
                        // 轉換為 blob
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        this.imageFile = new File([blob], 'pdf_page.png', { type: 'image/png' });
                        this.isImageMode = true;
                        
                        this.updateProgress(100, '已轉換為圖片模式！');
                        return `[SCANNED_PDF:${file.name}]`;
                    }
                    
                    this.updateProgress(100, '完成！');
                    return text;
                    
                } catch (error) {
                    console.error('PDF 處理錯誤:', error);
                    throw new Error('PDF 處理失敗，請確認檔案格式正確');
                }
            },
            
            async processWord(file) {
                const arrayBuffer = await this.readFileAsArrayBuffer(file);
                
                this.updateProgress(30, '載入 Word 文件...');
                
                try {
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    this.updateProgress(100, '完成！');
                    return result.value;
                } catch (error) {
                    console.error('Word 處理錯誤:', error);
                    throw new Error('Word 文件處理失敗');
                }
            },
            
            async processText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const progress = Math.floor((e.loaded / e.total) * 100);
                            this.updateProgress(progress, `讀取中... ${progress}%`);
                        }
                    };
                    
                    reader.onload = (e) => {
                        this.updateProgress(100, '完成！');
                        resolve(e.target.result);
                    };
                    
                    reader.onerror = () => reject(new Error('讀取檔案失敗'));
                    reader.readAsText(file);
                });
            },
            
            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const progress = Math.floor((e.loaded / e.total) * 20);
                            this.updateProgress(progress, `讀取檔案... ${progress}%`);
                        }
                    };
                    
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = () => reject(new Error('讀取檔案失敗'));
                    reader.readAsArrayBuffer(file);
                });
            },
            
            showProgress(show) {
                const el = document.getElementById('fileProgress');
                if (show) {
                    el.classList.add('show');
                } else {
                    el.classList.remove('show');
                }
            },
            
            updateProgress(percent, text) {
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('progressText').textContent = text || `處理中... ${percent}%`;
            },
            
            // 取得圖片的 Base64 編碼
            async getImageBase64() {
                if (!this.imageFile) return null;
                return await Utils.fileToBase64(this.imageFile);
            }
        };

        // ============================================
        // Gemini API 服務（支援 Vision）
        // ============================================
        const GeminiAPI = {
            baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
            
            async call(prompt, apiKey) {
                const response = await fetch(`${this.baseUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 8192
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API 錯誤: ${response.status}`);
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            },
            
            // Vision API 呼叫（支援圖片）
            async callWithImage(prompt, imageBase64, mimeType, apiKey) {
                const response = await fetch(`${this.baseUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inline_data: {
                                        mime_type: mimeType || 'image/png',
                                        data: imageBase64
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 8192
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API 錯誤: ${response.status} - ${errorData.error?.message || ''}`);
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            },
            
            async testConnection(apiKey) {
                try {
                    await this.call('Hello', apiKey);
                    return true;
                } catch {
                    return false;
                }
            }
        };

        // ============================================
        // AI 內容生成器（支援圖片模式）
        // ============================================
        const ContentGenerator = {
            // 取得語言提示詞
            getLangPrompt() {
                const lang = AppState.currentLang;
                return {
                    'zh-TW': '請使用繁體中文回應',
                    'zh-CN': '请使用简体中文回应',
                    'en': 'Please respond in English',
                    'ja': '日本語で回答してください'
                }[lang] || '請使用繁體中文回應';
            },
            
            // 通用的 API 呼叫方法（自動判斷是否使用圖片模式）
            async callAPI(prompt, apiKey) {
                if (FileProcessor.isImageMode && FileProcessor.imageFile) {
                    const imageBase64 = await FileProcessor.getImageBase64();
                    const mimeType = FileProcessor.imageFile.type || 'image/png';
                    return await GeminiAPI.callWithImage(prompt, imageBase64, mimeType, apiKey);
                } else {
                    return await GeminiAPI.call(prompt, apiKey);
                }
            },
            
            async generateMindmap(content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。${isImageMode ? '分析這張圖片的內容' : '分析以下文件內容'}，生成心智圖結構。請以 JSON 格式回應，格式如下：
{
  "title": "主標題",
  "children": [
    {
      "name": "分支1",
      "children": [
        { "name": "子項目1" },
        { "name": "子項目2" }
      ]
    }
  ]
}

${isImageMode ? '' : `文件內容：\n${content.substring(0, 15000)}`}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.parseJSON(response);
            },
            
            async generateFlowchart(content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。${isImageMode ? '分析這張圖片' : '分析以下文件'}，生成 Mermaid 流程圖語法。只回傳 Mermaid 語法，不要其他說明。
使用 graph TD 格式，節點文字要簡潔（10字以內）。

${isImageMode ? '' : `文件內容：\n${content.substring(0, 15000)}`}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.extractMermaid(response);
            },
            
            async generateInfographic(content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。${isImageMode ? '分析這張圖片' : '分析以下文件'}，生成9宮格資訊圖表內容。請以 JSON 格式回應：
{
  "title": "主標題",
  "cards": [
    { "title": "卡片標題1", "content": "內容描述（50字以內）" },
    { "title": "卡片標題2", "content": "內容描述" },
    ... (共8張卡片)
  ]
}

${isImageMode ? '' : `文件內容：\n${content.substring(0, 15000)}`}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.parseJSON(response);
            },
            
            async generateSummary(content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。${isImageMode ? '分析這張圖片' : '分析以下文件'}，生成結構化摘要。請以 JSON 格式回應：
{
  "title": "文件標題",
  "overview": "整體概述（100字以內）",
  "keyPoints": [
    { "title": "重點1標題", "detail": "詳細說明" },
    { "title": "重點2標題", "detail": "詳細說明" },
    ... (5-8個重點)
  ],
  "conclusion": "結論與建議"
}

${isImageMode ? '' : `文件內容：\n${content.substring(0, 15000)}`}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.parseJSON(response);
            },
            
            async generateTimeline(content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。${isImageMode ? '分析這張圖片' : '分析以下文件'}，提取時間順序或流程步驟，生成時間軸資料。請以 JSON 格式回應：
{
  "title": "時間軸標題",
  "events": [
    { "date": "時間點或階段1", "title": "事件標題", "content": "詳細描述" },
    { "date": "時間點或階段2", "title": "事件標題", "content": "詳細描述" },
    ... (5-10個事件)
  ]
}

如果沒有明確時間，請用「階段一」「階段二」或「步驟1」「步驟2」等表示。

${isImageMode ? '' : `文件內容：\n${content.substring(0, 15000)}`}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.parseJSON(response);
            },
            
            async generateFishbone(content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。${isImageMode ? '分析這張圖片' : '分析以下文件'}，用魚骨圖（因果分析圖）的方式整理。請以 JSON 格式回應：
{
  "effect": "主要結果/問題/目標",
  "categories": [
    { "name": "類別1（如：人員）", "causes": ["原因1", "原因2"] },
    { "name": "類別2（如：方法）", "causes": ["原因1", "原因2"] },
    { "name": "類別3（如：設備）", "causes": ["原因1", "原因2"] },
    { "name": "類別4（如：材料）", "causes": ["原因1", "原因2"] },
    { "name": "類別5（如：環境）", "causes": ["原因1", "原因2"] },
    { "name": "類別6（如：管理）", "causes": ["原因1", "原因2"] }
  ]
}

${isImageMode ? '' : `文件內容：\n${content.substring(0, 15000)}`}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.parseJSON(response);
            },
            
            async generateRadar(content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。${isImageMode ? '分析這張圖片' : '分析以下文件'}，提取可量化或比較的維度，生成雷達圖資料。請以 JSON 格式回應：
{
  "title": "雷達圖標題",
  "dimensions": [
    { "name": "維度1", "value": 85, "maxValue": 100 },
    { "name": "維度2", "value": 70, "maxValue": 100 },
    { "name": "維度3", "value": 90, "maxValue": 100 },
    { "name": "維度4", "value": 60, "maxValue": 100 },
    { "name": "維度5", "value": 75, "maxValue": 100 },
    { "name": "維度6", "value": 80, "maxValue": 100 }
  ]
}

根據內容推測各維度的相對數值（0-100）。

${isImageMode ? '' : `文件內容：\n${content.substring(0, 15000)}`}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.parseJSON(response);
            },
            
            async generateSWOT(content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。${isImageMode ? '分析這張圖片' : '分析以下文件'}，進行 SWOT 分析。請以 JSON 格式回應：
{
  "title": "SWOT 分析標題",
  "strengths": ["優勢1", "優勢2", "優勢3"],
  "weaknesses": ["劣勢1", "劣勢2", "劣勢3"],
  "opportunities": ["機會1", "機會2", "機會3"],
  "threats": ["威脅1", "威脅2", "威脅3"],
  "summary": "總結建議"
}

${isImageMode ? '' : `文件內容：\n${content.substring(0, 15000)}`}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.parseJSON(response);
            },
            
            async generateScript(content, data, format, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。根據${isImageMode ? '這張圖片' : '以下文件內容'}和視覺化結構，生成簡報講稿。
講稿要自然流暢，適合口語表達，每個重點約50-100字。

請以 JSON 格式回應：
{
  "slides": [
    { "title": "開場", "script": "開場白講稿..." },
    { "title": "重點1", "script": "講稿內容..." },
    { "title": "重點2", "script": "講稿內容..." },
    ... 
    { "title": "總結", "script": "結尾講稿..." }
  ]
}

${isImageMode ? '' : `文件內容摘要：\n${content.substring(0, 5000)}`}

視覺化結構：
${JSON.stringify(data).substring(0, 3000)}`;

                const response = await this.callAPI(prompt, apiKey);
                return this.parseJSON(response);
            },
            
            async askQuestion(question, content, apiKey) {
                const langPrompt = this.getLangPrompt();
                const isImageMode = FileProcessor.isImageMode;
                
                const prompt = `${langPrompt}。根據${isImageMode ? '這張圖片' : '以下文件內容'}回答問題。回答要簡潔明瞭。

${isImageMode ? '' : `文件內容：\n${content.substring(0, 10000)}`}

問題：${question}`;

                return await this.callAPI(prompt, apiKey);
            },
            
            parseJSON(text) {
                // 嘗試提取 JSON
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        return JSON.parse(jsonMatch[0]);
                    } catch (e) {
                        console.error('JSON 解析錯誤:', e);
                    }
                }
                throw new Error('無法解析 AI 回應');
            },
            
            extractMermaid(text) {
                // 移除 markdown 標記
                let mermaid = text.replace(/```mermaid\n?/gi, '').replace(/```\n?/g, '').trim();
                
                // 確保有 graph 開頭
                if (!mermaid.startsWith('graph') && !mermaid.startsWith('flowchart')) {
                    mermaid = 'graph TD\n' + mermaid;
                }
                
                return mermaid;
            }
        };

        // ============================================
        // 心智圖渲染器（修復版）
        // ============================================
        const MindmapRenderer = {
            currentLayout: 'radial',
            svg: null,
            zoom: null,
            data: null,
            
            layouts: {
                radial: { name: '放射狀', icon: '🎯' },
                tree: { name: '樹狀圖', icon: '🌳' },
                horizontal: { name: '水平展開', icon: '↔️' },
                vertical: { name: '垂直展開', icon: '↕️' },
                force: { name: '力導向', icon: '🔮' }
            },
            
            render(data, containerId) {
                this.data = data;
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                container.style.display = 'block';
                
                const width = container.clientWidth || 800;
                const height = Math.max(container.clientHeight || 600, 500);
                
                this.svg = d3.select(`#${containerId}`)
                    .append('svg')
                    .attr('class', 'mindmap-svg')
                    .attr('width', '100%')
                    .attr('height', '100%')
                    .attr('viewBox', `0 0 ${width} ${height}`);
                
                // 添加漸層定義
                const defs = this.svg.append('defs');
                this.addGradients(defs);
                
                const g = this.svg.append('g').attr('class', 'mindmap-content');
                
                // 添加縮放功能
                this.zoom = d3.zoom()
                    .scaleExtent([0.2, 3])
                    .on('zoom', (event) => {
                        g.attr('transform', event.transform);
                    });
                
                this.svg.call(this.zoom);
                
                // 根據佈局渲染
                this.renderLayout(data, g, width, height);
            },
            
            addGradients(defs) {
                // 主要漸層
                const gradient1 = defs.append('linearGradient')
                    .attr('id', 'nodeGradient1')
                    .attr('x1', '0%').attr('y1', '0%')
                    .attr('x2', '100%').attr('y2', '100%');
                gradient1.append('stop').attr('offset', '0%').attr('stop-color', '#00f5ff');
                gradient1.append('stop').attr('offset', '100%').attr('stop-color', '#bf00ff');
                
                const gradient2 = defs.append('linearGradient')
                    .attr('id', 'nodeGradient2')
                    .attr('x1', '0%').attr('y1', '0%')
                    .attr('x2', '100%').attr('y2', '100%');
                gradient2.append('stop').attr('offset', '0%').attr('stop-color', '#ff6b6b');
                gradient2.append('stop').attr('offset', '100%').attr('stop-color', '#feca57');
                
                // 發光濾鏡
                const filter = defs.append('filter')
                    .attr('id', 'glow')
                    .attr('x', '-50%').attr('y', '-50%')
                    .attr('width', '200%').attr('height', '200%');
                filter.append('feGaussianBlur')
                    .attr('stdDeviation', '3')
                    .attr('result', 'coloredBlur');
                const feMerge = filter.append('feMerge');
                feMerge.append('feMergeNode').attr('in', 'coloredBlur');
                feMerge.append('feMergeNode').attr('in', 'SourceGraphic');
            },
            
            renderLayout(data, g, width, height) {
                g.selectAll('*').remove();
                
                switch (this.currentLayout) {
                    case 'radial':
                        this.renderRadial(data, g, width, height);
                        break;
                    case 'tree':
                        this.renderTree(data, g, width, height);
                        break;
                    case 'horizontal':
                        this.renderHorizontal(data, g, width, height);
                        break;
                    case 'vertical':
                        this.renderVertical(data, g, width, height);
                        break;
                    case 'force':
                        this.renderForce(data, g, width, height);
                        break;
                }
            },
            
            // 修復的放射狀佈局
            renderRadial(data, g, width, height) {
                const root = d3.hierarchy(data);
                const nodeCount = root.descendants().length;
                const radius = Math.min(width, height) / 2 - 100;
                
                // 計算每層的半徑
                const maxDepth = d3.max(root.descendants(), d => d.depth);
                const depthRadius = radius / (maxDepth + 1);
                
                // 使用 cluster 佈局
                const tree = d3.cluster()
                    .size([360, radius])
                    .separation((a, b) => (a.parent == b.parent ? 1 : 2) / a.depth || 1);
                
                tree(root);
                
                // 手動調整根節點位置
                root.x = 0;
                root.y = 0;
                
                g.attr('transform', `translate(${width / 2}, ${height / 2})`);
                
                // 繪製連結線
                const linkGroup = g.append('g').attr('class', 'links');
                linkGroup.selectAll('.mindmap-link')
                    .data(root.links())
                    .join('path')
                    .attr('class', 'mindmap-link')
                    .attr('fill', 'none')
                    .attr('stroke', 'url(#nodeGradient1)')
                    .attr('stroke-width', d => Math.max(1.5, 3 - d.target.depth * 0.5))
                    .attr('stroke-opacity', 0.7)
                    .attr('d', d => {
                        // 來源座標
                        let sourceX, sourceY;
                        if (d.source.depth === 0) {
                            sourceX = 0;
                            sourceY = 0;
                        } else {
                            const sourceAngle = (d.source.x - 90) * Math.PI / 180;
                            sourceX = d.source.y * Math.cos(sourceAngle);
                            sourceY = d.source.y * Math.sin(sourceAngle);
                        }
                        
                        // 目標座標
                        const targetAngle = (d.target.x - 90) * Math.PI / 180;
                        const targetX = d.target.y * Math.cos(targetAngle);
                        const targetY = d.target.y * Math.sin(targetAngle);
                        
                        return `M${sourceX},${sourceY} L${targetX},${targetY}`;
                    })
                    .style('opacity', 0)
                    .transition()
                    .duration(600)
                    .delay((d, i) => i * 20)
                    .style('opacity', 1);
                
                // 繪製節點
                const nodeGroup = g.append('g').attr('class', 'nodes');
                const nodes = nodeGroup.selectAll('.mindmap-node')
                    .data(root.descendants())
                    .join('g')
                    .attr('class', 'mindmap-node')
                    .attr('transform', d => {
                        if (d.depth === 0) return 'translate(0, 0)';
                        const angle = (d.x - 90) * Math.PI / 180;
                        const x = d.y * Math.cos(angle);
                        const y = d.y * Math.sin(angle);
                        return `translate(${x}, ${y})`;
                    })
                    .style('cursor', 'pointer');
                
                // 節點圓形
                nodes.append('circle')
                    .attr('r', d => d.depth === 0 ? 40 : d.children ? 20 : 14)
                    .attr('fill', d => this.getNodeColor(d.depth))
                    .attr('stroke', '#fff')
                    .attr('stroke-width', d => d.depth === 0 ? 3 : 2)
                    .attr('filter', 'url(#glow)')
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 40)
                    .style('opacity', 1);
                
                // 文字標籤
                nodes.append('text')
                    .attr('class', 'mindmap-node-text')
                    .attr('fill', '#fff')
                    .attr('font-size', d => d.depth === 0 ? '14px' : '11px')
                    .attr('font-weight', d => d.depth === 0 ? 'bold' : 'normal')
                    .attr('text-anchor', d => {
                        if (d.depth === 0) return 'middle';
                        // 根據角度決定文字對齊方式
                        const angle = d.x;
                        if (angle > 90 && angle < 270) return 'end';
                        return 'start';
                    })
                    .attr('dominant-baseline', 'middle')
                    .attr('dx', d => {
                        if (d.depth === 0) return 0;
                        const r = d.children ? 26 : 20;
                        const angle = d.x;
                        if (angle > 90 && angle < 270) return -r;
                        return r;
                    })
                    .attr('dy', d => d.depth === 0 ? 0 : 0)
                    .text(d => this.truncateText(d.data.name || d.data.title, d.depth === 0 ? 12 : 10))
                    .style('opacity', 0)
                    .style('text-shadow', '1px 1px 3px rgba(0,0,0,0.9), -1px -1px 3px rgba(0,0,0,0.9)')
                    .style('pointer-events', 'none')
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 40 + 200)
                    .style('opacity', 1);
                
                // 添加滑鼠互動
                nodes
                    .on('mouseover', function(event, d) {
                        d3.select(this).select('circle')
                            .transition()
                            .duration(200)
                            .attr('r', d => (d.depth === 0 ? 40 : d.children ? 20 : 14) * 1.15)
                            .attr('stroke-width', 3);
                    })
                    .on('mouseout', function(event, d) {
                        d3.select(this).select('circle')
                            .transition()
                            .duration(200)
                            .attr('r', d => d.depth === 0 ? 40 : d.children ? 20 : 14)
                            .attr('stroke-width', d => d.depth === 0 ? 3 : 2);
                    });
            },
            
            renderTree(data, g, width, height) {
                const root = d3.hierarchy(data);
                const treeHeight = Math.max(400, root.height * 120);
                const treeLayout = d3.tree().size([width - 150, treeHeight]);
                treeLayout(root);
                
                g.attr('transform', 'translate(75, 50)');
                
                // 連結線
                g.selectAll('.mindmap-link')
                    .data(root.links())
                    .join('path')
                    .attr('class', 'mindmap-link')
                    .attr('fill', 'none')
                    .attr('stroke', 'url(#nodeGradient1)')
                    .attr('stroke-width', 2)
                    .attr('stroke-opacity', 0.6)
                    .attr('d', d3.linkVertical()
                        .x(d => d.x)
                        .y(d => d.y))
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 30)
                    .style('opacity', 1);
                
                // 節點
                const node = g.selectAll('.mindmap-node')
                    .data(root.descendants())
                    .join('g')
                    .attr('class', 'mindmap-node')
                    .attr('transform', d => `translate(${d.x}, ${d.y})`)
                    .style('cursor', 'pointer');
                
                node.append('rect')
                    .attr('x', d => d.depth === 0 ? -70 : -50)
                    .attr('y', -18)
                    .attr('width', d => d.depth === 0 ? 140 : 100)
                    .attr('height', 36)
                    .attr('rx', 18)
                    .attr('fill', d => this.getNodeColor(d.depth))
                    .attr('filter', 'url(#glow)')
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 50)
                    .style('opacity', 1);
                
                node.append('text')
                    .attr('dy', '0.35em')
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#fff')
                    .attr('font-size', d => d.depth === 0 ? '14px' : '11px')
                    .attr('font-weight', d => d.depth === 0 ? 'bold' : 'normal')
                    .text(d => this.truncateText(d.data.name || d.data.title, d.depth === 0 ? 12 : 10))
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 50 + 100)
                    .style('opacity', 1);
                
                // 互動
                node.on('mouseover', function() {
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('transform', 'scale(1.1)');
                }).on('mouseout', function() {
                    d3.select(this).select('rect')
                        .transition()
                        .duration(200)
                        .attr('transform', 'scale(1)');
                });
            },
            
            renderHorizontal(data, g, width, height) {
                const root = d3.hierarchy(data);
                const treeWidth = Math.max(600, root.height * 200);
                const treeLayout = d3.tree().size([height - 100, treeWidth]);
                treeLayout(root);
                
                g.attr('transform', 'translate(80, 50)');
                
                g.selectAll('.mindmap-link')
                    .data(root.links())
                    .join('path')
                    .attr('class', 'mindmap-link')
                    .attr('fill', 'none')
                    .attr('stroke', 'url(#nodeGradient1)')
                    .attr('stroke-width', 2)
                    .attr('stroke-opacity', 0.6)
                    .attr('d', d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x))
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 30)
                    .style('opacity', 1);
                
                const node = g.selectAll('.mindmap-node')
                    .data(root.descendants())
                    .join('g')
                    .attr('class', 'mindmap-node')
                    .attr('transform', d => `translate(${d.y}, ${d.x})`)
                    .style('cursor', 'pointer');
                
                node.append('rect')
                    .attr('x', -45)
                    .attr('y', -15)
                    .attr('width', 90)
                    .attr('height', 30)
                    .attr('rx', 15)
                    .attr('fill', d => this.getNodeColor(d.depth))
                    .attr('filter', 'url(#glow)')
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 50)
                    .style('opacity', 1);
                
                node.append('text')
                    .attr('dy', '0.35em')
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#fff')
                    .attr('font-size', '11px')
                    .text(d => this.truncateText(d.data.name || d.data.title, 10))
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 50 + 100)
                    .style('opacity', 1);
            },
            
            renderVertical(data, g, width, height) {
                const root = d3.hierarchy(data);
                const treeHeight = Math.max(400, root.height * 100);
                const treeLayout = d3.tree().size([width - 100, treeHeight]);
                treeLayout(root);
                
                g.attr('transform', 'translate(50, 60)');
                
                g.selectAll('.mindmap-link')
                    .data(root.links())
                    .join('path')
                    .attr('class', 'mindmap-link')
                    .attr('fill', 'none')
                    .attr('stroke', 'url(#nodeGradient1)')
                    .attr('stroke-width', 2)
                    .attr('stroke-opacity', 0.6)
                    .attr('d', d3.linkVertical()
                        .x(d => d.x)
                        .y(d => d.y))
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 30)
                    .style('opacity', 1);
                
                const node = g.selectAll('.mindmap-node')
                    .data(root.descendants())
                    .join('g')
                    .attr('class', 'mindmap-node')
                    .attr('transform', d => `translate(${d.x}, ${d.y})`)
                    .style('cursor', 'pointer');
                
                node.append('ellipse')
                    .attr('rx', d => d.depth === 0 ? 60 : 45)
                    .attr('ry', 22)
                    .attr('fill', d => this.getNodeColor(d.depth))
                    .attr('filter', 'url(#glow)')
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 50)
                    .style('opacity', 1);
                
                node.append('text')
                    .attr('dy', '0.35em')
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#fff')
                    .attr('font-size', d => d.depth === 0 ? '13px' : '10px')
                    .text(d => this.truncateText(d.data.name || d.data.title, d.depth === 0 ? 10 : 8))
                    .style('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => i * 50 + 100)
                    .style('opacity', 1);
            },
            
            renderForce(data, g, width, height) {
                const nodes = [];
                const links = [];
                
                function flatten(node, parent = null) {
                    const n = { 
                        id: nodes.length, 
                        name: node.name || node.title, 
                        depth: parent ? parent.depth + 1 : 0 
                    };
                    nodes.push(n);
                    if (parent) links.push({ source: parent.id, target: n.id });
                    if (node.children) node.children.forEach(child => flatten(child, n));
                }
                flatten(data);
                
                const simulation = d3.forceSimulation(nodes)
                    .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(width / 2, height / 2))
                    .force('collision', d3.forceCollide().radius(50));
                
                const link = g.selectAll('.mindmap-link')
                    .data(links)
                    .join('line')
                    .attr('class', 'mindmap-link')
                    .attr('stroke', 'url(#nodeGradient1)')
                    .attr('stroke-width', 2)
                    .attr('stroke-opacity', 0.5);
                
                const node = g.selectAll('.mindmap-node')
                    .data(nodes)
                    .join('g')
                    .attr('class', 'mindmap-node')
                    .style('cursor', 'grab')
                    .call(d3.drag()
                        .on('start', (event, d) => {
                            if (!event.active) simulation.alphaTarget(0.3).restart();
                            d.fx = d.x;
                            d.fy = d.y;
                        })
                        .on('drag', (event, d) => {
                            d.fx = event.x;
                            d.fy = event.y;
                        })
                        .on('end', (event, d) => {
                            if (!event.active) simulation.alphaTarget(0);
                            d.fx = null;
                            d.fy = null;
                        }));
                
                node.append('circle')
                    .attr('r', d => d.depth === 0 ? 30 : 18)
                    .attr('fill', d => this.getNodeColor(d.depth))
                    .attr('filter', 'url(#glow)');
                
                node.append('text')
                    .attr('dy', d => d.depth === 0 ? 45 : 35)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#fff')
                    .attr('font-size', '11px')
                    .text(d => this.truncateText(d.name, 10))
                    .style('text-shadow', '0 0 5px rgba(0,0,0,0.8)');
                
                simulation.on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    node.attr('transform', d => `translate(${d.x}, ${d.y})`);
                });
            },
            
            getNodeColor(depth) {
                const colors = [
                    'url(#nodeGradient1)',  // 主節點
                    '#00f5ff',              // 第一層
                    '#bf00ff',              // 第二層
                    '#ff6b6b',              // 第三層
                    '#4ecdc4',              // 第四層
                    '#feca57'               // 第五層
                ];
                return colors[Math.min(depth, colors.length - 1)];
            },
            
            truncateText(text, maxLen) {
                if (!text) return '';
                return text.length > maxLen ? text.substring(0, maxLen) + '...' : text;
            },
            
            setLayout(layout) {
                this.currentLayout = layout;
                if (this.data) {
                    const container = document.getElementById('mindmapContainer');
                    const width = container.clientWidth || 800;
                    const height = Math.max(container.clientHeight || 600, 500);
                    const g = this.svg.select('.mindmap-content');
                    this.renderLayout(this.data, g, width, height);
                }
                Toast.success(`已切換至「${this.layouts[layout].name}」佈局`);
            },
            
            zoomIn() {
                if (this.svg && this.zoom) {
                    this.svg.transition().duration(300).call(this.zoom.scaleBy, 1.3);
                }
            },
            
            zoomOut() {
                if (this.svg && this.zoom) {
                    this.svg.transition().duration(300).call(this.zoom.scaleBy, 0.7);
                }
            },
            
            resetZoom() {
                if (this.svg && this.zoom) {
                    this.svg.transition().duration(300).call(this.zoom.transform, d3.zoomIdentity);
                }
            }
        };

        // ============================================
        // 流程圖渲染器
        // ============================================
        const FlowchartRenderer = {
            render(mermaidCode, containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'block';
                
                const mermaidEl = document.getElementById('flowchartMermaid');
                
                mermaidEl.innerHTML = mermaidCode;
                mermaidEl.removeAttribute('data-processed');
                
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'dark',
                    themeVariables: {
                        primaryColor: '#00f5ff',
                        primaryTextColor: '#ffffff',
                        primaryBorderColor: '#00f5ff',
                        lineColor: '#00f5ff',
                        secondaryColor: '#bf00ff',
                        tertiaryColor: '#1a1a2e'
                    },
                    flowchart: {
                        curve: 'basis',
                        padding: 20
                    }
                });
                
                mermaid.run({ nodes: [mermaidEl] });
            }
        };

        // ============================================
        // 時間軸渲染器
        // ============================================
        const TimelineRenderer = {
            render(data, containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'block';
                container.innerHTML = '';
                
                const title = document.createElement('h2');
                title.style.cssText = 'text-align: center; margin-bottom: 30px; font-size: 1.8rem; background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;';
                title.textContent = data.title || '時間軸';
                container.appendChild(title);
                
                const timeline = document.createElement('div');
                timeline.className = 'timeline';
                
                data.events?.forEach((event, index) => {
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    item.style.animationDelay = `${index * 0.1}s`;
                    
                    item.innerHTML = `
                        <div class="timeline-dot"></div>
                        <div class="timeline-date">${Utils.escapeHtml(event.date)}</div>
                        <div class="timeline-title">${Utils.escapeHtml(event.title)}</div>
                        <div class="timeline-content">${Utils.escapeHtml(event.content)}</div>
                    `;
                    
                    timeline.appendChild(item);
                });
                
                container.appendChild(timeline);
            }
        };

        // ============================================
        // 魚骨圖渲染器
        // ============================================
        const FishboneRenderer = {
            render(data, containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'block';
                container.innerHTML = '';
                
                const svg = d3.select(`#${containerId}`)
                    .append('svg')
                    .attr('width', '100%')
                    .attr('height', '500')
                    .attr('viewBox', '0 0 1200 500');
                
                const g = svg.append('g').attr('transform', 'translate(50, 250)');
                
                // 主幹
                g.append('line')
                    .attr('x1', 0)
                    .attr('y1', 0)
                    .attr('x2', 900)
                    .attr('y2', 0)
                    .attr('stroke', 'var(--primary)')
                    .attr('stroke-width', 6);
                
                // 魚頭（結果）
                g.append('polygon')
                    .attr('points', '900,0 1000,-50 1100,0 1000,50')
                    .attr('fill', 'var(--primary)');
                
                g.append('text')
                    .attr('x', 1000)
                    .attr('y', 5)
                    .attr('text-anchor', 'middle')
                    .attr('fill', 'var(--bg-dark)')
                    .attr('font-weight', 'bold')
                    .attr('font-size', '12px')
                    .text(this.truncate(data.effect || '結果', 8));
                
                // 繪製骨頭
                const categories = data.categories || [];
                const spacing = 800 / (categories.length + 1);
                
                categories.forEach((cat, i) => {
                    const x = spacing * (i + 1);
                    const isTop = i % 2 === 0;
                    const yDir = isTop ? -1 : 1;
                    
                    // 主骨
                    g.append('line')
                        .attr('x1', x)
                        .attr('y1', 0)
                        .attr('x2', x + 80)
                        .attr('y2', yDir * 120)
                        .attr('stroke', 'var(--secondary)')
                        .attr('stroke-width', 3);
                    
                    // 類別標籤
                    g.append('rect')
                        .attr('x', x + 60)
                        .attr('y', yDir * 130 - (isTop ? 25 : 0))
                        .attr('width', 100)
                        .attr('height', 25)
                        .attr('rx', 5)
                        .attr('fill', 'var(--secondary)');
                    
                    g.append('text')
                        .attr('x', x + 110)
                        .attr('y', yDir * 130 + (isTop ? -8 : 17))
                        .attr('text-anchor', 'middle')
                        .attr('fill', 'var(--bg-dark)')
                        .attr('font-size', '11px')
                        .attr('font-weight', 'bold')
                        .text(this.truncate(cat.name, 6));
                    
                    // 小骨（原因）
                    cat.causes?.forEach((cause, j) => {
                        const boneX = x + 20 + j * 25;
                        const boneY = yDir * (30 + j * 25);
                        
                        g.append('line')
                            .attr('x1', boneX)
                            .attr('y1', yDir * (boneY / 120) * 30)
                            .attr('x2', boneX + 40)
                            .attr('y2', boneY + yDir * 15)
                            .attr('stroke', 'var(--accent)')
                            .attr('stroke-width', 2);
                        
                        g.append('text')
                            .attr('x', boneX + 45)
                            .attr('y', boneY + yDir * 20)
                            .attr('font-size', '9px')
                            .attr('fill', 'var(--text-secondary)')
                            .text(this.truncate(cause, 8));
                    });
                });
            },
            
            truncate(text, len) {
                return text?.length > len ? text.substring(0, len) + '..' : text || '';
            }
        };

        // ============================================
        // 雷達圖渲染器
        // ============================================
        const RadarRenderer = {
            render(data, containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'block';
                container.innerHTML = '';
                
                const width = 450;
                const height = 450;
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = 150;
                
                const dimensions = data.dimensions || [];
                const n = dimensions.length;
                const angleSlice = (Math.PI * 2) / n;
                
                const svg = d3.select(`#${containerId}`)
                    .append('svg')
                    .attr('class', 'radar-svg')
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .style('max-width', '500px')
                    .style('margin', '0 auto')
                    .style('display', 'block');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${centerX}, ${centerY})`);
                
                // 繪製網格
                const levels = 5;
                for (let level = 1; level <= levels; level++) {
                    const r = (radius / levels) * level;
                    const points = [];
                    for (let i = 0; i < n; i++) {
                        const angle = angleSlice * i - Math.PI / 2;
                        points.push([r * Math.cos(angle), r * Math.sin(angle)]);
                    }
                    
                    g.append('polygon')
                        .attr('class', 'radar-grid')
                        .attr('points', points.map(p => p.join(',')).join(' '));
                }
                
                // 繪製軸線
                for (let i = 0; i < n; i++) {
                    const angle = angleSlice * i - Math.PI / 2;
                    g.append('line')
                        .attr('class', 'radar-axis')
                        .attr('x1', 0)
                        .attr('y1', 0)
                        .attr('x2', radius * Math.cos(angle))
                        .attr('y2', radius * Math.sin(angle));
                }
                
                // 繪製數據區域
                const dataPoints = dimensions.map((d, i) => {
                    const angle = angleSlice * i - Math.PI / 2;
                    const value = (d.value / (d.maxValue || 100)) * radius;
                    return [value * Math.cos(angle), value * Math.sin(angle)];
                });
                
                g.append('polygon')
                    .attr('class', 'radar-area')
                    .attr('points', dataPoints.map(p => p.join(',')).join(' '));
                
                // 繪製數據點
                dataPoints.forEach((point, i) => {
                    g.append('circle')
                        .attr('class', 'radar-point')
                        .attr('cx', point[0])
                        .attr('cy', point[1])
                        .attr('r', 6);
                });
                
                // 繪製標籤
                dimensions.forEach((d, i) => {
                    const angle = angleSlice * i - Math.PI / 2;
                    const labelRadius = radius + 40;
                    const x = labelRadius * Math.cos(angle);
                    const y = labelRadius * Math.sin(angle);
                    
                    g.append('text')
                        .attr('class', 'radar-label')
                        .attr('x', x)
                        .attr('y', y)
                        .text(d.name);
                    
                    g.append('text')
                        .attr('class', 'radar-value')
                        .attr('x', x)
                        .attr('y', y + 15)
                        .attr('text-anchor', 'middle')
                        .text(`${d.value}/${d.maxValue || 100}`);
                });
                
                // 標題
                const titleEl = document.createElement('h3');
                titleEl.style.cssText = 'text-align: center; margin-bottom: 20px; color: var(--primary);';
                titleEl.textContent = data.title || '雷達圖分析';
                container.insertBefore(titleEl, container.firstChild);
            }
        };

        // ============================================
        // 資訊圖表渲染器
        // ============================================
        const InfographicRenderer = {
            render(data, containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'block';
                container.innerHTML = '';
                
                const grid = document.createElement('div');
                grid.className = 'infographic-grid';
                
                // 標題卡片
                const titleCard = document.createElement('div');
                titleCard.className = 'infographic-title-card';
                titleCard.innerHTML = `<div class="infographic-title-text">${Utils.escapeHtml(data.title || '資訊圖表')}</div>`;
                grid.appendChild(titleCard);
                
                // 內容卡片
                data.cards?.forEach((card, index) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'infographic-card';
                    cardEl.innerHTML = `
                        <div class="infographic-card-number">${index + 1}</div>
                        <div class="infographic-card-title">${Utils.escapeHtml(card.title)}</div>
                        <div class="infographic-card-content">${Utils.escapeHtml(card.content)}</div>
                    `;
                    grid.appendChild(cardEl);
                });
                
                container.appendChild(grid);
            }
        };

        // ============================================
        // 摘要渲染器
        // ============================================
        const SummaryRenderer = {
            render(data, containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'block';
                container.innerHTML = '';
                
                const html = `
                    <div class="summary-header">
                        <div class="summary-icon">📝</div>
                        <h1 class="summary-title">${Utils.escapeHtml(data.title || '文件摘要')}</h1>
                    </div>
                    
                    <div class="summary-main-text">${Utils.escapeHtml(data.overview || '')}</div>
                    
                    <div class="summary-points">
                        <div class="summary-points-title">
                            <span>🎯</span>
                            <span>${I18n.t('format.summary')}</span>
                        </div>
                        ${(data.keyPoints || []).map((point, i) => `
                            <div class="summary-point" onclick="this.classList.toggle('expanded')">
                                <div class="summary-point-header">
                                    <div class="summary-point-number">${i + 1}</div>
                                    <div class="summary-point-title">${Utils.escapeHtml(point.title)}</div>
                                    <div class="summary-point-toggle">▼</div>
                                </div>
                                <div class="summary-point-detail">
                                    <div class="summary-point-detail-content">${Utils.escapeHtml(point.detail)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${data.conclusion ? `
                        <div class="summary-conclusion">
                            <div class="summary-conclusion-icon">💡</div>
                            <p>${Utils.escapeHtml(data.conclusion)}</p>
                        </div>
                    ` : ''}
                `;
                
                container.innerHTML = html;
            }
        };

        // ============================================
        // SWOT 分析渲染器
        // ============================================
        const SWOTRenderer = {
            render(data, containerId) {
                const container = document.getElementById(containerId);
                container.style.display = 'block';
                container.innerHTML = '';
                
                const html = `
                    <div class="swot-container">
                        <h2 class="swot-title">${Utils.escapeHtml(data.title || 'SWOT 分析')}</h2>
                        <div class="swot-grid">
                            <div class="swot-card swot-strengths">
                                <div class="swot-card-header">
                                    <span class="swot-card-icon">💪</span>
                                    <span class="swot-card-title">Strengths 優勢</span>
                                </div>
                                <ul class="swot-list">
                                    ${(data.strengths || []).map(item => `<li>${Utils.escapeHtml(item)}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="swot-card swot-weaknesses">
                                <div class="swot-card-header">
                                    <span class="swot-card-icon">⚠️</span>
                                    <span class="swot-card-title">Weaknesses 劣勢</span>
                                </div>
                                <ul class="swot-list">
                                    ${(data.weaknesses || []).map(item => `<li>${Utils.escapeHtml(item)}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="swot-card swot-opportunities">
                                <div class="swot-card-header">
                                    <span class="swot-card-icon">🚀</span>
                                    <span class="swot-card-title">Opportunities 機會</span>
                                </div>
                                <ul class="swot-list">
                                    ${(data.opportunities || []).map(item => `<li>${Utils.escapeHtml(item)}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="swot-card swot-threats">
                                <div class="swot-card-header">
                                    <span class="swot-card-icon">⛔</span>
                                    <span class="swot-card-title">Threats 威脅</span>
                                </div>
                                <ul class="swot-list">
                                    ${(data.threats || []).map(item => `<li>${Utils.escapeHtml(item)}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        ${data.summary ? `
                            <div class="swot-summary">
                                <span class="swot-summary-icon">💡</span>
                                <p>${Utils.escapeHtml(data.summary)}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.innerHTML = html;
            }
        };

        // ============================================
        // TTS 語音系統
        // ============================================
        const TTSEngine = {
            utterance: null,
            voices: [],
            isPlaying: false,
            currentText: '',
            
            init() {
                if ('speechSynthesis' in window) {
                    // 載入語音
                    this.loadVoices();
                    speechSynthesis.onvoiceschanged = () => this.loadVoices();
                }
            },
            
            loadVoices() {
                this.voices = speechSynthesis.getVoices();
                const selector = document.getElementById('voiceSelector');
                if (!selector) return;
                
                selector.innerHTML = '';
                
                // 根據當前語言篩選語音
                const langMap = {
                    'zh-TW': ['zh-TW', 'zh-HK', 'zh'],
                    'zh-CN': ['zh-CN', 'zh'],
                    'en': ['en-US', 'en-GB', 'en'],
                    'ja': ['ja-JP', 'ja']
                };
                
                const preferredLangs = langMap[AppState.currentLang] || ['zh-TW'];
                
                // 優先顯示符合語言的語音
                const matchingVoices = this.voices.filter(v => 
                    preferredLangs.some(lang => v.lang.startsWith(lang))
                );
                
                const otherVoices = this.voices.filter(v => 
                    !preferredLangs.some(lang => v.lang.startsWith(lang))
                );
                
                [...matchingVoices, ...otherVoices].forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (matchingVoices.includes(voice) && selector.options.length === 0) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            },
            
            speak(text) {
                if (!('speechSynthesis' in window)) {
                    Toast.error('您的瀏覽器不支援語音合成');
                    return;
                }
                
                this.stop();
                this.currentText = text;
                this.isPlaying = true;
                
                this.utterance = new SpeechSynthesisUtterance(text);
                
                // 設定語音
                const selector = document.getElementById('voiceSelector');
                if (selector && selector.value) {
                    const voice = this.voices.find(v => v.name === selector.value);
                    if (voice) this.utterance.voice = voice;
                }
                
                // 設定語速
                const speedSlider = document.getElementById('ttsSpeed');
                if (speedSlider) {
                    this.utterance.rate = parseFloat(speedSlider.value);
                }
                
                // 事件處理
                this.utterance.onstart = () => {
                    this.updatePlayButton(true);
                };
                
                this.utterance.onend = () => {
                    this.isPlaying = false;
                    this.updatePlayButton(false);
                    document.getElementById('ttsProgressFill').style.width = '100%';
                };
                
                this.utterance.onerror = (e) => {
                    console.error('TTS 錯誤:', e);
                    this.isPlaying = false;
                    this.updatePlayButton(false);
                };
                
                this.utterance.onboundary = (event) => {
                    if (event.charIndex !== undefined && this.currentText) {
                        const progress = (event.charIndex / this.currentText.length) * 100;
                        document.getElementById('ttsProgressFill').style.width = `${progress}%`;
                    }
                };
                
                speechSynthesis.speak(this.utterance);
            },
            
            pause() {
                if (speechSynthesis.speaking && !speechSynthesis.paused) {
                    speechSynthesis.pause();
                    this.updatePlayButton(false);
                }
            },
            
            resume() {
                if (speechSynthesis.paused) {
                    speechSynthesis.resume();
                    this.updatePlayButton(true);
                }
            },
            
            stop() {
                speechSynthesis.cancel();
                this.isPlaying = false;
                this.updatePlayButton(false);
                document.getElementById('ttsProgressFill').style.width = '0%';
            },
            
            toggle() {
                if (this.isPlaying) {
                    if (speechSynthesis.paused) {
                        this.resume();
                    } else {
                        this.pause();
                    }
                }
            },
            
            updatePlayButton(playing) {
                const btn = document.getElementById('ttsPlay');
                if (btn) {
                    btn.textContent = playing ? '⏸' : '▶';
                    btn.classList.toggle('playing', playing);
                }
            },
            
            speakScript() {
                const scriptContent = document.getElementById('scriptContent');
                if (!scriptContent) return;
                
                const text = scriptContent.innerText || scriptContent.textContent;
                if (text && text.trim()) {
                    this.speak(text);
                } else {
                    Toast.warning('沒有講稿內容可以朗讀');
                }
            }
        };

        // ============================================
        // 匯出功能
        // ============================================
        const Exporter = {
            async exportPNG() {
                try {
                    Loading.show(I18n.t('export.format') + ' PNG...');
                    
                    const resultWrapper = document.getElementById('resultWrapper');
                    const canvas = await html2canvas(resultWrapper, {
                        backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-darker'),
                        scale: 2,
                        useCORS: true,
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    link.download = `visual-summary-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    Loading.hide();
                    Toast.success(I18n.t('export.success'));
                } catch (error) {
                    Loading.hide();
                    Toast.error('PNG 匯出失敗: ' + error.message);
                }
            },
            
            async exportSVG() {
                try {
                    const svg = document.querySelector('#mindmapContainer svg, #radarContainer svg, #fishboneContainer svg');
                    if (!svg) {
                        Toast.warning('目前格式不支援 SVG 匯出');
                        return;
                    }
                    
                    const svgData = new XMLSerializer().serializeToString(svg);
                    const blob = new Blob([svgData], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.download = `visual-summary-${Date.now()}.svg`;
                    link.href = url;
                    link.click();
                    
                    URL.revokeObjectURL(url);
                    Toast.success(I18n.t('export.success'));
                } catch (error) {
                    Toast.error('SVG 匯出失敗: ' + error.message);
                }
            },
            
            async exportPDF() {
                try {
                    Loading.show(I18n.t('export.format') + ' PDF...');
                    
                    const { jsPDF } = window.jspdf;
                    const resultWrapper = document.getElementById('resultWrapper');
                    
                    const canvas = await html2canvas(resultWrapper, {
                        backgroundColor: '#0a0e17',
                        scale: 2,
                        useCORS: true
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`visual-summary-${Date.now()}.pdf`);
                    
                    Loading.hide();
                    Toast.success(I18n.t('export.success'));
                } catch (error) {
                    Loading.hide();
                    Toast.error('PDF 匯出失敗: ' + error.message);
                }
            },
            
            exportJSON() {
                if (!AppState.generatedData) {
                    Toast.warning('沒有資料可匯出');
                    return;
                }
                
                const data = {
                    format: AppState.currentFormat,
                    data: AppState.generatedData,
                    fileName: AppState.fileName,
                    generatedAt: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.download = `visual-summary-${Date.now()}.json`;
                link.href = url;
                link.click();
                
                URL.revokeObjectURL(url);
                Toast.success(I18n.t('export.success'));
            },
            
            // 分享功能
            share(platform) {
                const url = window.location.href;
                const title = AppState.fileName || 'AI Visual Summary';
                const text = `查看我用 AI Visual Summary 生成的視覺摘要！`;
                
                const shareUrls = {
                    twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
                    facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
                    linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`,
                    line: `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}`
                };
                
                if (platform === 'copy') {
                    navigator.clipboard.writeText(url).then(() => {
                        Toast.success(I18n.t('export.copied'));
                    }).catch(() => {
                        Toast.error('複製失敗');
                    });
                } else if (shareUrls[platform]) {
                    window.open(shareUrls[platform], '_blank', 'width=600,height=400');
                }
            }
        };

        // ============================================
        // 簡報模式
        // ============================================
        const Presentation = {
            slides: [],
            currentIndex: 0,
            
            start(data) {
                this.slides = this.createSlides(data);
                this.currentIndex = 0;
                
                if (this.slides.length === 0) {
                    Toast.warning('無法生成簡報投影片');
                    return;
                }
                
                document.getElementById('presentationOverlay').classList.add('show');
                this.showSlide(0);
                
                // 鍵盤控制
                document.addEventListener('keydown', this.handleKeydown.bind(this));
            },
            
            exit() {
                document.getElementById('presentationOverlay').classList.remove('show');
                document.removeEventListener('keydown', this.handleKeydown.bind(this));
                TTSEngine.stop();
            },
            
            createSlides(data) {
                const slides = [];
                
                // 根據不同格式創建投影片
                if (data.title) {
                    slides.push({
                        type: 'title',
                        title: data.title,
                        subtitle: data.overview || ''
                    });
                }
                
                // 心智圖
                if (data.children) {
                    data.children.forEach(child => {
                        slides.push({
                            type: 'content',
                            title: child.name,
                            content: child.children?.map(c => c.name).join('、') || ''
                        });
                    });
                }
                
                // 資訊圖表
                if (data.cards) {
                    data.cards.forEach(card => {
                        slides.push({
                            type: 'content',
                            title: card.title,
                            content: card.content
                        });
                    });
                }
                
                // 摘要
                if (data.keyPoints) {
                    data.keyPoints.forEach(point => {
                        slides.push({
                            type: 'content',
                            title: point.title,
                            content: point.detail
                        });
                    });
                }
                
                // 時間軸
                if (data.events) {
                    data.events.forEach(event => {
                        slides.push({
                            type: 'content',
                            title: `${event.date} - ${event.title}`,
                            content: event.content
                        });
                    });
                }
                
                // 魚骨圖
                if (data.categories) {
                    slides.push({
                        type: 'content',
                        title: data.effect || '分析結果',
                        content: data.categories.map(c => `${c.name}: ${c.causes?.join(', ')}`).join('\n')
                    });
                }
                
                // 雷達圖
                if (data.dimensions) {
                    slides.push({
                        type: 'content',
                        title: data.title || '雷達圖分析',
                        content: data.dimensions.map(d => `${d.name}: ${d.value}/${d.maxValue || 100}`).join('\n')
                    });
                }
                
                // 結論
                if (data.conclusion) {
                    slides.push({
                        type: 'conclusion',
                        title: '結論',
                        content: data.conclusion
                    });
                }
                
                return slides;
            },
            
            showSlide(index) {
                if (index < 0 || index >= this.slides.length) return;
                
                this.currentIndex = index;
                const slide = this.slides[index];
                const container = document.getElementById('presentationSlide');
                const animation = Utils.getRandomAnimation();
                
                container.className = `presentation-slide ${animation}`;
                
                if (slide.type === 'title') {
                    container.innerHTML = `
                        <h1 class="slide-title">${Utils.escapeHtml(slide.title)}</h1>
                        ${slide.subtitle ? `<p class="slide-subtitle">${Utils.escapeHtml(slide.subtitle)}</p>` : ''}
                    `;
                } else {
                    container.innerHTML = `
                        <h2 class="slide-title" style="font-size: 2.5rem;">${Utils.escapeHtml(slide.title)}</h2>
                        <div class="slide-content">${Utils.escapeHtml(slide.content).replace(/\n/g, '<br>')}</div>
                    `;
                }
                
                // 更新計數器和進度
                document.getElementById('presentationCounter').textContent = `${index + 1} / ${this.slides.length}`;
                document.getElementById('presentationProgressFill').style.width = `${((index + 1) / this.slides.length) * 100}%`;
            },
            
            next() {
                if (this.currentIndex < this.slides.length - 1) {
                    this.showSlide(this.currentIndex + 1);
                }
            },
            
            prev() {
                if (this.currentIndex > 0) {
                    this.showSlide(this.currentIndex - 1);
                }
            },
            
            handleKeydown(e) {
                switch (e.key) {
                    case 'ArrowRight':
                    case ' ':
                        this.next();
                        break;
                    case 'ArrowLeft':
                        this.prev();
                        break;
                    case 'Escape':
                        this.exit();
                        break;
                }
            },
            
            speakCurrentSlide() {
                const slide = this.slides[this.currentIndex];
                if (slide) {
                    const text = `${slide.title}。${slide.content || slide.subtitle || ''}`;
                    TTSEngine.speak(text);
                }
            }
        };

        // ============================================
        // 主應用程式
        // ============================================
        const App = {
            init() {
                // 初始化啟動畫面
                this.initSplashScreen();
                
                // 初始化 PDF.js
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // 初始化 Mermaid
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'dark'
                });
                
                // 初始化 TTS
                TTSEngine.init();
                
                // 綁定事件
                this.bindEvents();
                
                // 檢測裝置
                this.checkDevice();
                
                // 設定語言
                I18n.updateUI();
            },
            
            initSplashScreen() {
                // 生成粒子
                const particlesContainer = document.getElementById('splashParticles');
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'splash-particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 5 + 's';
                    particle.style.animationDuration = (5 + Math.random() * 5) + 's';
                    particlesContainer.appendChild(particle);
                }
                
                // 隱藏啟動畫面
                setTimeout(() => {
                    document.getElementById('splashScreen').classList.add('fade-out');
                }, 2500);
            },
            
            checkDevice() {
                AppState.isMobile = window.innerWidth <= 768;
                window.addEventListener('resize', () => {
                    AppState.isMobile = window.innerWidth <= 768;
                });
            },
            
            bindEvents() {
                // API Key 相關
                document.getElementById('toggleApiKey').addEventListener('click', () => {
                    const input = document.getElementById('apiKey');
                    input.type = input.type === 'password' ? 'text' : 'password';
                });
                
                document.getElementById('testApiKey').addEventListener('click', async () => {
                    const apiKey = document.getElementById('apiKey').value.trim();
                    if (!apiKey) {
                        Toast.warning(I18n.t('error.noApiKey'));
                        return;
                    }
                    
                    const success = await GeminiAPI.testConnection(apiKey);
                    if (success) {
                        AppState.apiKey = apiKey;
                        Toast.success(I18n.t('api.success'));
                    } else {
                        Toast.error(I18n.t('api.error'));
                    }
                });
                
                // 檔案上傳
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                uploadArea.addEventListener('click', () => fileInput.click());
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) await this.handleFile(file);
                });
                
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) await this.handleFile(file);
                });
                
                document.getElementById('fileRemove').addEventListener('click', () => {
                    this.clearFile();
                });
                
                // 格式選擇（網格版）
                document.querySelectorAll('.format-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.format-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        AppState.currentFormat = item.dataset.format;
                    });
                });
                
                // 主題選擇
                document.getElementById('themeSelect').addEventListener('change', (e) => {
                    this.setTheme(e.target.value);
                });
                
                // 生成按鈕
                document.getElementById('generateBtn').addEventListener('click', () => {
                    this.generate();
                });
                
                // 語言選擇
                document.getElementById('langBtn').addEventListener('click', () => {
                    document.getElementById('langDropdown').classList.toggle('show');
                });
                
                document.querySelectorAll('.lang-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const lang = option.dataset.lang;
                        this.setLanguage(lang);
                        document.getElementById('langDropdown').classList.remove('show');
                    });
                });
                
                // 點擊其他地方關閉下拉選單
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.lang-selector')) {
                        document.getElementById('langDropdown').classList.remove('show');
                    }
                });
                
                // 工具列按鈕
                document.getElementById('zoomIn').addEventListener('click', () => MindmapRenderer.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => MindmapRenderer.zoomOut());
                document.getElementById('zoomReset').addEventListener('click', () => MindmapRenderer.resetZoom());
                
                document.getElementById('presentationBtn').addEventListener('click', () => {
                    if (AppState.generatedData) {
                        Presentation.start(AppState.generatedData);
                    }
                });
                
                document.getElementById('layoutBtn').addEventListener('click', () => {
                    this.showLayoutModal();
                });
                
                // AI 面板
                document.getElementById('aiBtn').addEventListener('click', () => {
                    document.getElementById('aiPanel').classList.toggle('show');
                });
                
                document.getElementById('aiPanelClose').addEventListener('click', () => {
                    document.getElementById('aiPanel').classList.remove('show');
                });
                
                document.querySelectorAll('.ai-panel-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.ai-panel-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const tabName = tab.dataset.tab;
                        document.getElementById('scriptContainer').classList.toggle('active', tabName === 'script');
                        document.getElementById('qaContainer').classList.toggle('active', tabName === 'qa');
                    });
                });
                
                // 講稿生成
                document.getElementById('regenerateScript').addEventListener('click', () => {
                    this.generateScript();
                });
                
                document.getElementById('copyScript').addEventListener('click', () => {
                    const content = document.getElementById('scriptContent').innerText;
                    navigator.clipboard.writeText(content).then(() => {
                        Toast.success(I18n.t('export.copied'));
                    });
                });
                
                // TTS 控制
                document.getElementById('ttsPlay').addEventListener('click', () => {
                    if (TTSEngine.isPlaying) {
                        TTSEngine.toggle();
                    } else {
                        TTSEngine.speakScript();
                    }
                });
                
                document.getElementById('ttsStop').addEventListener('click', () => {
                    TTSEngine.stop();
                });
                
                // Q&A
                document.getElementById('qaSend').addEventListener('click', () => {
                    this.sendQuestion();
                });
                
                document.getElementById('qaInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendQuestion();
                    }
                });
                
                document.querySelectorAll('.qa-suggestion').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.getElementById('qaInput').value = btn.textContent;
                        this.sendQuestion();
                    });
                });
                
                // 匯出面板
                document.getElementById('exportBtn').addEventListener('click', () => {
                    document.getElementById('exportPanel').classList.add('show');
                    document.getElementById('exportBackdrop').classList.add('show');
                });
                
                document.getElementById('exportClose').addEventListener('click', () => {
                    document.getElementById('exportPanel').classList.remove('show');
                    document.getElementById('exportBackdrop').classList.remove('show');
                });
                
                document.getElementById('exportBackdrop').addEventListener('click', () => {
                    document.getElementById('exportPanel').classList.remove('show');
                    document.getElementById('exportBackdrop').classList.remove('show');
                });
                
                document.querySelectorAll('.export-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const format = option.dataset.format;
                        switch (format) {
                            case 'png': Exporter.exportPNG(); break;
                            case 'svg': Exporter.exportSVG(); break;
                            case 'pdf': Exporter.exportPDF(); break;
                            case 'json': Exporter.exportJSON(); break;
                        }
                    });
                });
                
                document.querySelectorAll('.share-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        Exporter.share(btn.dataset.share);
                    });
                });
                
                // 簡報控制
                document.getElementById('presentationExit').addEventListener('click', () => Presentation.exit());
                document.getElementById('presentationPrev').addEventListener('click', () => Presentation.prev());
                document.getElementById('presentationNext').addEventListener('click', () => Presentation.next());
                document.getElementById('presentationTTS').addEventListener('click', () => Presentation.speakCurrentSlide());
                
                // 手機版選單
                document.getElementById('mobileToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.add('show');
                    document.getElementById('sidebarBackdrop').classList.add('show');
                });
                
                document.getElementById('sidebarClose').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('show');
                    document.getElementById('sidebarBackdrop').classList.remove('show');
                });
                
                document.getElementById('sidebarBackdrop').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('show');
                    document.getElementById('sidebarBackdrop').classList.remove('show');
                });
            },
            
            async handleFile(file) {
                try {
                    const content = await FileProcessor.processFile(file);
                    
                    AppState.fileContent = content;
                    AppState.fileName = file.name;
                    AppState.fileSize = file.size;
                    
                    // 更新 UI
                    document.getElementById('uploadArea').classList.add('has-file');
                    document.getElementById('fileInfo').classList.add('show');
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileSize').textContent = Utils.formatFileSize(file.size);
                    document.getElementById('fileChars').textContent = FileProcessor.isImageMode 
                        ? '📷 圖片模式' 
                        : `${content.length.toLocaleString()} 字元`;
                    
                    // 設定圖示
                    const ext = file.name.split('.').pop().toLowerCase();
                    const icons = { 
                        pdf: '📕', doc: '📘', docx: '📘', txt: '📄', md: '📝',
                        png: '🖼️', jpg: '🖼️', jpeg: '🖼️', gif: '🖼️', webp: '🖼️', bmp: '🖼️'
                    };
                    document.getElementById('fileIcon').textContent = icons[ext] || '📄';
                    
                    Toast.success(I18n.t('upload.success'));
                    
                } catch (error) {
                    Toast.error(I18n.t('upload.error') + ': ' + error.message);
                }
            },
            
            clearFile() {
                AppState.fileContent = '';
                AppState.fileName = '';
                AppState.fileSize = 0;
                FileProcessor.imageFile = null;
                FileProcessor.isImageMode = false;
                
                document.getElementById('uploadArea').classList.remove('has-file');
                document.getElementById('fileInfo').classList.remove('show');
                document.getElementById('fileInput').value = '';
            },
            
            setTheme(theme) {
                AppState.currentTheme = theme;
                if (theme === 'neon') {
                    document.documentElement.removeAttribute('data-theme');
                } else {
                    document.documentElement.setAttribute('data-theme', theme);
                }
            },
            
            setLanguage(lang) {
                I18n.setLang(lang);
                
                // 更新語言按鈕
                const flags = { 'zh-TW': '🇹🇼', 'zh-CN': '🇨🇳', 'en': '🇺🇸', 'ja': '🇯🇵' };
                const names = { 'zh-TW': '繁體中文', 'zh-CN': '简体中文', 'en': 'English', 'ja': '日本語' };
                
                document.getElementById('langFlag').textContent = flags[lang];
                document.getElementById('langName').textContent = names[lang];
                
                // 更新選項狀態
                document.querySelectorAll('.lang-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.lang === lang);
                });
                
                // 重新載入語音
                TTSEngine.loadVoices();
            },
            
            async generate() {
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    Toast.warning(I18n.t('error.noApiKey'));
                    return;
                }
                
                // 修正檢查邏輯：圖片模式下也算有檔案
                if (!AppState.fileContent && !FileProcessor.isImageMode) {
                    Toast.warning(I18n.t('error.noFile'));
                    return;
                }
                
                AppState.apiKey = apiKey;
                
                Loading.show(I18n.t('loading.analyzing'));
                Loading.setProgress(0);
                
                try {
                    // 隱藏所有容器
                    this.hideAllContainers();
                    document.getElementById('emptyState').style.display = 'none';
                    
                    let data;
                    Loading.setProgress(30);
                    Loading.setText(I18n.t('loading.generating'));
                    
                    switch (AppState.currentFormat) {
                        case 'mindmap':
                            data = await ContentGenerator.generateMindmap(AppState.fileContent, apiKey);
                            MindmapRenderer.render(data, 'mindmapContainer');
                            document.getElementById('mindmapTools').style.display = 'flex';
                            break;
                            
                        case 'flowchart':
                            data = await ContentGenerator.generateFlowchart(AppState.fileContent, apiKey);
                            FlowchartRenderer.render(data, 'flowchartContainer');
                            document.getElementById('mindmapTools').style.display = 'none';
                            break;
                            
                        case 'infographic':
                            data = await ContentGenerator.generateInfographic(AppState.fileContent, apiKey);
                            InfographicRenderer.render(data, 'infographicContainer');
                            document.getElementById('mindmapTools').style.display = 'none';
                            break;
                            
                        case 'summary':
                            data = await ContentGenerator.generateSummary(AppState.fileContent, apiKey);
                            SummaryRenderer.render(data, 'summaryContainer');
                            document.getElementById('mindmapTools').style.display = 'none';
                            break;
                            
                        case 'timeline':
                            data = await ContentGenerator.generateTimeline(AppState.fileContent, apiKey);
                            TimelineRenderer.render(data, 'timelineContainer');
                            document.getElementById('mindmapTools').style.display = 'none';
                            break;
                            
                        case 'fishbone':
                            data = await ContentGenerator.generateFishbone(AppState.fileContent, apiKey);
                            FishboneRenderer.render(data, 'fishboneContainer');
                            document.getElementById('mindmapTools').style.display = 'none';
                            break;
                            
                        case 'radar':
                            data = await ContentGenerator.generateRadar(AppState.fileContent, apiKey);
                            RadarRenderer.render(data, 'radarContainer');
                            document.getElementById('mindmapTools').style.display = 'none';
                            break;
                            
                        case 'swot':
                            data = await ContentGenerator.generateSWOT(AppState.fileContent, apiKey);
                            SWOTRenderer.render(data, 'swotContainer');
                            document.getElementById('mindmapTools').style.display = 'none';
                            break;
                    }
                    
                    AppState.generatedData = data;
                    Loading.setProgress(100);
                    
                    // 更新工具列資訊
                    document.getElementById('toolbarInfo').textContent = AppState.fileName;
                    
                    // 手機版關閉側邊欄
                    if (AppState.isMobile) {
                        document.getElementById('sidebar').classList.remove('show');
                        document.getElementById('sidebarBackdrop').classList.remove('show');
                    }
                    
                    Loading.hide();
                    Toast.success('生成完成！');
                    
                } catch (error) {
                    Loading.hide();
                    Toast.error(I18n.t('error.generation') + ': ' + error.message);
                    console.error('Generation error:', error);
                }
            },
            
            hideAllContainers() {
                ['mindmapContainer', 'flowchartContainer', 'infographicContainer', 
                 'summaryContainer', 'timelineContainer', 'fishboneContainer', 'radarContainer', 'swotContainer']
                    .forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.style.display = 'none';
                    });
            },
            
            showLayoutModal() {
                const modal = document.getElementById('modal');
                const backdrop = document.getElementById('modalBackdrop');
                
                document.getElementById('modalTitle').textContent = I18n.t('toolbar.layout');
                
                let html = '<div class="btn-group" style="flex-wrap: wrap;">';
                for (const [key, layout] of Object.entries(MindmapRenderer.layouts)) {
                    const isActive = MindmapRenderer.currentLayout === key ? 'active' : '';
                    html += `<button class="btn btn-toggle ${isActive}" data-layout="${key}">${layout.icon} ${layout.name}</button>`;
                }
                html += '</div>';
                
                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('modalFooter').innerHTML = `
                    <button class="btn btn-secondary" id="modalCancel">${I18n.t('presentation.exit')}</button>
                `;
                
                backdrop.classList.add('show');
                
                // 綁定事件
                document.querySelectorAll('[data-layout]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('[data-layout]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        MindmapRenderer.setLayout(btn.dataset.layout);
                    });
                });
                
                document.getElementById('modalCancel').addEventListener('click', () => {
                    backdrop.classList.remove('show');
                });
                
                document.getElementById('modalClose').addEventListener('click', () => {
                    backdrop.classList.remove('show');
                });
            },
            
            async generateScript() {
                if (!AppState.generatedData || !AppState.apiKey) {
                    Toast.warning('請先生成視覺摘要');
                    return;
                }
                
                Loading.show('生成講稿中...');
                
                try {
                    const script = await ContentGenerator.generateScript(
                        AppState.fileContent,
                        AppState.generatedData,
                        AppState.currentFormat,
                        AppState.apiKey
                    );
                    
                    const container = document.getElementById('scriptContent');
                    container.innerHTML = '';
                    
                    script.slides?.forEach((slide, i) => {
                        const div = document.createElement('div');
                        div.className = 'script-slide';
                        div.innerHTML = `
                            <div class="script-slide-title">
                                <span class="script-slide-number">${i + 1}</span>
                                ${Utils.escapeHtml(slide.title)}
                            </div>
                            <div class="script-slide-text">${Utils.escapeHtml(slide.script)}</div>
                        `;
                        container.appendChild(div);
                    });
                    
                    Loading.hide();
                    Toast.success('講稿生成完成！');
                    
                } catch (error) {
                    Loading.hide();
                    Toast.error('講稿生成失敗: ' + error.message);
                }
            },
            
            async sendQuestion() {
                const input = document.getElementById('qaInput');
                const question = input.value.trim();
                
                if (!question) return;
                if (!AppState.fileContent) {
                    Toast.warning(I18n.t('error.noFile'));
                    return;
                }
                if (!AppState.apiKey) {
                    Toast.warning(I18n.t('error.noApiKey'));
                    return;
                }
                
                const messagesContainer = document.getElementById('qaMessages');
                
                // 顯示用戶訊息
                const userMsg = document.createElement('div');
                userMsg.className = 'qa-message user';
                userMsg.innerHTML = `
                    <div class="qa-avatar">👤</div>
                    <div class="qa-bubble">${Utils.escapeHtml(question)}</div>
                `;
                messagesContainer.appendChild(userMsg);
                
                input.value = '';
                input.disabled = true;
                document.getElementById('qaSend').disabled = true;
                
                try {
                    const answer = await ContentGenerator.askQuestion(question, AppState.fileContent, AppState.apiKey);
                    
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'qa-message assistant';
                    aiMsg.innerHTML = `
                        <div class="qa-avatar">🤖</div>
                        <div class="qa-bubble">${Utils.escapeHtml(answer)}</div>
                    `;
                    messagesContainer.appendChild(aiMsg);
                    
                    // 滾動到底部
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                } catch (error) {
                    Toast.error('回答失敗: ' + error.message);
                }
                
                input.disabled = false;
                document.getElementById('qaSend').disabled = false;
                input.focus();
            }
        };

        // 啟動應用程式
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
